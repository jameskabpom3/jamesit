<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการรายรับ-รายจ่าย</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            touch-action: pan-y;
        }
        
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .fa-beat {
            animation: fa-beat 1.5s ease-out infinite;
        }
        @keyframes fa-beat {
            0%, 100% { transform: scale(1); }
            5%, 15% { transform: scale(0.9); }
            10%, 20% { transform: scale(1.1); }
        }
        
        .balance-negative { color: #ef4444; }
        .balance-positive { color: #22c55e; }
        .balance-zero { color: #6b7280; }
        
        .compact-account-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            height: 100%;
            min-height: 100px;
        }
        
        /* TRANSITION CSS */
        .page-container {
            overflow-x: hidden;
            position: relative;
        }
        .app-page {
            width: 100%;
            min-height: 50vh;
        }
        .page-transition-enter.slide-left { transform: translateX(100%); }
        .page-transition-enter.slide-right { transform: translateX(-100%); }
        .page-transition-enter {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            will-change: transform, opacity;
        }
        .page-transition-enter-active {
            transform: translateX(0) !important;
            opacity: 1 !important;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .page-transition-exit-active {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            will-change: transform, opacity;
            transition: transform 0.2s ease-in, opacity 0.2s ease-in;
            z-index: 10;
        }
        .page-transition-exit-final.slide-left { transform: translateX(-100%) !important; }
        .page-transition-exit-final.slide-right { transform: translateX(100%) !important; }
		.fc-scroller {
        overflow-y: hidden !important;
		}
		
		/* Ensure the calendar container can expand as needed (optional, but good practice) */
		#calendar-container .fc { 
			height: auto !important; 
		}
        
        /* === NEW: DARK MODE STYLES === */
        body.dark {
            background-color: #000000; /* Black for OLED/AMOLED */
            color: #e5e7eb; /* Light gray text */
        }
        body.dark .bg-gray-100 {
            background-color: #000000 !important;
        }
        body.dark .bg-white, 
        body.dark .bg-gray-50 {
            background-color: #1a1a1a !important; /* Darker gray for cards/inputs */
            color: #e5e7eb;
        }
        body.dark .shadow-md,
        body.dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.05), 0 2px 4px -2px rgba(255, 255, 255, 0.05); /* Light shadow for contrast */
        }
        body.dark .text-gray-700,
        body.dark .text-gray-800,
        body.dark .text-gray-900 {
            color: #e5e7eb !important;
        }
        body.dark .text-gray-600 {
            color: #9ca3af !important; /* Slightly darker light text */
        }
        body.dark .text-gray-500 {
            color: #6b7280 !important;
        }
        body.dark .border-gray-100,
        body.dark .border-gray-200 {
            border-color: #374151 !important;
        }
        body.dark .hover\:bg-gray-50:hover {
            background-color: #374151 !important;
        }
        body.dark .form-input,
        body.dark .form-select,
        body.dark .form-textarea {
            background-color: #1a1a1a !important;
            border-color: #374151 !important;
            color: #e5e7eb;
        }
        body.dark .form-input:focus, body.dark .form-select:focus, body.dark .form-textarea:focus {
            box-shadow: 0 0 0 0.2rem rgba(167, 139, 250, 0.5);
        }
        /* Special colors for contrast and readability */
        body.dark .bg-green-100 { background-color: #102e21 !important; }
        body.dark .text-green-800 { color: #34d399 !important; }
        body.dark .text-green-700 { color: #10b981 !important; }
        
        body.dark .bg-red-100 { background-color: #36171d !important; }
        body.dark .text-red-800 { color: #f87171 !important; }
        body.dark .text-red-700 { color: #ef4444 !important; }
        
        body.dark .bg-blue-100 { background-color: #162438 !important; }
        body.dark .text-blue-800 { color: #60a5fa !important; }
        
        body.dark .bg-purple-100 { background-color: #2a1f49 !important; }
        body.dark .text-purple-600 { color: #a78bfa !important; }
        body.dark .text-purple-700 { color: #c4b5fd !important; }
        body.dark .text-purple-800 { color: #d8b4fe !important; }
        
        body.dark .bg-gray-200 { background-color: #374151 !important; }
        body.dark .hover\:bg-purple-100:hover { background-color: #4c377a !important; }
        body.dark .bg-purple-50 { background-color: #2a1f49 !important; }
        body.dark .border-purple-100 { border-color: #4c377a !important; }
        
        body.dark .balance-zero { color: #9ca3af !important; } 

        /* FullCalendar Dark Mode */
        body.dark .fc {
            --fc-bg-event-color: #4c377a; /* Event background */
            --fc-event-border-color: #a78bfa; /* Event border */
            --fc-event-text-color: #e5e7eb; /* Event text */
            --fc-today-bg-color: #1f2937; /* Today's cell background */
            --fc-border-color: #374151; /* Border */
            --fc-list-event-hover-bg: #1f2937;
        }

        body.dark .fc .fc-toolbar-title,
        body.dark .fc-daygrid-body {
            color: #e5e7eb !important;
        }
        body.dark .fc-col-header-cell,
        body.dark .fc-daygrid-week-number,
        body.dark .fc-daygrid-day-number {
            background-color: #1a1a1a !important;
            border-color: #374151 !important;
            color: #e5e7eb !important;
        }
        body.dark .fc-daygrid-day {
            background-color: #1a1a1a !important;
        }
        body.dark .fc-day-other .fc-daygrid-day-number {
            color: #6b7280 !important;
        }
        body.dark .fc-button {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #e5e7eb !important;
        }
        body.dark .fc-button:hover {
            background-color: #4b5563 !important;
        }
        body.dark .hover\:bg-purple-50:hover {
            background-color: #374151 !important;
        }

        /* === NEW: SweetAlert2 Dark Mode Styles === */
        /* Target the main popup */
        body.dark .swal2-popup {
            background-color: #1a1a1a !important; 
            border: 1px solid #374151;
        }

        /* Target the title and main text */
        body.dark .swal2-title,
        body.dark .swal2-html-container {
            color: #e5e7eb !important;
        }

        /* Target the confirm/cancel buttons */
        body.dark .swal2-actions button {
            font-family: 'Prompt', sans-serif !important;
        }
        body.dark .swal2-confirm {
            background-color: #a78bfa !important; /* Purple Light */
            color: #1a1a1a !important;
        }
        body.dark .swal2-confirm:hover {
            background-color: #c4b5fd !important; /* Purple Lighter */
        }
        body.dark .swal2-cancel {
            background-color: #374151 !important; /* Gray Dark */
            color: #e5e7eb !important;
        }
        body.dark .swal2-cancel:hover {
            background-color: #4b5563 !important; /* Gray Darker */
        }

        /* Target the input fields */
        body.dark .swal2-input,
        body.dark .swal2-textarea {
            background-color: #000000 !important;
            border-color: #374151 !important;
            color: #e5e7eb !important;
        }

        /* Target the close button */
        body.dark .swal2-close {
            color: #9ca3af !important;
        }

        /* Target the toast notification (small popups) */
        body.dark .swal2-toast {
            background-color: #1a1a1a !important;
            border: 1px solid #374151;
        }
        body.dark .swal2-toast .swal2-title {
            color: #e5e7eb !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-700">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div id="app-lock-screen" class="fixed inset-0 bg-gradient-to-br from-purple-900 to-indigo-900 z-[60] flex flex-col items-center justify-center p-4 hidden">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center transform transition-all scale-100">
                <div class="mb-6">
                    <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-lock text-4xl text-purple-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">กรุณาใส่รหัสผ่าน</h2>
                    <p class="text-gray-500 mt-2">เพื่อเข้าใช้งานระบบจัดการรายรับ-รายจ่าย</p>
                </div>
                
                <form id="unlock-form" class="space-y-4">
                    <div class="relative">
                        <input type="password" id="unlock-password" placeholder="รหัสผ่าน" class="w-full text-center text-2xl tracking-widest py-3 px-4 bg-gray-50 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 outline-none transition-all" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-300 text-lg flex items-center justify-center gap-2">
                        <i class="fa-solid fa-door-open"></i> เข้าสู่ระบบ
                    </button>
                </form>
                <p class="mt-6 text-xs text-gray-400">© 2025 Finance Manager Pro</p>
            </div>
        </div>

        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="text-xl font-bold text-purple-600">
                <i class="fa-solid fa-wallet mr-2"></i>
                <span>ระบบจัดการรายรับ-รายจ่าย</span>
            </div>

            <div class="md:hidden flex items-center gap-2">
                <button id="mobile-home-button" class="text-purple-600 hover:text-purple-800 p-2 rounded-lg">
                    <i class="fa-solid fa-house text-2xl"></i> 
                </button>
                <button id="mobile-menu-button" class="text-purple-600 hover:text-purple-800 p-2 rounded-lg">
                    <i id="mobile-menu-icon" class="fa-solid fa-bars text-2xl"></i>
                </button>
            </div>

            <div id="desktop-menu" class="hidden md:flex md:items-center md:gap-2">
                <button id="nav-home" class="text-purple-600 hover:text-purple-800 font-medium px-4 py-3 rounded-lg text-lg"><i class="fa-solid fa-house mr-1"></i> หน้าแรก</button>
                <button id="nav-list" class="text-gray-600 hover:text-purple-800 font-medium px-4 py-3 rounded-lg text-lg"><i class="fa-solid fa-list-ul mr-1"></i> รายการ</button>
                <button id="nav-calendar" class="text-gray-600 hover:text-purple-800 font-medium px-4 py-3 rounded-lg text-lg"><i class="fa-solid fa-calendar-days mr-1"></i> ปฏิทิน</button>
                <button id="nav-settings" class="text-gray-600 hover:text-purple-800 font-medium px-4 py-3 rounded-lg text-lg"><i class="fa-solid fa-gear mr-1"></i> ตั้งค่า</button>
                <button id="nav-guide" class="text-gray-600 hover:text-purple-800 font-medium px-4 py-3 rounded-lg text-lg"><i class="fa-solid fa-book mr-1"></i> คู่มือการใช้งาน</button>
            </div>
        </div>

        <div id="mobile-menu" class="md:hidden hidden bg-white shadow-lg">
            <button id="nav-home-mobile" class="block w-full text-left text-purple-600 hover:bg-purple-100 font-medium px-6 py-4 text-lg border-b border-gray-100"><i class="fa-solid fa-house mr-2"></i> หน้าแรก</button>
            <button id="nav-list-mobile" class="block w-full text-left text-gray-600 hover:bg-purple-100 font-medium px-6 py-4 text-lg border-b border-gray-100"><i class="fa-solid fa-list-ul mr-2"></i> รายการ</button>
            <button id="nav-calendar-mobile" class="block w-full text-left text-gray-600 hover:bg-purple-100 font-medium px-6 py-4 text-lg border-b border-gray-100"><i class="fa-solid fa-calendar-days mr-2"></i> ปฏิทิน</button>
            <button id="nav-settings-mobile" class="block w-full text-left text-gray-600 hover:bg-purple-100 font-medium px-6 py-4 text-lg border-b border-gray-100"><i class="fa-solid fa-gear mr-2"></i> ตั้งค่า</button>
            <button id="nav-guide-mobile" class="block w-full text-left text-gray-600 hover:bg-purple-100 font-medium px-6 py-4 text-lg"><i class="fa-solid fa-book mr-2"></i> คู่มือการใช้งาน</button>
        </div>
    </nav>


    <div id="main-content" class="container mx-auto p-4 md:p-6">
        <header id="shared-controls-header" class="flex flex-col md:flex-row justify-end items-center mb-6 gap-4" style="display: none;">
            <div class="flex flex-wrap justify-center md:justify-end items-center gap-3 bg-white p-4 rounded-xl shadow-lg">
                <select id="view-mode-select" class="form-select text-lg text-gray-700 bg-gray-50 border-0 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    <option value="all">ดูทั้งหมด</option>
                    <option value="month">ดูรายเดือน</option>
                    <option value="year">ดูรายปี</option>
                </select>
                <div id="month-controls" class="flex items-center gap-1">
                    <button id="month-prev" class="px-4 py-3 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-left"></i></button>
                    <input type="month" id="month-picker" class="form-input text-lg text-gray-700 bg-gray-50 border-0 rounded-lg focus:ring-purple-500 focus:border-purple-500 w-auto">
                    <button id="month-next" class="px-4 py-3 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div id="year-controls" class="flex items-center gap-1 hidden">
                    <button id="year-prev" class="px-4 py-3 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-left"></i></button>
                    <input type="number" id="year-picker" class="form-input text-lg text-gray-700 bg-gray-50 border-0 rounded-lg focus:ring-purple-500 focus:border-purple-500 w-28 text-center" placeholder="YYYY">
                    <button id="year-next" class="px-4 py-3 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>
        </header>
        
        <div id="page-wrapper" class="page-container">
            <div id="page-home" class="app-page">
                <div id="summary-cards-container" class="grid grid-cols-3 gap-2 md:gap-6 mb-6">
                    <div id="summary-income-card" class="bg-green-100 p-3 md:p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition duration-200">
                        <h2 class="text-sm md:text-lg font-semibold text-green-800 mb-1 md:mb-2">รายรับ</h2>
                        <p id="total-income" class="text-base md:text-2xl font-bold text-green-700">฿0.00</p>
                    </div>
                    <div id="summary-expense-card" class="bg-red-100 p-3 md:p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition duration-200">
                        <h2 class="text-sm md:text-lg font-semibold text-red-800 mb-1 md:mb-2">รายจ่าย</h2>
                        <p id="total-expense" class="text-base md:text-2xl font-bold text-red-700">฿0.00</p>
                    </div>
                    <div id="summary-balance-card" class="bg-blue-100 p-3 md:p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition duration-200">
                        <h2 class="text-sm md:text-lg font-semibold text-blue-800 mb-1 md:mb-2">คงเหลือ(เงินสด/ออมทรัพย์)</h2>
                        <p id="total-balance" class="text-base md:text-2xl font-bold text-blue-800">฿0.00</p>
                    </div>
                </div>

                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex justify-between items-center cursor-pointer settings-toggle-header" data-target="home-accounts-content">
                        <h2 class="text-xl font-bold text-purple-600">สรุปบัญชีทั้งหมด</h2>
                        <i class="fa-solid fa-chevron-down text-green-500 transition-transform duration-300 rotate-180"></i>
                    </div>

                    <div id="home-accounts-content" class="mt-4 transition-all">
                        <div id="all-accounts-summary" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4">
                            <p class="text-gray-500">กำลังโหลดบัญชี...</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-6">
                    <div class="lg:col-span-1 bg-white p-3 md:p-6 rounded-xl shadow-lg flex flex-col justify-center lg:order-1">
                        <h2 class="text-lg md:text-xl font-bold text-purple-600 mb-2 md:mb-4">เพิ่มรายการ</h2>
                        <p class="text-base md:text-lg text-gray-700 mb-4 md:mb-6">ระบบจะจำราคาและหมวดหมู่ให้อัตโนมัติ</p>
                        <button id="add-tx-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 md:py-3 px-4 rounded-xl shadow-lg transition duration-300 text-base md:text-lg">
                            <i class="fa-solid fa-plus mr-2"></i> เพิ่มธุรกรรมใหม่
                        </button>
                        <button id="voice-add-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 md:py-3 px-4 rounded-xl shadow-lg transition duration-300 text-base md:text-lg mt-3 md:mt-4">
                            <i class="fa-solid fa-microphone mr-2"></i> เพิ่มด้วยเสียง
                        </button>
                    </div>
                    
                    <div class="lg:col-span-2 bg-white p-3 md:p-6 rounded-xl shadow-lg lg:order-2">
                        <h2 class="text-lg md:text-xl font-bold text-purple-600 mb-2 md:mb-4">สรุปภาพรวม</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 items-center">
                            <div>
                                <h3 class="text-base md:text-lg font-semibold text-center text-gray-700 mb-2">รายรับ / รายจ่าย</h3>
                                <div class="h-48 md:h-72 relative">
                                    <canvas id="transaction-chart"></canvas>
                                    <p id="chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">ไม่มีข้อมูล</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-base md:text-lg font-semibold text-center text-gray-700 mb-2">สรุปรายจ่ายตามรายการ (Top 10)</h3>
                                <div class="h-48 md:h-72 relative">
                                    <canvas id="expense-category-chart"></canvas>
                                    <p id="expense-chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">ไม่มีข้อมูลรายจ่าย</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="home-transaction-list-container" class="bg-white p-5 md:p-6 rounded-xl shadow-lg mt-6"> 
                    <div class="flex justify-between items-center cursor-pointer settings-toggle-header" data-target="home-transactions-content">
                        <h2 class="text-xl font-bold text-purple-600">รายการธุรกรรมล่าสุด</h2>
                        <i class="fa-solid fa-chevron-down text-green-500 transition-transform duration-300 text-xl"></i>
                    </div>

                    <div id="home-transactions-content" class="mt-4 transition-all">
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="flex-shrink-0">
                                <select id="home-items-per-page-select" class="form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500 py-3 px-4 h-full">
                                    <option value="10">แสดง 10</option>
                                    <option value="20">แสดง 20</option>
                                    <option value="50">แสดง 50</option>
                                </select>
                            </div>
                            <div class="flex-shrink-0 flex gap-2 justify-center md:justify-start" id="home-filter-buttons">
                                <button class="home-filter-btn bg-purple-500 text-white px-5 py-3 text-base rounded-xl" data-filter="all">ทั้งหมด</button>
                                <button class="home-filter-btn bg-gray-200 text-gray-700 px-5 py-3 text-base rounded-xl" data-filter="income">รายรับ</button>
                                <button class="home-filter-btn bg-gray-200 text-gray-700 px-5 py-3 text-base rounded-xl" data-filter="expense">รายจ่าย</button>
                                <button class="home-filter-btn bg-gray-200 text-gray-700 px-5 py-3 text-base rounded-xl" data-filter="transfer">โอนย้าย</button>
                            </div>
                        </div>
                        <div id="home-table-placeholder" class="overflow-x-auto"></div>
                        <div id="home-pagination-controls" class="flex justify-center items-center gap-2 mt-4"></div>
                    </div>
                </div>
            </div> 
        
            <div id="page-list" class="app-page hidden">
                <div id="transaction-list-container" class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                    <div class="mb-6 border-b pb-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                            <h3 id="list-chart-title" class="text-xl font-bold text-purple-600">สรุปข้อมูล</h3>
                            <select id="list-chart-selector" class="form-select text-base text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500 py-2 px-4">
                                <option value="items" selected>แยกตามชื่อรายการ (Top 15)</option>
                                <option value="summary">เปรียบเทียบ รายรับ vs รายจ่าย (ยอดรวม)</option>
                                <option value="accounts">ยอดเงินคงเหลือแต่ละบัญชี</option>
                                <option value="trend_month">แนวโน้ม: รายรับ-รายจ่าย รายเดือน</option>
                                <option value="trend_year">แนวโน้ม: รายรับ-รายจ่าย รายปี</option>
                            </select>
                        </div>
                        <div class="h-80 md:h-96 relative">
                            <canvas id="list-page-bar-chart"></canvas>
                            <p id="list-chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">ไม่มีข้อมูลสำหรับแสดงผล</p>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-purple-600 mb-4">รายการธุรกรรม</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="relative flex-grow">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                <i class="fa-solid fa-search text-gray-400"></i>
                            </span>
                            <input type="text" id="search-input" placeholder="ค้นหา ( ชื่อ, หมวดหมู่, บัญชี, จำนวนเงิน, วันเดือนปี )..." class="w-full pl-10 pr-4 py-3 px-4 text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500"> 
                        </div>
                        <div class="flex-shrink-0">
                            <select id="list-group-by-select" class="form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500 py-3 px-4 h-full">
                                <option value="none">ไม่จัดกลุ่ม</option>
                                <option value="day">จัดกลุ่มรายวัน</option>
                                <option option value="month">จัดกลุ่มรายเดือน</option>
                            </select>
                        </div>
                        <div class="flex-shrink-0">
                        <select id="items-per-page-select" class="form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500 py-3 px-4 h-full">
                                <option value="10">แสดง 10</option>
                                <option value="20">แสดง 20</option>
                                <option value="50">แสดง 50</option>
                            </select>
                        </div>
                        <div class="flex-shrink-0 flex gap-2 justify-center" id="list-filter-buttons">
                        <button class="filter-btn bg-purple-500 text-white px-5 py-3 text-base rounded-xl" data-filter="all">ทั้งหมด</button>
                            <button class="filter-btn bg-gray-200 text-gray-700 px-5 py-3 text-base rounded-xl" data-filter="income">รายรับ</button>
                            <button class="filter-btn bg-gray-200 text-gray-700 px-5 py-3 text-base rounded-xl" data-filter="expense">รายจ่าย</button>
                            <button class="filter-btn bg-gray-200 text-gray-700 px-5 py-3 text-base rounded-xl" data-filter="transfer">โอนย้าย</button>
                        </div>
                    </div>
                    <div id="list-table-placeholder" class="overflow-x-auto"></div>
                    <div id="list-pagination-controls" class="flex justify-center items-center gap-2 mt-4"></div>
                </div>
            </div> 
            
            <div id="page-calendar" class="app-page hidden">
                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                    <h1 class="text-xl md:text-2xl font-bold text-purple-600 mb-6">ปฏิทินรายรับ-รายจ่าย</h1>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <p class="text-lg text-gray-600">คลิกที่วันที่มียอดรวม เพื่อดูรายละเอียด</p>
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl shadow-sm border border-gray-200">
                            <button id="cal-prev-btn" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white border border-gray-200 text-gray-600 hover:bg-purple-100 hover:text-purple-600 hover:border-purple-300 transition-colors shadow-sm">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <div class="flex items-center">
                                <label for="cal-year-input" class="mr-2 text-gray-700 font-medium">ปี:</label>
                                <input type="number" id="cal-year-input" class="form-input w-24 text-center text-lg font-bold text-purple-700 bg-white border border-gray-200 rounded-lg focus:ring-purple-500 focus:border-purple-500 py-1" placeholder="YYYY">
                            </div>
                            <button id="cal-next-btn" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white border border-gray-200 text-gray-600 hover:bg-purple-100 hover:text-purple-600 hover:border-purple-300 transition-colors shadow-sm">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div id="calendar-container"></div>
                </div>
            </div>

            <div id="page-settings" class="app-page hidden">
                <h1 class="text-xl font-bold text-purple-600 mb-6">ตั้งค่า</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center cursor-pointer settings-toggle-header" data-target="settings-accounts-content">
                                <h2 class="text-xl font-bold text-purple-600">จัดการบัญชี</h2>
                                <i class="fa-solid fa-chevron-down text-green-500 transition-transform duration-300 rotate-180"></i>
                            </div>
                            
                            <div id="settings-accounts-content" class="mt-4 transition-all">
                                <form id="form-add-account" class="space-y-3 mb-4 p-4 bg-gray-50 rounded-lg">
                                    <h3 class="text-lg font-semibold text-purple-700">เพิ่มบัญชีใหม่</h3>
                                    <div>
                                        <label for="input-account-name" class="block text-sm font-medium text-gray-700">ชื่อบัญชี</label>
                                        <input type="text" id="input-account-name" placeholder="เช่น เงินเดือน, บัตร KBank" class="mt-1 flex-grow form-input text-lg py-3 px-4 text-gray-700 bg-white border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500 w-full" required>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="select-account-type" class="block text-sm font-medium text-gray-700">ประเภทบัญชี</label>
                                            <select id="select-account-type" class="mt-1 w-full form-select text-lg text-gray-700 bg-white border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required>
                                                <option value="cash">เงินสด/ออมทรัพย์/วอลเล็ท</option>
                                                <option value="credit">บัตรเครดิต</option>
                                                <option value="liability">บัญชีหนี้สิน</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label for="input-account-balance" class="block text-sm font-medium text-gray-700">ยอดเริ่มต้น</label>
                                            <div class="relative mt-1">
                                                <input type="text" id="input-account-balance" inputmode="decimal" placeholder="0.00 หรือ 50+20" value="0" class="flex-grow form-input text-lg py-3 px-4 text-gray-700 bg-white border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500 w-full pr-12" required>
                                                <button type="button" id="toggle-account-calc-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-purple-600 hover:text-purple-800 p-1 rounded-lg">
                                                    <i class="fa-solid fa-calculator text-xl"></i>
                                                </button>
                                                <div id="account-calculator-popover" class="absolute z-20 w-full max-w-xs bg-gray-50 shadow-lg rounded-xl p-3 mt-1 right-0 hidden border border-gray-200">
                                                    <div id="acc-calc-preview" class="text-right text-purple-600 font-bold text-xl h-6 mb-2 pr-1"> </div>
                                                    <div id="account-calculator-grid" class="grid grid-cols-4 gap-1">
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="7">7</button> <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="8">8</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="9">9</button>
                                                        <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="/">/</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="4">4</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="5">5</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="6">6</button>
                                                        <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="*">*</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="1">1</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="2">2</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="3">3</button>
                                                        <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="-">-</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="0">0</button>
                                                        <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value=".">.</button>
                                                        <button type="button" class="calc-btn bg-red-200 hover:bg-red-300 text-red-800 py-1 rounded-lg font-semibold text-base" data-value="C">C</button>
                                                        <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="+">+</button>
                                                        <button type="button" class="calc-btn col-span-4 bg-purple-600 hover:bg-purple-700 text-white py-1 rounded-lg font-semibold text-base" data-value="=">=</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-xl font-medium text-lg"><i class="fa-solid fa-plus mr-2"></i>เพิ่มบัญชี</button>
                                </form>
                                <ul id="list-accounts" class="space-y-2"></ul>
                            </div>
                        </div>

                        <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center cursor-pointer settings-toggle-header" data-target="settings-income-content">
                                <h2 class="text-xl font-bold text-purple-600">หมวดหมู่รายรับ</h2>
                                <i class="fa-solid fa-chevron-down text-green-500 transition-transform duration-300 rotate-180"></i>
                            </div>
                            <div id="settings-income-content" class="mt-4 transition-all">
                                <form id="form-add-income-cat" class="flex gap-2 mb-3">
                                    <input type="text" id="input-income-cat" placeholder="เพิ่มหมวดหมู่รายรับ" class="flex-grow form-input text-lg py-3 px-4 text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500"> 
                                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-medium text-lg"><i class="fa-solid fa-plus"></i></button> 
                                </form>
                                <ul id="list-income-cat" class="space-y-2"></ul>
                            </div>
                        </div>

                        <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center cursor-pointer settings-toggle-header" data-target="settings-expense-content">
                                <h2 class="text-xl font-bold text-purple-600">หมวดหมู่รายจ่าย</h2>
                                <i class="fa-solid fa-chevron-down text-green-500 transition-transform duration-300 rotate-180"></i>
                            </div>
                            <div id="settings-expense-content" class="mt-4 transition-all">
                                <form id="form-add-expense-cat" class="flex gap-2 mb-3">
                                    <input type="text" id="input-expense-cat" placeholder="เพิ่มหมวดหมู่รายจ่าย" class="flex-grow form-input text-lg py-3 px-4 text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500"> 
                                    <button type="submit" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium text-lg"><i class="fa-solid fa-plus"></i></button> 
                                </form>
                                <ul id="list-expense-cat" class="space-y-2"></ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center cursor-pointer settings-toggle-header" data-target="settings-manual-content">
                                <h2 class="text-xl font-bold text-purple-600">รายการที่บันทึกไว้ (Manual)</h2>
                                <i class="fa-solid fa-chevron-down text-green-500 transition-transform duration-300 rotate-180"></i>
                            </div>
                            <div id="settings-manual-content" class="mt-4 transition-all">
                                <form id="form-add-frequent-item" class="flex gap-2 mb-3">
                                    <input type="text" id="input-frequent-item" placeholder="เพิ่มชื่อรายการ" class="flex-grow form-input text-lg py-3 px-4 text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500"> 
                                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl font-medium text-lg"><i class="fa-solid fa-plus"></i></button> 
                                </form>
                                <ul id="list-frequent-item" class="space-y-2"></ul>
                                <p class="text-sm text-gray-500 mt-2">* ระบบ Auto-Learn จะทำงานแยกต่างหากและไม่แสดงในหน้านี้</p>
                            </div>
                        </div>
                        
                        <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mt-0">
                            <h2 class="text-xl font-bold text-purple-600 mb-4">ตั้งค่าทั่วไป</h2>
                            
                            <div class="mb-5 border-b pb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                                            <i class="fa-solid fa-user-lock"></i>
                                        </div>
                                        <span class="text-lg text-gray-700 font-medium">ตั้งค่า Auto Lock</span>
                                    </div>
                                    
                                    <select id="auto-lock-select" class="form-select text-base text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500 py-2 px-3">
                                        <option value="0">ปิด</option>
										<option value="1">1 นาที</option>
                                        <option value="5">5 นาที</option>
                                        <option value="10">10 นาที</option>
                                        <option value="30">30 นาที</option>
                                        <option value="60">60 นาที</option>
                                    </select>
                                </div>
                                <p class="text-sm text-gray-500 mt-2 ml-14">ล็อกหน้าจออัตโนมัติเมื่อไม่มีกิจกรรม (ใช้ได้เมื่อตั้งรหัสผ่าน)</p>
                            </div>

                            <div class="mb-5 border-b pb-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
                                            <i class="fa-solid fa-moon"></i>
                                        </div>
                                        <span class="text-lg text-gray-700 font-medium">Dark Mode</span>
                                    </div>
                                    
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggle-dark-mode" class="sr-only peer">
                                        <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-2 ml-14">เปลี่ยนธีมเป็นสีดำสนิทเพื่อถนอมสายตา</p>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                        <i class="fa-solid fa-eye"></i>
                                    </div>
                                    <span class="text-lg text-gray-700 font-medium">แสดงยอดคงเหลือรวม (หน้าแรก)</span>
                                </div>
                                
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle-show-balance" class="sr-only peer">
                                    <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            <p class="text-sm text-gray-500 mt-2 ml-14">หากปิด ยอดคงเหลือสุทธิจะถูกซ่อนจากหน้าแรก</p>
                        </div>
                        
                        <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-bold text-purple-600 mb-4">จัดการข้อมูล</h2>
                            <button id="btn-manage-password" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition duration-300 mb-4 text-lg"> <i class="fa-solid fa-key mr-2"></i> จัดการรหัสผ่าน
                            </button>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <button id="btn-undo" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-lg"> <i class="fa-solid fa-rotate-left mr-2"></i> ย้อนกลับ
                            </button>
                            <button id="btn-redo" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-lg"> <i class="fa-solid fa-rotate-right mr-2"></i> ทำซ้ำ
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <button id="btn-backup" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition duration-300 text-lg"> <i class="fa-solid fa-upload mr-2"></i> สำรองข้อมูล
                            </button>
                                <button id="btn-import" class="bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition duration-300 text-lg"> <i class="fa-solid fa-download mr-2"></i> นำเข้าข้อมูล
                                </button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                                <button id="btn-export-csv" class="col-span-2 bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition duration-300 text-lg"> 
                                    <i class="fa-solid fa-file-csv mr-2"></i> ส่งออกเป็น CSV (Excel)
                                </button>
                                <button id="btn-clear-all" class="col-span-2 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-xl shadow-lg transition duration-300 text-lg"> <i class="fa-solid fa-trash-alt mr-2"></i> รีเซ็ตและล้างข้อมูลทั้งหมด
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div id="page-guide" class="app-page hidden">
                <h1 class="text-3xl font-bold text-purple-600 mb-6">คู่มือการใช้งาน (ฉบับสมบูรณ์)</h1>
                
                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6 border-l-4 border-purple-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-rocket text-purple-600 mr-3"></i> 1. เริ่มต้นใช้งาน & หน้าแรก
                    </h2>
                    <div class="space-y-3 text-gray-600 text-lg">
                        <p>หน้าแรกคือแผงควบคุมหลักของคุณ ประกอบด้วย:</p>
                        <ul class="list-disc list-inside ml-2 space-y-2">
                            <li><b>การ์ดสรุปยอด:</b> แสดงรายรับ, รายจ่าย และ <span class="text-blue-600 font-bold">ยอดคงเหลือสุทธิ</span> (คำนวณจากเงินสด + เงินในบัญชีทั้งหมด)</li>
                            <li><b>กราฟวงกลม:</b> เปรียบเทียบสัดส่วนรายรับ vs รายจ่าย</li>
                            <li><b>Top 10 รายจ่าย:</b> แสดงให้เห็นว่าคุณหมดเงินไปกับอะไรมากที่สุด</li>
                            <li class="text-purple-700 bg-purple-50 p-2 rounded-lg border border-purple-100"><i class="fa-solid fa-star mr-2"></i><b>ใหม่! การเปลี่ยนมุมมอง:</b> ที่มุมขวาบน คุณสามารถเปลี่ยนโหมดเป็น "รายเดือน", "รายปี" หรือ "ดูทั้งหมด" เพื่อดูภาพรวมข้อมูลในช่วงเวลาต่างๆ ได้</li>
                            <li class="text-purple-700 bg-purple-50 p-2 rounded-lg border border-purple-100"><i class="fa-solid fa-eye-slash mr-2"></i><b>ใหม่! ซ่อนยอดเงิน:</b> หากต้องการความเป็นส่วนตัว สามารถไปที่เมนู "ตั้งค่า" เพื่อปิดการแสดง "ยอดคงเหลือรวม" ในหน้าแรกได้</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6 border-l-4 border-green-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-circle-plus text-green-600 mr-3"></i> 2. การบันทึกรายการ (3 รูปแบบ)
                    </h2>
                    <div class="space-y-4 text-gray-600 text-lg">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <h3 class="font-bold text-green-700">🟢 รายรับ (Income)</h3>
                            <p>ใช้เมื่อได้เงินเข้ามา ทำให้ยอดเงินในบัญชีเพิ่มขึ้น</p>
                            <p class="text-sm text-gray-500 mt-1"><i>ตัวอย่าง: เงินเดือนออก, ขายของได้, ได้เงินคืน, ดอกเบี้ยธนาคาร</i></p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg">
                            <h3 class="font-bold text-red-700">🔴 รายจ่าย (Expense)</h3>
                            <p>ใช้เมื่อเสียเงินออกไป ทำให้ยอดเงินลดลง หรือหนี้เพิ่มขึ้น</p>
                            <p class="text-sm text-gray-500 mt-1"><i>ตัวอย่าง: ซื้อข้าวกะเพรา, จ่ายค่าไฟ, รูดบัตรเครดิตซื้อของ</i></p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <h3 class="font-bold text-blue-700">🔵 โอนย้าย (Transfer)</h3>
                            <p>ใช้เมื่อย้ายเงินจากที่หนึ่ง ไปอีกที่หนึ่ง (ทรัพย์สินเท่าเดิม)</p>
                            <p class="text-sm text-gray-500 mt-1"><i>ตัวอย่าง: ถอนเงินสดจากตู้ (บัญชีธนาคาร -> กระเป๋าตังค์), จ่ายหนี้บัตรเครดิต (บัญชีออมทรัพย์ -> บัตรเครดิต)</i></p>
                        </div>
                        <div class="border-t pt-3 mt-2">
                            <p class="font-bold text-gray-700"><i class="fa-solid fa-calculator mr-2"></i>ฟีเจอร์เสริมในหน้าบันทึก:</p>
                            <ul class="list-disc list-inside ml-2 mt-1 text-sm">
                                <li><b>เครื่องคิดเลขในตัว:</b> ในช่องใส่จำนวนเงิน กดปุ่มไอคอนเครื่องคิดเลขด้านขวา เพื่อคำนวณยอดเงินก่อนบันทึกได้ทันที (เช่น 50+20+10)</li>
                                <li><b>การแก้ไข/ลบ:</b> สามารถกดที่รายการในหน้าแรกหรือหน้ารายการ เพื่อแก้ไขหรือลบข้อมูลได้ (ต้องใส่รหัสผ่านหากตั้งค่าไว้)</li>
                                <li><i class="fa-solid fa-receipt mr-1 text-purple-600"></i><b>ใหม่! แนบใบเสร็จ:</b> คุณสามารถแนบรูปภาพใบเสร็จเข้ากับรายการได้ โดยจำกัดขนาดไฟล์ไม่เกิน 1 MB</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6 border-l-4 border-blue-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-wallet text-blue-600 mr-3"></i> 3. ระบบบัญชี (Accounts)
                    </h2>
                    <p class="text-gray-600 mb-3 text-lg">คุณสามารถเพิ่ม/แก้ไขบัญชีได้ที่เมนู <b>"ตั้งค่า"</b> โดยแบ่งเป็น 3 ประเภท:</p>
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <i class="fa-solid fa-money-bill text-green-500 mt-1 mr-3"></i>
                            <div>
                                <span class="font-bold text-gray-700">1.เงินสด/ออมทรัพย์</span>
                                <p class="text-gray-500 text-sm">คือเงินที่เรามีอยู่จริง ยิ่งเยอะยิ่งดี (ค่าเป็นบวก)</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i class="fa-solid fa-credit-card text-red-500 mt-1 mr-3"></i>
                            <div>
                                <span class="font-bold text-gray-700">2.บัตรเครดิต</span>
                                <p class="text-gray-500 text-sm">คือวงเงินที่ยืมเขามาใช้ก่อน (ค่าเริ่มที่ 0 และจะติดลบเมื่อใช้จ่าย)</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i class="fa-solid fa-file-invoice-dollar text-orange-500 mt-1 mr-3"></i>
                            <div>
                                <span class="font-bold text-gray-700">3.บัญชีหนี้สิน</span>
                                <p class="text-gray-500 text-sm">เช่น หนี้ กยศ., หนี้บ้าน (ค่าควรตั้งต้นเป็นติดลบตามยอดหนี้)</p>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg mt-2">
                            <h3 class="font-bold text-blue-700 text-sm mb-1"><i class="fa-solid fa-lightbulb mr-1"></i> เคล็ดลับการจัดการบัญชี:</h3>
                            <ul class="list-disc list-inside text-sm text-gray-600">
                                <li><b>ดูประวัติบัญชี:</b> ในหน้าแรก (ส่วนสรุปบัญชีทั้งหมด) คุณสามารถคลิกที่การ์ดบัญชีใดก็ได้ เพื่อดูประวัติรายรับ-รายจ่ายของบัญชีนั้นโดยเฉพาะ</li>
                                <li><b>จัดเรียงลำดับ:</b> ในหน้าตั้งค่า คุณสามารถกดลูกศร ขึ้น/ลง เพื่อจัดเรียงลำดับการแสดงผลของบัญชีตามความสำคัญได้</li>
                                <li><i class="fa-solid fa-paint-brush mr-1 text-purple-600"></i><b>ใหม่! ไอคอน:</b> คุณสามารถเปลี่ยนไอคอนของแต่ละบัญชีได้ที่หน้าตั้งค่า</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6 border-l-4 border-yellow-400">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-wand-magic-sparkles text-yellow-500 mr-3"></i> 4. ฟีเจอร์อัจฉริยะ (Smart Features)
                    </h2>
                    <div class="space-y-4 text-gray-600 text-lg">
                        <div>
                            <h3 class="font-semibold text-purple-600"><i class="fa-solid fa-brain mr-2"></i> Auto-Learn (จำอัตโนมัติ)</h3>
                            <p class="pl-6">เมื่อคุณบันทึกรายการ เช่น "ข้าวมันไก่ 50 บาท" ในหมวด "อาหาร" ระบบจะจำไว้ ครั้งหน้าแค่พิมพ์ "ข้า..." ระบบจะเติมราคาและหมวดหมู่ให้ทันที</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-blue-600"><i class="fa-solid fa-microphone mr-2"></i> สั่งงานด้วยเสียง</h3>
                            <p class="pl-6">กดปุ่มไมโครโฟนแล้วพูดได้เลย ระบบจะวิเคราะห์คำพูดเพื่อแยกชื่อรายการ ราคา และหมวดหมู่ให้ เช่น:</p>
                            <ul class="list-disc list-inside pl-8 text-sm italic text-gray-500 mt-1">
                                <li>"จ่ายค่ากาแฟ 60 บาท" (ระบบลงเป็นรายจ่าย หมวดเครื่องดื่ม)</li>
                                <li>"ได้เงินเดือน 20000 บาท" (ระบบลงเป็นรายรับ หมวดเงินเดือน)</li>
                                <li>"กินหมูกระทะ 300 บาท" (ระบบลงเป็นรายจ่าย หมวดอาหาร)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6 border-l-4 border-gray-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-database text-gray-600 mr-3"></i> 5. การจัดการข้อมูล & ความปลอดภัย
                    </h2>
                    <ul class="list-disc list-inside space-y-2 text-gray-600 text-lg">
                        <li><b>รหัสผ่าน:</b> ตั้งค่ารหัสผ่านเพื่อป้องกันการแก้ไขหรือลบข้อมูลโดยไม่ตั้งใจ (ค่าเริ่มต้น: 1234) สามารถเปลี่ยนหรือลบออกได้ในหน้าตั้งค่า</li>
                        <li><b>สำรองข้อมูล (Backup):</b> ดาวน์โหลดไฟล์ .json เก็บไว้ในเครื่อง เพื่อกันข้อมูลหาย ควรทำสม่ำเสมอ</li>
                        <li><b>นำเข้าข้อมูล (Import):</b> นำไฟล์ .json ที่เคยสำรองไว้กลับมาใช้ หรือย้ายข้อมูลข้ามเครื่อง</li>
                        <li><i class="fa-solid fa-file-csv mr-1 text-indigo-600"></i><b>ใหม่! ส่งออก CSV:</b> สามารถส่งออกรายการธุรกรรมเป็นไฟล์ CSV เพื่อนำไปเปิดใน Excel ได้</li>
                        <li><b>ย้อนกลับ (Undo):</b> หากเผลอลบหรือแก้ไขผิด กดปุ่มนี้เพื่อยกเลิกการกระทำล่าสุดได้ทันที</li>
						<li><b>ทำซ้ำ (Redo):</b> ทำซ้ำการกระทำที่เพิ่งกดย้อนกลับไป</li>
                        <li><b>รีเซ็ตและล้างข้อมูลทั้งหมด:</b> ลบข้อมูลทุกอย่างเพื่อเริ่มต้นใหม่ (ควร Backup ก่อนทำ)</li>
                    </ul>
                </div>

                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6 border-l-4 border-indigo-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-calendar-days text-indigo-600 mr-3"></i> 6. การใช้งานปฏิทิน (Calendar)
                    </h2>
                    <div class="space-y-3 text-gray-600 text-lg">
                        <p>หน้าปฏิทินช่วยให้คุณเห็นภาพรวมการใช้จ่ายในแต่ละวัน:</p>
                        <ul class="list-disc list-inside ml-2 space-y-2">
                            <li><b>จุดสีบนปฏิทิน:</b>
                                <span class="text-green-600 font-bold mx-1">เขียว</span>=รายรับ, 
                                <span class="text-red-600 font-bold mx-1">แดง</span>=รายจ่าย, 
                                <span class="text-blue-600 font-bold mx-1">ฟ้า</span>=การโอน
                            </li>
                            <li><b>ดูรายละเอียดรายวัน:</b> คลิกที่วันที่ใดก็ได้บนปฏิทิน เพื่อดูรายการทั้งหมดของวันนั้นๆ</li>
                            <li><b>เพิ่มรายการย้อนหลัง:</b> เมื่อคลิกดูวันที่ คุณสามารถกดปุ่ม "เพิ่มธุรกรรมใหม่" ในหน้าต่างนั้น เพื่อลงบันทึกของวันนั้นได้ทันที</li>
                            <li><i class="fa-solid fa-image mr-1 text-purple-600"></i><b>ใหม่! ดูรูปใบเสร็จ:</b> ในหน้าสรุปรายวัน จะมีไอคอนใบเสร็จแสดงหากมีการแนบรูปภาพ</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-white p-5 md:p-6 rounded-xl shadow-lg mb-6 border-l-4 border-pink-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-lightbulb text-pink-500 mr-3"></i> 7. ทริคการใช้งานเพิ่มเติม
                    </h2>
                    <ul class="list-disc list-inside space-y-2 text-gray-600 text-lg">
                        <li><b>การปัดหน้าจอ (Swipe):</b> บนมือถือ คุณสามารถปัดซ้ายหรือขวาที่หน้าจอ เพื่อเปลี่ยนเมนูระหว่าง หน้าแรก - รายการ - ปฏิทิน - ตั้งค่า ได้อย่างรวดเร็ว</li>
                        <li><b>การค้นหาอัจฉริยะ:</b> ในหน้า "รายการ" ช่องค้นหาสามารถค้นหาได้ทุกอย่าง เช่น ยอดเงิน (500), ชื่อรายการ (ข้าว), หมวดหมู่ (อาหาร) หรือแม้แต่ชื่อบัญชี (KBank)</li>
                        <li><i class="fa-solid fa-star mr-1 text-yellow-500"></i><b>ใหม่! รายการโปรด:</b> ในฟอร์มบันทึกรายการ คุณสามารถกดปุ่ม **ดาว** เพื่อบันทึกชื่อรายการนั้นเป็นรายการโปรด (Frequent Item) ได้ทันที</li>
                        <li><i class="fa-solid fa-chart-line mr-1 text-purple-600"></i><b>ใหม่! กราฟแนวโน้ม:</b> ในหน้า "รายการ" คุณสามารถเปลี่ยนโหมดกราฟเป็น **"แนวโน้มรายเดือน/รายปี"** เพื่อดูภาพรวมการเงินในระยะยาวได้</li>
                        <li><i class="fa-solid fa-table mr-1 text-gray-600"></i><b>ใหม่! จัดกลุ่ม:</b> ในหน้า "รายการ" คุณสามารถเลือก **"จัดกลุ่มรายวัน/รายเดือน"** เพื่อดูผลรวมรายรับ-รายจ่ายเป็นกลุ่มในตารางได้</li>
                    </ul>
                </div>

            </div>
        </div> 
    </div> 
    
    <footer class="text-center p-6 text-gray-600 text-base">
        © 2025 Finance Manager Pro v7.2.4 | Developed by James IT
    </footer>

    <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-purple-600">เพิ่มรายการใหม่</h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-red-500 text-4xl w-12 h-12 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all absolute top-2 right-2 md:static md:w-auto md:h-auto md:hover:bg-transparent">
                    &times;
                </button>
            </div>
            
            <form id="transaction-form" class="space-y-4">
                <input type="hidden" id="tx-id">
                <div>
				<label class="block text-lg text-gray-700 font-medium mb-2">ประเภท</label>
				
				<div class="flex flex-row gap-4 items-center">
					
					<label class="flex items-center flex-shrink-0">
						<input type="radio" id="tx-type-income" name="tx-type" value="income" class="form-radio text-green-500 focus:ring-green-500" checked>
						<span class="ml-2 text-lg text-green-700">รายรับ</span>
					</label>
					<label class="flex items-center flex-shrink-0">
						<input type="radio" id="tx-type-expense" name="tx-type" value="expense" class="form-radio text-red-500 focus:ring-red-500">
						<span class="ml-2 text-lg text-red-700">รายจ่าย</span>
					</label>
					<label class="flex items-center flex-shrink-0">
						<input type="radio" id="tx-type-transfer" name="tx-type" value="transfer" class="form-radio text-blue-500 focus:ring-blue-500">
						<span class="ml-2 text-lg text-blue-700">โอนย้าย</span>
					</label>
					
				</div>
			</div>

                <div id="tx-account-container">
                    <label for="tx-account" class="block text-lg text-gray-700 font-medium mb-2">บัญชี <span class="text-red-500">*</span></label>
                    <select id="tx-account" class="w-full form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required>
                    </select>
                </div>

                <div id="tx-account-from-container" class="hidden">
                    <label for="tx-account-from" class="block text-lg text-gray-700 font-medium mb-2">โอนจาก <span class="text-red-500">*</span></label>
                    <select id="tx-account-from" class="w-full form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required>
                        </select>
                </div>

                <div id="tx-account-to-container" class="hidden">
                    <label for="tx-account-to" class="block text-lg text-gray-700 font-medium mb-2">โอนไป <span class="text-red-500">*</span></label>
                    <select id="tx-account-to" class="w-full form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required>
                        </select>
                </div>
   
                <div id="tx-name-container">
                    <div class="flex justify-between items-center mb-2">
                        <label for="tx-name" class="block text-lg text-gray-700 font-medium mb-0">ชื่อรายการ <span class="text-red-500">*</span></label>
                        <button type="button" id="toggle-favorite-btn" class="text-gray-400 hover:text-yellow-500 p-1 rounded-lg">
                            <i class="fa-solid fa-star text-xl"></i>
                        </button>
                        </div>
                    <input list="frequent-items-datalist" id="tx-name" class="w-full form-input text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required autocomplete="off">
                    <p id="auto-fill-hint" class="text-xs text-green-600 mt-1 hidden"><i class="fa-solid fa-magic-wand-sparkles"></i> เติมข้อมูลอัตโนมัติแล้ว</p>
                    <datalist id="frequent-items-datalist">
                    </datalist>
                </div>

                <div id="tx-category-container">
                    <label for="tx-category" class="block text-lg text-gray-700 font-medium mb-2">หมวดหมู่ <span class="text-red-500">*</span></label>
                    <select id="tx-category" class="w-full form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required>
                    </select>
                </div>

                <div class="relative">
                     <div class="flex justify-between items-center mb-2">
                        <label for="tx-amount" class="block text-lg text-gray-700 font-medium mb-0">จำนวนเงิน (บาท) <span class="text-red-500">*</span></label>
                        <button type="button" id="toggle-calc-btn" class="text-purple-600 hover:text-purple-800 p-1 rounded-lg">
                            <i class="fa-solid fa-calculator text-xl"></i>
                        </button>
                    </div>
                    <input type="text" id="tx-amount" inputmode="decimal" placeholder="0.00 หรือ 50+20" class="w-full form-input text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required>
                    
                    <div id="calculator-popover" class="absolute z-20 w-full max-w-xs bg-gray-50 shadow-lg rounded-xl p-3 mt-1 right-0 hidden border border-gray-200">
                        <div id="calc-preview" class="text-right text-purple-600 font-bold text-xl h-6 mb-2 pr-1"> </div>
                        <div id="calculator-grid" class="grid grid-cols-4 gap-1">
                             <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="7">7</button> <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="8">8</button>
                            <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="9">9</button>
                             <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="/">/</button>
                            <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="4">4</button>
                            <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="5">5</button>
                             <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="6">6</button>
                            <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="*">*</button>
                         <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="1">1</button>
                            <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="2">2</button>
                            <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="3">3</button>
                             <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="-">-</button>
                            <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="0">0</button>
                            <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value=".">.</button>
                            <button type="button" class="calc-btn bg-red-200 hover:bg-red-300 text-red-800 py-1 rounded-lg font-semibold text-base" data-value="C">C</button>
                            <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="+">+</button>
                         <button type="button" class="calc-btn col-span-4 bg-purple-600 hover:bg-purple-700 text-white py-1 rounded-lg font-semibold text-base" data-value="=">=</button>
                        </div>
                    </div>
                </div>

                <div>
                   <label for="tx-date" class="block text-lg text-gray-700 font-medium mb-2">วันที่ <span class="text-red-500">*</span></label>
                    <input type="datetime-local" id="tx-date" class="w-full form-input text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                
                <div>
                    <label for="tx-receipt-file" class="block text-lg text-gray-700 font-medium mb-2">แนบรูปภาพ/ใบเสร็จ (ไม่บังคับ)</label>
                    <div class="flex items-center space-x-3">
                        <input type="file" id="tx-receipt-file" accept="image/*" class="w-full text-sm text-gray-700
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-purple-50 file:text-purple-700
                            hover:file:bg-purple-100"
                        >
                        <button type="button" id="clear-receipt-btn" class="text-red-500 hover:text-red-700 p-2 hidden">
                            <i class="fa-solid fa-circle-xmark text-xl"></i>
                        </button>
                    </div>
                    <div id="receipt-preview-container" class="mt-3 hidden">
                        <img id="receipt-preview" class="max-w-xs max-h-40 rounded-lg shadow-md border border-gray-200 object-cover cursor-pointer hover:shadow-lg transition-shadow" alt="Receipt Preview">
                    </div>
                </div>
                <div>
                 <label for="tx-desc" class="block text-lg text-gray-700 font-medium mb-2">คำอธิบาย (ไม่บังคับ)</label>
                    <textarea id="tx-desc" rows="3" class="w-full form-textarea text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>

                <div class="flex justify-end gap-4 pt-4">
                 <button type="button" id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-xl text-lg">ยกเลิก</button> <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-xl shadow-lg text-lg">บันทึก</button> </div>
            </form>
        </div>
    </div>
    
    <div id="account-form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto relative">
            <div class="flex justify-between items-center mb-4">
                <h2 id="account-modal-title" class="text-xl font-bold text-purple-600">แก้ไขบัญชี</h2>
                <button id="account-modal-close-btn" class="text-gray-400 hover:text-red-500 text-4xl w-12 h-12 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all absolute top-2 right-2 md:static md:w-auto md:h-auto md:hover:bg-transparent">
                    &times;
                </button>
            </div>
            <form id="account-form" class="space-y-4">
                <input type="hidden" id="edit-account-id">
                <div>
                    <label for="edit-account-name" class="block text-lg text-gray-700 font-medium mb-2">ชื่อบัญชี</label>
                    <input type="text" id="edit-account-name" class="w-full form-input text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl" required>
                </div>
                <div>
                    <label for="edit-account-type" class="block text-lg text-gray-700 font-medium mb-2">ประเภทบัญชี</label>
                    <select id="edit-account-type" class="w-full form-select text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl" required>
                        <option value="cash">เงินสด/ออมทรัพย์/วอลเล็ท</option>
                        <option value="credit">บัตรเครดิต</option>
                        <option value="liability">บัญชีหนี้สิน</option>
                    </select>
                </div>
                <div>
                    <label for="edit-account-balance" class="block text-lg text-gray-700 font-medium mb-2">ยอดเริ่มต้น (Initial Balance)</label>
                    
                    <div class="relative">
                        <input type="text" id="edit-account-balance" inputmode="decimal" value="0" class="w-full form-input text-lg text-gray-700 bg-gray-50 border border-gray-200 rounded-xl pr-12" required>
                        <button type="button" id="toggle-edit-account-calc-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-purple-600 hover:text-purple-800 p-1 rounded-lg">
                            <i class="fa-solid fa-calculator text-xl"></i>
                        </button>
                        <div id="edit-account-calculator-popover" class="absolute z-20 w-full max-w-xs bg-gray-50 shadow-lg rounded-xl p-3 mt-1 right-0 hidden border border-gray-200">
                             <div id="edit-acc-calc-preview" class="text-right text-purple-600 font-bold text-xl h-6 mb-2 pr-1"> </div>
                             <div id="edit-account-calculator-grid" class="grid grid-cols-4 gap-1">
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="7">7</button> <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="8">8</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="9">9</button>
                                <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="/">/</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="4">4</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="5">5</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="6">6</button>
                                <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="*">*</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="1">1</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="2">2</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="3">3</button>
                                <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="-">-</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value="0">0</button>
                                <button type="button" class="calc-btn bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded-lg font-semibold text-base" data-value=".">.</button>
                                <button type="button" class="calc-btn bg-red-200 hover:bg-red-300 text-red-800 py-1 rounded-lg font-semibold text-base" data-value="C">C</button>
                                <button type="button" class="calc-btn bg-purple-200 hover:bg-purple-300 text-purple-800 py-1 rounded-lg font-semibold text-base" data-value="+">+</button>
                                <button type="button" class="calc-btn col-span-4 bg-purple-600 hover:bg-purple-700 text-white py-1 rounded-lg font-semibold text-base" data-value="=">=</button>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-500 mt-1">หมายเหตุ: การเปลี่ยนยอดเริ่มต้นจะส่งผลต่อยอดคงเหลือปัจจุบัน</p>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="account-modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-xl text-lg">ยกเลิก</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-xl shadow-lg text-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="account-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <div class="flex justify-between items-start md:items-center mb-4 border-b pb-3">
                <div class="flex flex-col md:flex-row md:items-center justify-between w-full md:gap-4 pr-10 md:pr-0">
                     <h2 id="account-detail-modal-title" class="text-lg md:text-2xl font-bold text-purple-600 mb-2 md:mb-0">รายการธุรกรรมของบัญชี [ชื่อบัญชี]</h2>
                     
                     <button id="add-tx-from-account-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-1.5 px-3 md:py-2 md:px-4 rounded-xl shadow-md text-sm md:text-base transition duration-300 flex items-center gap-2 w-fit">
                        <i class="fa-solid fa-plus"></i> เพิ่มธุรกรรมใหม่
                     </button>
                </div>
                <button id="account-detail-modal-close-btn" class="text-gray-400 hover:text-red-500 text-4xl w-12 h-12 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all absolute top-2 right-2 md:static md:w-auto md:h-auto md:hover:bg-transparent md:ml-4">
                    &times;
                </button>
            </div>
            <div class="mb-4">
                <p class="text-base md:text-lg font-medium text-gray-700">ยอดคงเหลือเริ่มต้น: <span id="acc-detail-initial-balance" class="font-bold"></span></p>
                <p class="text-base md:text-lg font-medium text-gray-700">ยอดคงเหลือปัจจุบัน: <span id="acc-detail-current-balance" class="font-bold"></span></p>
            </div>
            <div id="acc-detail-controls-header" class="flex flex-col md:flex-row justify-end items-center mb-4 gap-4">
                <div class="flex flex-wrap justify-center md:justify-end items-center gap-3 bg-gray-50 p-3 rounded-xl shadow-inner border border-gray-200 w-full md:w-auto">
                    <select id="acc-detail-view-mode-select" class="form-select text-base text-gray-700 bg-white border-0 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        <option value="all">ดูทั้งหมด</option>
                        <option value="month">ดูรายเดือน</option>
                        <option value="year">ดูรายปี</option>
                    </select>
                    <div id="acc-detail-month-controls" class="flex items-center gap-1 hidden">
                        <button id="acc-detail-month-prev" class="px-3 py-2 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-left"></i></button>
                        <input type="month" id="acc-detail-month-picker" class="form-input text-base text-gray-700 bg-white border-0 rounded-lg focus:ring-purple-500 focus:border-purple-500 w-auto">
                        <button id="acc-detail-month-next" class="px-3 py-2 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div id="acc-detail-year-controls" class="flex items-center gap-1 hidden">
                        <button id="acc-detail-year-prev" class="px-3 py-2 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-left"></i></button>
                        <input type="number" id="acc-detail-year-picker" class="form-input text-base text-gray-700 bg-white border-0 rounded-lg focus:ring-purple-500 focus:border-purple-500 w-24 text-center" placeholder="YYYY">
                        <button id="acc-detail-year-next" class="px-3 py-2 bg-gray-200 hover:bg-purple-200 rounded-lg"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto no-scrollbar">
				<table class="w-full text-left table-fixed"> 
					<thead>
						<tr class="border-b border-gray-200 bg-gray-100">
							<th class="p-2 text-base md:text-lg text-gray-900 font-bold w-[18%] md:w-[15%] align-top">วันที่</th>
							
							<th class="p-2 text-base md:text-lg text-gray-900 font-bold w-[32%] md:w-[35%] align-top">รายการ</th>
							
							<th class="p-2 text-base md:text-lg text-gray-900 font-bold w-[25%] md:w-[25%] text-right align-top">รับ/จ่าย</th>
							
							<th class="p-2 text-base md:text-lg text-gray-900 font-bold w-[25%] md:w-[25%] text-right align-top">คงเหลือ</th>
						</tr>
					</thead>
					<tbody id="account-detail-modal-body">
						<tr><td colspan="4" class="p-6 text-center text-gray-500">กำลังโหลดรายการ...</td></tr>
					</tbody>
				</table>
			</div>
        </div>
    </div>
    
    <div id="icon-form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-xl max-h-[90vh] overflow-y-auto relative">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-purple-600">เลือกไอคอนสำหรับบัญชี <span id="icon-acc-name"></span></h2>
                <button id="icon-modal-close-btn" class="text-gray-400 hover:text-red-500 text-4xl w-12 h-12 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all absolute top-2 right-2 md:static md:w-auto md:h-auto md:hover:bg-transparent">
                    &times;
                </button>
            </div>

            <input type="hidden" id="edit-icon-account-id">
            
            <div class="mb-4">
                <div class="text-lg font-medium text-gray-700 mb-2">ไอคอนปัจจุบัน: <i id="icon-preview" class="fa-solid fa-wallet text-purple-600 text-2xl ml-2"></i></div>
                <input type="text" id="icon-search" placeholder="ค้นหาไอคอน..." class="w-full form-input text-lg py-3 px-4 text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:ring-purple-500 focus:border-purple-500">
            </div>

            <div id="icon-list-container" class="grid grid-cols-6 sm:grid-cols-8 gap-2 max-h-80 overflow-y-auto p-2 bg-gray-50 rounded-xl border border-gray-200">
                </div>

            <div class="flex justify-end gap-4 pt-4">
                <button type="button" id="icon-modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-xl text-lg">ยกเลิก</button>
                <button type="button" id="icon-modal-save-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-xl shadow-lg text-lg">บันทึก</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const DB_NAME = 'expenseTrackerDB_JamesIT';
            const DB_VERSION = 4; 
        
            const STORE_TRANSACTIONS = 'transactions';
            const STORE_CATEGORIES = 'categories';
            const STORE_FREQUENT_ITEMS = 'frequentItems';
            const STORE_CONFIG = 'config';
            const STORE_ACCOUNTS = 'accounts'; 
            const STORE_AUTO_COMPLETE = 'autoComplete'; 
            
            const PAGE_IDS = ['page-home', 'page-list', 'page-calendar', 'page-settings', 'page-guide'];
            // ********** Master Password Config **********
            const MASTER_PASSWORD = 'James0849664455';
            const HASHED_MASTER_PASSWORD = CryptoJS.SHA256(MASTER_PASSWORD).toString();
            // ************************************************

            let db;
            const SpeechRecognition = window.SpeechRecognition ||
            window.webkitSpeechRecognition;
            let recognition;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'th-TH'; 
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            } else {
                console.warn("Web Speech API not supported in this browser.");
            }
            
            // ********** NEW AUTO LOCK VARIABLES **********
            let lastActivityTime = Date.now();
            let autoLockTimeoutId = null;
            const AUTOLOCK_CONFIG_KEY = 'autoLockTimeout';
            // *********************************************
            
            // ********** NEW DARK MODE VARIABLE **********
            const DARK_MODE_CONFIG_KEY = 'isDarkMode'; 
            // *********************************************

            const DEFAULT_PASSWORD = '1234';
            const DEFAULT_CATEGORIES = {
                income: ['เงินเดือน', 'รายได้เสริม', 'ค่าคอม', 'รายได้อื่นๆ'],
                expense: ['อาหาร', 'เครื่องดื่ม', 'เดินทาง', 'ของใช้ส่วนตัว', 'ของใช้ในบ้าน', 'รายจ่ายอื่นๆ']
            };
            const DEFAULT_FREQUENT_ITEMS = ['กินข้าว', 'รายจ่ายทั่วไป'];
            
            // *** NEW: Icon Choices for Account Settings ***
            const ICON_CHOICES = [
                'fa-wallet', 'fa-piggy-bank', 'fa-credit-card', 'fa-money-bill-wave', 
                'fa-sack-dollar', 'fa-building-columns', 'fa-car', 'fa-house', 
                'fa-utensils', 'fa-dumbbell', 'fa-plane', 'fa-graduation-cap', 
                'fa-shopping-cart', 'fa-hospital', 'fa-gift', 'fa-receipt',
                'fa-file-invoice-dollar', 'fa-briefcase', 'fa-mobile-screen', 'fa-store', 
                'fa-person-running', 'fa-paw', 'fa-heart', 'fa-lightbulb'
            ];
            // ********************************************

            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (event) => {
                       console.error('Database error:', event.target.error);
                        reject('Database error: ' + event.target.error);
                    };

						request.onupgradeneeded = (event) => {
							const db = event.target.result;
							const tx = event.target.transaction;

							let txStore;
							if (!db.objectStoreNames.contains(STORE_TRANSACTIONS)) {
								txStore = db.createObjectStore(STORE_TRANSACTIONS, { keyPath: 'id' });
								txStore.createIndex('type', 'type', { unique: false });
							} else {
								txStore = tx.objectStore(STORE_TRANSACTIONS);
							}

							if (!db.objectStoreNames.contains(STORE_CATEGORIES)) {
								db.createObjectStore(STORE_CATEGORIES, { keyPath: 'type' });
							}
							if (!db.objectStoreNames.contains(STORE_FREQUENT_ITEMS)) {
								db.createObjectStore(STORE_FREQUENT_ITEMS, { keyPath: 'name' });
							}
							if (!db.objectStoreNames.contains(STORE_CONFIG)) {
								db.createObjectStore(STORE_CONFIG, { keyPath: 'key' });
							}

							if (event.oldVersion < 2) {
								 if (!db.objectStoreNames.contains(STORE_ACCOUNTS)) {
									const accountStore = db.createObjectStore(STORE_ACCOUNTS, { keyPath: 'id' });
									accountStore.createIndex('displayOrder', 'displayOrder', { unique: false });
								}
								
								if (!txStore.indexNames.contains('accountId')) {
									txStore.createIndex('accountId', 'accountId', { unique: false });
								}
								 if (!txStore.indexNames.contains('toAccountId')) {
									txStore.createIndex('toAccountId', 'toAccountId', { unique: false });
								}
							}

							// +++ NEW in v3: Auto-Complete Store +++
							if (event.oldVersion < 3) {
								if (!db.objectStoreNames.contains(STORE_AUTO_COMPLETE)) {
									// Key is 'name' because we want to look up by name
									db.createObjectStore(STORE_AUTO_COMPLETE, { keyPath: 'name' });
								}
							}
							
							// +++ NEW in v4: Add any new features or indexes here +++
							if (event.oldVersion < 4) {
								 // ตัวอย่าง: เพิ่ม Index สำหรับค้นหาตามชื่อรายการ
								 // เพื่อให้การค้นหาชื่อรายการในรายการธุรกรรมเร็วขึ้น
								 if (!txStore.indexNames.contains('name')) {
									 txStore.createIndex('name', 'name', { unique: false });
								 }
								 console.log('IndexedDB Upgrade: Running v4 migration (Added "name" index to transactions)');
							}
							
							// Default data (only on first install, v1)
							if (event.oldVersion < 1) { // นี่คือบล็อกที่ทำงานเมื่อติดตั้งครั้งแรก
								const catStore = tx.objectStore(STORE_CATEGORIES);
								catStore.add({ type: 'income', items: DEFAULT_CATEGORIES.income });
								catStore.add({ type: 'expense', items: 'DEFAULT_CATEGORIES.expense' });

								const itemStore = tx.objectStore(STORE_FREQUENT_ITEMS);
								DEFAULT_FREQUENT_ITEMS.forEach(item => itemStore.add({ name: item }));
								
								const configStore = tx.objectStore(STORE_CONFIG);
								const hashedPassword = CryptoJS.SHA256(DEFAULT_PASSWORD).toString(); 
								configStore.add({ key: 'password', value: hashedPassword });
								
								// ********** เพิ่มโค้ดนี้เพื่อตั้งค่าเริ่มต้น Auto Lock เป็น 10 นาที **********
								configStore.add({ key: AUTOLOCK_CONFIG_KEY, value: 10 }); 
								// ********** เพิ่มโค้ดนี้เพื่อตั้งค่าเริ่มต้น Dark Mode เป็น false **********
								configStore.add({ key: DARK_MODE_CONFIG_KEY, value: false }); 
								// *************************************************************************
							}
						};
						request.onsuccess = (event) => {
                        db = event.target.result;
                        resolve(db);
                    };
                });
            }

            async function runMigration() {
                try {
                    const accounts = await dbGetAll(STORE_ACCOUNTS);
                    if (accounts.length > 0) {
                        return;
                    }

                    console.log("Running one-time data migration for v2...");
                    Swal.fire({
                        title: 'กำลังอัปเกรดข้อมูล',
                        text: 'โปรดรอสักครู่ ระบบกำลังย้ายข้อมูลเก่าของคุณไปยังระบบบัญชีใหม่...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    const defaultCash = { 
                        id: 'acc-cash-' + Date.now(), 
                        name: 'เงินสด', 
                        type: 'cash', 
                        initialBalance: 0,
                        icon: 'fa-wallet',
                        iconName: 'fa-wallet', // *** NEW DEFAULT ICON NAME ***
                        displayOrder: Date.now() 
                    };
                    const defaultCredit = { 
                        id: 'acc-credit-' + Date.now(), 
                        name: 'บัตรเครดิต (เริ่มต้น)', 
                        type: 'credit', 
                        initialBalance: 0,
                        icon: 'fa-credit-card',
                        iconName: 'fa-credit-card', // *** NEW DEFAULT ICON NAME ***
                        displayOrder: Date.now() + 1 
                    };
                    await dbPut(STORE_ACCOUNTS, defaultCash);
                    await dbPut(STORE_ACCOUNTS, defaultCredit);

                    const transactions = await dbGetAll(STORE_TRANSACTIONS);
                    const updatePromises = [];
                    let migratedCount = 0;
                    for (const tx of transactions) {
                        if (tx.accountId) {
                            continue;
                        }
                        if (tx.isNonDeductible === true) {
                            tx.accountId = defaultCredit.id;
                        } else {
                            tx.accountId = defaultCash.id;
                        }
                        delete tx.isNonDeductible;
                        updatePromises.push(dbPut(STORE_TRANSACTIONS, tx));
                        migratedCount++;
                    }

                    await Promise.all(updatePromises);
                    Swal.close();

                } catch (err) {
                    console.error("Migration failed:", err);
                    Swal.fire({
                        title: 'อัปเกรดข้อมูลล้มเหลว', 
                        text: 'ไม่สามารถย้ายข้อมูลเก่าได้: ' + err.message, 
                        icon: 'error',
                        customClass: { popup: state.isDarkMode ? 'swal2-popup' : '' },
                        background: state.isDarkMode ? '#1a1a1a' : '#fff',
                        color: state.isDarkMode ? '#e5e7eb' : '#545454',
                    });
                }
            }

            function dbGet(storeName, key) {
                return new Promise((resolve, reject) => {
                    if (!db) return reject("DB not initialized");
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            function dbGetAll(storeName) {
                return new Promise((resolve, reject) => {
                    if (!db) return reject("DB not initialized");
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            function dbPut(storeName, item) {
                return new Promise((resolve, reject) => {
                    if (!db) return reject("DB not initialized");
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            function dbDelete(storeName, key) {
                return new Promise((resolve, reject) => {
                    if (!db) return reject("DB not initialized");
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            function dbClear(storeName) {
                return new Promise((resolve, reject) => {
                    if (!db) return reject("DB not initialized");
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            function getSortedAccounts() {
                return [...state.accounts].sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            }
            
            let myChart;
            let myListPageBarChart;
            let myExpenseByNameChart; 
            let myCalendar = null;
            let lastUndoAction = null;
            let lastRedoAction = null;
            
            // +++ NEW: Receipt State +++
            let currentReceiptBase64 = null; // Store Base64 temporarily
            const MAX_FILE_SIZE_MB = 1; // จำกัดขนาดไฟล์ที่ 1MB
            // +++ END NEW +++
        
            let currentPage = 'home';
            let isTransitioning = false; // Add transition flag
            let state = {
                transactions: [],
                categories: {
                    income: [],
                    expense: []
                },
                accounts: [], 
                frequentItems: [],
                autoCompleteList: [], // +++ NEW STATE: Learned items
                filterType: 'all', 
                searchTerm: '',
                homeFilterType: 'all', 
                homeViewMode: 'month',
                homeCurrentDate: new Date().toISOString().slice(0, 10),
                listViewMode: 'all',
                listCurrentDate: new Date().toISOString().slice(0, 10),
                password: null,
                homeCurrentPage: 1,
                homeItemsPerPage: 10, 
                listCurrentPage: 1,
                listItemsPerPage: 10,
                calendarCurrentDate: new Date().toISOString().slice(0, 10), 
                listChartMode: 'items',
                listGroupBy: 'none', // *** NEW STATE for Grouping ***
                showBalanceCard: false, 
                isDarkMode: false, // *** NEW STATE for Dark Mode ***
				settingsCollapse: {},
                autoLockTimeout: 0 // +++ NEW STATE: Auto Lock Timeout in minutes (0 = off)
            };
            
            // ********** NEW: Account Detail Modal View State & Functions **********
            let accountDetailState = {
                accountId: null,
                viewMode: 'all', // 'all', 'month', 'year'
                currentDate: new Date().toISOString().slice(0, 10) // YYYY-MM-DD
            };

            function updateAccountDetailControls() {
                const getEl = (id) => document.getElementById(id);
                const viewMode = accountDetailState.viewMode;
                const currentDate = accountDetailState.currentDate;
                
                // ตั้งค่า View Mode
                getEl('acc-detail-view-mode-select').value = viewMode;
                
                // แสดง/ซ่อน Controls
                if (viewMode === 'all') {
                    getEl('acc-detail-month-controls').classList.add('hidden');
                    getEl('acc-detail-year-controls').classList.add('hidden');
                    getEl('acc-detail-month-controls').classList.remove('flex');
                    getEl('acc-detail-year-controls').classList.remove('flex');
                } else if (viewMode === 'month') {
                    getEl('acc-detail-month-controls').classList.remove('hidden');
                    getEl('acc-detail-month-controls').classList.add('flex');
                    getEl('acc-detail-year-controls').classList.add('hidden');
                    getEl('acc-detail-year-controls').classList.remove('flex');
                    
                    const monthYear = currentDate.slice(0, 7);
                    getEl('acc-detail-month-picker').value = monthYear;
                } else { 
                    getEl('acc-detail-month-controls').classList.add('hidden');
                    getEl('acc-detail-month-controls').classList.remove('flex');
                    getEl('acc-detail-year-controls').classList.remove('hidden');
                    getEl('acc-detail-year-controls').classList.add('flex');
                    
                    const year = currentDate.slice(0, 4);
                    getEl('acc-detail-year-picker').value = year;
                }
            }

            function handleAccountDetailViewModeChange(e) {
                const newMode = e.target.value;
                accountDetailState.viewMode = newMode;
                accountDetailState.currentDate = new Date().toISOString().slice(0, 10); // Reset date on mode change
                
                updateAccountDetailControls();
                renderAccountDetailList(accountDetailState.accountId);
            }

            function handleAccountDetailDateChange(e, mode) {
                let newDate;
                
                if (mode === 'month') {
                    const [year, month] = e.target.value.split('-');
                    if (year && month) {
                        newDate = `${year}-${month}-01`;
                    }
                } else { // mode === 'year'
                    const year = e.target.value;
                    if (year && year.length === 4) {
                        newDate = `${year}-01-01`;
                    }
                }

                if (newDate) {
                    accountDetailState.currentDate = newDate;
                    renderAccountDetailList(accountDetailState.accountId);
                }
            }

            function navigateAccountDetailPeriod(direction, mode) {
                let dateStr = accountDetailState.currentDate;
                let date = new Date(dateStr);
                
                if (mode === 'month') {
                    date.setMonth(date.getMonth() + direction);
                } else { // mode === 'year'
                    date.setFullYear(date.getFullYear() + direction);
                }
                
                accountDetailState.currentDate = date.toISOString().slice(0, 10);
                
                updateAccountDetailControls();
                renderAccountDetailList(accountDetailState.accountId);
            }
            // ***************************************************************


            async function loadStateFromDB() {
                try {
                    state.accounts = await dbGetAll(STORE_ACCOUNTS);
                    let updateOrderPromises = [];
                    let hasUndefinedOrder = false;
                    state.accounts.forEach((acc, index) => {
                        if (acc.displayOrder === undefined || acc.displayOrder === null) {
                            acc.displayOrder = Date.now() + index; 
                            updateOrderPromises.push(dbPut(STORE_ACCOUNTS, acc));
                            hasUndefinedOrder = true;
                        }
                        // *** NEW: กำหนดค่า iconName เป็นค่าว่างหากไม่มี (สำหรับการจัดการไอคอน) ***
                        if (acc.iconName === undefined) {
                            acc.iconName = acc.icon || 'fa-wallet'; // ใช้ icon เดิมเป็นค่าเริ่มต้น
                            updateOrderPromises.push(dbPut(STORE_ACCOUNTS, acc));
                            hasUndefinedOrder = true;
                        }
                    });
                    if (hasUndefinedOrder) {
                        console.log('Running one-time migration for account displayOrder/iconName...');
                        await Promise.all(updateOrderPromises);
                        state.accounts = await dbGetAll(STORE_ACCOUNTS);
                    }
                    
                    state.transactions = await dbGetAll(STORE_TRANSACTIONS);
                    const incomeCats = await dbGet(STORE_CATEGORIES, 'income');
                    const expenseCats = await dbGet(STORE_CATEGORIES, 'expense');
                    state.categories.income = incomeCats ? incomeCats.items : [...DEFAULT_CATEGORIES.income];
                    state.categories.expense = expenseCats ? expenseCats.items : [...DEFAULT_CATEGORIES.expense];

                    const frequentItems = await dbGetAll(STORE_FREQUENT_ITEMS);
                    state.frequentItems = frequentItems.map(item => item.name);
                    // +++ LOAD Auto Complete Data +++
                    state.autoCompleteList = await dbGetAll(STORE_AUTO_COMPLETE);
                    const passwordConfig = await dbGet(STORE_CONFIG, 'password');
                    let storedPassword;

                    if (passwordConfig) {
                        storedPassword = passwordConfig.value;
                    } else {
                        const hashedPassword = CryptoJS.SHA256(DEFAULT_PASSWORD).toString();
                        await dbPut(STORE_CONFIG, { key: 'password', value: hashedPassword });
                        state.password = hashedPassword;
                        storedPassword = hashedPassword;
                    }

                    if (storedPassword && typeof storedPassword === 'string' && storedPassword.length !== 64) {
                        const newlyHashed = CryptoJS.SHA256(storedPassword).toString();
                        await dbPut(STORE_CONFIG, { key: 'password', value: newlyHashed });
                        state.password = newlyHashed;
                    } else {
                        state.password = storedPassword;
                    }

                    const today = new Date().toISOString().slice(0, 10);
                    state.homeCurrentDate = today; 
                    state.listCurrentDate = today; 
                    state.calendarCurrentDate = today;
                    state.homeViewMode = 'month';
                    state.listViewMode = 'all';
                    state.homeCurrentPage = 1;
                    state.homeItemsPerPage = 10;
                    state.listCurrentPage = 1;
                    state.listItemsPerPage = 10; 
                    
                    // +++ แก้ไข: กำหนดค่าเริ่มต้นให้ครบทุกกล่อง +++
                    const defaultCollapseSettings = {
                        'settings-accounts-content': true,
                        'settings-income-content': true,
                        'settings-expense-content': true,
                        'settings-manual-content': true,
                        'home-accounts-content': true,
                        'home-transactions-content': true 
                    };

                    const collapseConfig = await dbGet(STORE_CONFIG, 'collapse_preferences');
                    if (collapseConfig && collapseConfig.value) {
                        // รวมข้อมูลเดิมใน DB เข้ากับข้อมูล Default (เพื่อป้องกันกล่องใหม่ไม่ทำงาน)
                        state.settingsCollapse = { ...defaultCollapseSettings, ...collapseConfig.value };
                    } else {
                        state.settingsCollapse = defaultCollapseSettings;
                    }
                    
                    const showBalanceConfig = await dbGet(STORE_CONFIG, 'showBalanceCard');
                    state.showBalanceCard = showBalanceConfig ? showBalanceConfig.value : false;

                    // +++ LOAD AUTO LOCK SETTING +++
                    const autoLockConfig = await dbGet(STORE_CONFIG, AUTOLOCK_CONFIG_KEY);
                    state.autoLockTimeout = autoLockConfig ? autoLockConfig.value : 0;
                    
                    // +++ NEW: LOAD DARK MODE SETTING +++
                    const darkModeConfig = await dbGet(STORE_CONFIG, DARK_MODE_CONFIG_KEY);
                    state.isDarkMode = darkModeConfig ? darkModeConfig.value : false;


                } catch (e) {
                    console.error("Failed to load state from DB, using defaults.", e);
                }
            }
            
            // 1. แก้ไขฟังก์ชัน initApp เดิม
            async function initApp() {
                try {
                    await initDB();
                    await runMigration(); 
                    await loadStateFromDB();
                    setupEventListeners();
                    setupSwipeNavigation(); 
                    setupAutoLockListener(); // *** NEW: Setup Auto Lock ***
                    applyDarkModePreference(); // *** NEW: Apply Dark Mode before UI render ***

                    // --- ส่วนที่แก้ไข: ตรวจสอบรหัสผ่านก่อนเริ่ม ---
                    const lockScreen = document.getElementById('app-lock-screen');
                    const initialPageId = PAGE_IDS[0];
                    
                    // ซ่อนทุกหน้าก่อน
                    PAGE_IDS.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = 'none';
                    });

                    // ตรวจสอบว่ามีรหัสผ่านไหม
                    if (state.password) {
                        // แสดงหน้าจอล็อค
                        lockScreen.classList.remove('hidden');
                        // ตั้งค่า Event Listener สำหรับการปลดล็อค
                        document.getElementById('unlock-form').addEventListener('submit', handleUnlock);
                    } else {
                        // ถ้าไม่มีรหัสผ่าน ให้เข้าหน้าแรกเลย
                        document.getElementById(initialPageId).style.display = 'block';
                        currentPage = initialPageId.replace('page-', '');
                        onAppStart(); // เรียกฟังก์ชันเริ่มการทำงาน UI
                    }
                    // ---------------------------------------

                } catch (err) {
                    console.error("Failed to initialize app:", err);
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด', 
                        text: 'ไม่สามารถเริ่มต้นฐานข้อมูลได้', 
                        icon: 'error',
                        customClass: { popup: state.isDarkMode ? 'swal2-popup' : '' },
                        background: state.isDarkMode ? '#1a1a1a' : '#fff',
                        color: state.isDarkMode ? '#e5e7eb' : '#545454',
                    });
                }
            }

            // 2. เพิ่มฟังก์ชันใหม่ สำหรับจัดการ UI หลังจากเข้าแอปได้
            function onAppStart() {
                const getEl = (id) => document.getElementById(id);
                getEl('nav-home').classList.add('text-purple-600');
                getEl('nav-home').classList.remove('text-gray-600');
                getEl('nav-home-mobile').classList.add('text-purple-600'); 
                getEl('nav-home-mobile').classList.remove('text-gray-600');

                getEl('shared-controls-header').style.display = 'flex';
                updateSharedControls('home');
                renderAll(); 
                renderSettings();
                resetAutoLockTimer(); // *** NEW: Reset timer on start ***
            }

            // 3. เพิ่มฟังก์ชันใหม่ สำหรับการปลดล็อค
            async function handleUnlock(e) {
                e.preventDefault();
                const inputPass = document.getElementById('unlock-password').value;
                const hashedInput = CryptoJS.SHA256(inputPass).toString();
                
                // ตรวจสอบกับรหัสผ่านปัจจุบัน หรือ Master Password
                if (hashedInput === state.password || hashedInput === HASHED_MASTER_PASSWORD) {
                    
                    // อนิเมชั่นเล็กน้อยก่อนเข้า
                    const unlockBtn = e.target.querySelector('button');
                    unlockBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังเข้าสู่ระบบ...';
                    
                    setTimeout(() => {
                        document.getElementById('app-lock-screen').classList.add('hidden'); // ซ่อนหน้าล็อค
                        document.getElementById('page-home').style.display = 'block'; // แสดงหน้าแรก
                        currentPage = 'home';
                        onAppStart(); // โหลดข้อมูล UI
                        
                        // ล้างช่องรหัสผ่าน
                        document.getElementById('unlock-password').value = '';
                        unlockBtn.innerHTML = '<i class="fa-solid fa-door-open"></i> เข้าสู่ระบบ';
                        
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true,
                            // *** NEW: Add Dark Mode options for Toast ***
                            customClass: { popup: state.isDarkMode ? 'swal2-toast' : '' },
                            background: state.isDarkMode ? '#1a1a1a' : '#fff',
                            color: state.isDarkMode ? '#e5e7eb' : '#545454',
                        });
                        Toast.fire({
                            icon: "success",
                            title: "ยินดีต้อนรับกลับมาครับ!"
                        });
                    }, 10);

                } else {
                    // รหัสผิด
                    Swal.fire({
                        icon: 'error',
                        title: 'รหัสผ่านไม่ถูกต้อง',
                        text: 'กรุณาลองใหม่อีกครั้ง',
                        confirmButtonColor: '#d33',
                        timer: 1500,
                        // *** NEW: Add Dark Mode options ***
                        customClass: { popup: state.isDarkMode ? 'swal2-popup' : '' },
                        background: state.isDarkMode ? '#1a1a1a' : '#fff',
                        color: state.isDarkMode ? '#e5e7eb' : '#545454',
                    });
                    document.getElementById('unlock-password').value = '';
                    document.getElementById('unlock-password').focus();
                }
            }

            // ********** NEW: Auto Lock Logic **********
            function lockApp() {
                // เช็คว่าตั้งรหัสผ่านหรือไม่ และกำลังอยู่หน้าล็อคอยู่แล้วหรือไม่
                const isLocked = !document.getElementById('app-lock-screen').classList.contains('hidden');
                if (state.password === null || isLocked) {
                    return;
                }
                
                // ปิดทุก Modal ที่อาจจะเปิดอยู่
                closeModal(); 
                closeAccountDetailModal();
                openAccountModal(null, true);

                // ซ่อนทุกหน้า
                PAGE_IDS.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                // แสดงหน้าจอล็อค
                document.getElementById('app-lock-screen').classList.remove('hidden');
                // ล้าง Timer
                clearTimeout(autoLockTimeoutId);
            }

            function resetAutoLockTimer() {
                // หากไม่มีรหัสผ่าน หรือตั้งค่าเป็น 'ปิด' (0 นาที) จะไม่ทำงาน
                if (state.password === null || state.autoLockTimeout === 0) {
                    clearTimeout(autoLockTimeoutId);
                    return;
                }

                // หากกำลังอยู่หน้า Lock Screen จะไม่ทำงาน
                const isLocked = !document.getElementById('app-lock-screen').classList.contains('hidden');
                if (isLocked) {
                    return;
                }

                clearTimeout(autoLockTimeoutId);
                lastActivityTime = Date.now();
                
                const timeoutMs = state.autoLockTimeout * 60 * 1000;

                autoLockTimeoutId = setTimeout(lockApp, timeoutMs);
            }

            function setupAutoLockListener() {
                const events = ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'];
                events.forEach(event => {
                    document.addEventListener(event, resetAutoLockTimer, true);
                });
                
                const selectEl = document.getElementById('auto-lock-select');
                if (selectEl) {
                    // ตั้งค่าเริ่มต้นของ Dropdown
                    selectEl.value = state.autoLockTimeout.toString();

                    selectEl.addEventListener('change', async (e) => {
                        const newTimeout = parseInt(e.target.value, 10);
                        state.autoLockTimeout = newTimeout;
                        
                        try {
                            await dbPut(STORE_CONFIG, { key: AUTOLOCK_CONFIG_KEY, value: newTimeout });
                            
                            if (newTimeout > 0 && state.password === null) {
                                // แจ้งเตือนหากตั้งเวลาแต่ยังไม่ตั้งรหัสผ่าน
                                Swal.fire({
                                    title: 'ข้อควรทราบ', 
                                    text: 'ระบบ Auto Lock จะทำงานเมื่อมีการตั้งรหัสผ่านเท่านั้น', 
                                    icon: 'info',
                                    customClass: { popup: state.isDarkMode ? 'swal2-popup' : '' },
                                    background: state.isDarkMode ? '#1a1a1a' : '#fff',
                                    color: state.isDarkMode ? '#e5e7eb' : '#545454',
                                });
                            }
                            
                            // รีเซ็ต Timer ทันทีเพื่อใช้ค่าใหม่
                            resetAutoLockTimer();

                            const Toast = Swal.mixin({
                                toast: true,
                                position: "top-end",
                                showConfirmButton: false,
                                timer: 1000,
                                timerProgressBar: true,
                                // *** NEW: Add Dark Mode options for Toast ***
                                customClass: { popup: state.isDarkMode ? 'swal2-toast' : '' },
                                background: state.isDarkMode ? '#1a1a1a' : '#fff',
                                color: state.isDarkMode ? '#e5e7eb' : '#545454',
                            });
                            Toast.fire({
                                icon: "success",
                                title: "ตั้งค่า Auto Lock สำเร็จ"
                            });

                        } catch (err) {
                            console.error("Failed to save auto lock config:", err);
                        }
                    });
                }
            }
            // ***************************************************
            
            // ********** NEW: Dark Mode Logic **********
            function applyDarkModePreference() {
                const body = document.body;
                const getEl = (id) => document.getElementById(id);
                const toggleDarkModeBtn = getEl('toggle-dark-mode');
                
                if (state.isDarkMode) {
                    body.classList.add('dark');
                    // *** NEW: กำหนด Swal.fire.defaults ให้รองรับ Dark Mode ***
                    // (ทำได้โดยไม่ต้องใช้ Swal.mixin แต่ต้องกำหนดค่าทั้งหมด)
                    Swal.fire.defaults = {
                        customClass: { 
                            popup: 'swal2-popup', // ใช้คลาสที่เรากำหนด CSS เอง
                            confirmButton: 'bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-xl shadow-lg text-lg',
                            cancelButton: 'bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-xl text-lg'
                        }, 
                        background: '#1a1a1a', 
                        color: '#e5e7eb',
                        confirmButtonColor: '#a78bfa',
                        cancelButtonColor: '#374151',
                    };

                } else {
                    body.classList.remove('dark');
                    // *** NEW: กำหนด Swal.fire.defaults กลับเป็น Light (ค่าเริ่มต้น) ***
                    Swal.fire.defaults = { 
                        customClass: { popup: '' }, 
                        background: '#fff', 
                        color: '#545454',
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                    };
                }

                // Update the state of the toggle button if it exists
                if(toggleDarkModeBtn) {
                    toggleDarkModeBtn.checked = state.isDarkMode;
                }

                // Destroy existing charts to force re-render with new colors
                if (myChart) { myChart.destroy(); myChart = null; }
                if (myExpenseByNameChart) { myExpenseByNameChart.destroy(); myExpenseByNameChart = null; }
                if (myListPageBarChart) { myListPageBarChart.destroy(); myListPageBarChart = null; }
                if (myCalendar) { 
                    myCalendar.destroy(); 
                    myCalendar = null;
                }
            }

            function setupDarkModeListener() {
                const getEl = (id) => document.getElementById(id);
                const toggleDarkModeBtn = getEl('toggle-dark-mode');
                
                if(toggleDarkModeBtn) {
                    // ตั้งค่าเริ่มต้นให้ปุ่มตาม State
                    toggleDarkModeBtn.checked = state.isDarkMode;

                    toggleDarkModeBtn.addEventListener('change', async (e) => {
                        const isChecked = e.target.checked;
                        state.isDarkMode = isChecked;
                        
                        // บันทึกลง DB
                        try {
                            await dbPut(STORE_CONFIG, { key: DARK_MODE_CONFIG_KEY, value: isChecked });
                            applyDarkModePreference(); // Apply changes immediately
                            
                            // Re-render charts as they need to change color
                            if (currentPage === 'home') renderAll();
                            if (currentPage === 'list') renderListPage();
                            if (currentPage === 'calendar') renderCalendarView();
                            
                        } catch (err) {
                            console.error("Failed to save dark mode config:", err);
                        }
                    });
                }
            }
            // ***************************************************


			function applySettingsPreferences() {
                if (!state.settingsCollapse) return;

                Object.keys(state.settingsCollapse).forEach(targetId => {
                    const content = document.getElementById(targetId);
                    
                    if (!content) return;
                    
                    // ไม่ใช้ค่าใน state.settingsCollapse ตรงๆ แต่ใช้ class ที่กำหนดไว้ใน HTML เพื่อกำหนดสถานะเริ่มต้น
                    const header = document.querySelector(`.settings-toggle-header[data-target="${targetId}"]`);
                    const icon = header ? header.querySelector('i.fa-chevron-down') : null;

                    // ตรวจสอบสถานะที่ควรจะเป็นจาก state
                    const isOpen = state.settingsCollapse[targetId];

                    if (isOpen) {
                        content.classList.remove('hidden');
                        if (icon) {
                            icon.classList.add('rotate-180');
                            icon.classList.remove('text-green-500'); 
                            icon.classList.add('text-red-500');      
                        }
                    } else {
                        content.classList.add('hidden');
                        if (icon) {
                            icon.classList.remove('rotate-180');
                            icon.classList.remove('text-red-500');   
                            icon.classList.add('text-green-500');    
                        }
                    }
                });
            }
			
            function setupEventListeners() {
			// +++ เพิ่ม Logic การย่อ/ขยายหน้าตั้งค่า +++
// +++ เพิ่ม Logic การย่อ/ขยาย พร้อมเปลี่ยนสีลูกศร +++
                document.querySelectorAll('.settings-toggle-header').forEach(header => {
                    header.addEventListener('click', async (e) => {
                        const targetId = header.getAttribute('data-target');
                        const content = document.getElementById(targetId);
                        const icon = header.querySelector('i.fa-chevron-down');

                        const isHidden = content.classList.contains('hidden');
                        const newStateOpen = isHidden; // ถ้าเดิมซ่อนอยู่ ค่าใหม่คือเปิด

                        if (newStateOpen) {
                            // เปิด: หมุนขึ้น, สีแดง
                            content.classList.remove('hidden');
                            icon.classList.add('rotate-180');
                            icon.classList.remove('text-green-500');
                            icon.classList.add('text-red-500');
                        } else {
                            // ปิด: หมุนลง, สีเขียว
                            content.classList.add('hidden');
                            icon.classList.remove('rotate-180');
                            icon.classList.remove('text-red-500');
                            icon.classList.add('text-green-500');
                        }

                        if (!state.settingsCollapse) state.settingsCollapse = {};
                        state.settingsCollapse[targetId] = newStateOpen;
                        
                        try {
                            await dbPut(STORE_CONFIG, { key: 'collapse_preferences', value: state.settingsCollapse });
                        } catch (err) {
                            console.error("Failed to save collapse settings:", err);
                        }
                    });
                });

                const getEl = (id) => document.getElementById(id);
                getEl('home-table-placeholder').innerHTML = createTransactionTableHTML('home-transaction-list-body');
                getEl('list-table-placeholder').innerHTML = createTransactionTableHTML('transaction-list-body');

                
                const mobileMenuButton = getEl('mobile-menu-button');
                const mobileMenu = getEl('mobile-menu');
                const mobileMenuIcon = getEl('mobile-menu-icon');
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                    if (mobileMenu.classList.contains('hidden')) {
                        mobileMenuIcon.classList.remove('fa-times');
                        mobileMenuIcon.classList.add('fa-bars');
                    } else {
                        mobileMenuIcon.classList.remove('fa-bars');
                        mobileMenuIcon.classList.add('fa-times');
                    }
         
                 });
                const mobileNavLinks = [
                    { id: 'nav-home-mobile', page: 'page-home' },
                    { id: 'nav-list-mobile', page: 'page-list' },
                    { id: 'nav-calendar-mobile', page: 'page-calendar' }, 
                    { id: 'nav-settings-mobile', page: 'page-settings' },
                   { id: 'nav-guide-mobile', page: 'page-guide' }
                ];
                mobileNavLinks.forEach(link => {
                    getEl(link.id).addEventListener('click', () => {
                        showPage(link.page);
                        
                       
                        mobileMenu.classList.add('hidden');
                        mobileMenuIcon.classList.remove('fa-times');
                        mobileMenuIcon.classList.add('fa-bars');
                    });
                });
                
                // **NEW: Event Listener for Mobile Home Button**
                const mobileHomeButton = getEl('mobile-home-button');
                if (mobileHomeButton) {
                    mobileHomeButton.addEventListener('click', () => {
                        showPage('page-home');
                        // Ensure mobile menu is closed when navigating home
                        mobileMenu.classList.add('hidden');
                        mobileMenuIcon.classList.remove('fa-times');
                        mobileMenuIcon.classList.add('fa-bars');
                    });
                }
            

                
                getEl('nav-home').addEventListener('click', () => showPage('page-home'));
                getEl('nav-list').addEventListener('click', () => showPage('page-list'));
                getEl('nav-calendar').addEventListener('click', () => showPage('page-calendar')); 
                getEl('nav-settings').addEventListener('click', () => showPage('page-settings'));
                getEl('nav-guide').addEventListener('click', () => showPage('page-guide'));

                getEl('view-mode-select').addEventListener('change', (e) => handleChangeViewMode(e, currentPage));
                getEl('month-picker').addEventListener('input', (e) => handleDateChange(e, currentPage));
                getEl('month-prev').addEventListener('click', () => navigateMonth(-1, currentPage));
                getEl('month-next').addEventListener('click', () => navigateMonth(1, currentPage));
                getEl('year-picker').addEventListener('input', (e) => handleDateChange(e, currentPage));
                getEl('year-prev').addEventListener('click', () => navigateYear(-1, currentPage));
                getEl('year-next').addEventListener('click', () => navigateYear(1, currentPage));
                getEl('list-chart-selector').addEventListener('change', (e) => {
                    state.listChartMode = e.target.value;
                    renderListPage();
                });
                getEl('add-tx-btn').addEventListener('click', () => openModal());
                
                const voiceBtn = getEl('voice-add-btn');
                if (voiceBtn) {
                    if (SpeechRecognition) {
                        voiceBtn.addEventListener('click', startVoiceRecognition);
                    } else {
                        
                        voiceBtn.disabled = true;
                        voiceBtn.innerHTML = '<i class="fa-solid fa-microphone-slash mr-2"></i> ไม่รองรับเสียง';
                        voiceBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400', 'hover:bg-gray-400');
                    }
                }
                

                getEl('home-filter-buttons').addEventListener('click', (e) => {
                    if (e.target.classList.contains('home-filter-btn')) {
                        handleHomeFilter(e.target);
                    }
                });
                getEl('search-input').addEventListener('input', handleSearch);

                getEl('home-items-per-page-select').addEventListener('change', (e) => {
                    state.homeItemsPerPage = parseInt(e.target.value, 10);
                    state.homeCurrentPage = 1; 
                    renderAll(); 
                });
                getEl('items-per-page-select').addEventListener('change', (e) => {
                    state.listItemsPerPage = parseInt(e.target.value, 10);
                    state.listCurrentPage = 1; 
                    renderListPage();
                });
                // *** NEW: Group By Listener ***
                getEl('list-group-by-select').addEventListener('change', (e) => {
                    state.listGroupBy = e.target.value;
                    state.listCurrentPage = 1; 
                    renderListPage();
                });
                // *** END NEW ***
                getEl('list-filter-buttons').addEventListener('click', (e) => {
                    if (e.target.classList.contains('filter-btn')) {
                        handleFilter(e.target);
                    }
                });
                
                // +++ Start Modified Event Listeners to include view-receipt-icon +++
                const handleViewReceiptClick = (btn) => {
                    const base64 = btn.dataset.base64;
                    if (base64) {
                        Swal.fire({
                            // ใช้ HTML เพื่อสร้าง Container สำหรับ Zoom
                            html: `
                                <div id="panzoom-wrapper" style="overflow: hidden; cursor: grab; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; min-height: 300px;">
                                    <img id="popup-receipt-img" src="${base64}" class="mx-auto" style="max-width: 100%; max-height: 70vh; object-fit: contain; transition: none;">
                                </div>
                                <div class="text-center text-sm text-gray-500 mt-3">
                                    <i class="fa-solid fa-magnifying-glass-plus"></i> หมุนลูกกลิ้งเมาส์ หรือ จีบนิ้วเพื่อซูม
                                </div>
                            `,
                            showCloseButton: true,
                            showConfirmButton: false,
                            width: 'auto', // ให้ขนาดปรับตามรูป
                            padding: '1em',
                            customClass: {
                                popup: state.isDarkMode ? 'swal2-popup' : '',
                            },
                            background: state.isDarkMode ? '#1a1a1a' : '#fff',
                            didOpen: () => {
                                // เริ่มการทำงานของ Panzoom เมื่อ Popup เปิด
                                const elem = document.getElementById('popup-receipt-img');
                                const wrapper = document.getElementById('panzoom-wrapper');
                                
                                if (typeof Panzoom !== 'undefined') {
                                    const panzoom = Panzoom(elem, {
                                        maxScale: 5,   // ซูมได้สูงสุด 5 เท่า
                                        minScale: 0.5, // ย่อได้เล็กสุด 0.5
                                        contain: 'outside',
                                        startScale: 1
                                    });
                                    // เปิดใช้งานการซูมด้วยลูกกลิ้งเมาส์
                                    wrapper.addEventListener('wheel', panzoom.zoomWithWheel);
                                } else {
                                    console.warn('Panzoom library not loaded');
                                }
                            }
                        });
                    }
                };

                getEl('list-table-placeholder').addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');
                    const viewReceiptBtn = e.target.closest('.view-receipt-icon'); // ดักจับปุ่มดูรูป

                    if (editBtn) handleEditClick(editBtn);
                    if (deleteBtn) handleDeleteClick(deleteBtn);
                    if (viewReceiptBtn) handleViewReceiptClick(viewReceiptBtn); // เรียกฟังก์ชันเปิดรูป
                });
                getEl('home-table-placeholder').addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');
                    const viewReceiptBtn = e.target.closest('.view-receipt-icon'); // ดักจับปุ่มดูรูป

                    if (editBtn) handleEditClick(editBtn);
                    if (deleteBtn) handleDeleteClick(deleteBtn);
                    if (viewReceiptBtn) handleViewReceiptClick(viewReceiptBtn); // เรียกฟังก์ชันเปิดรูป
                });
                // +++ End Modified Event Listeners +++
                
                getEl('home-pagination-controls').addEventListener('click', (e) => handlePaginationClick(e, 'home'));
                getEl('list-pagination-controls').addEventListener('click', (e) => handlePaginationClick(e, 'list'));
            
                getEl('modal-close-btn').addEventListener('click', closeModal);
                getEl('modal-cancel-btn').addEventListener('click', closeModal);
                getEl('transaction-form').addEventListener('submit', handleFormSubmit);
                document.querySelectorAll('input[name="tx-type"]').forEach(radio => {
                    radio.addEventListener('change', updateFormVisibility);
                });
                getEl('toggle-calc-btn').addEventListener('click', (e) => toggleCalculator(e, 'tx-amount', 'calculator-popover', 'calc-preview'));
                getEl('calculator-grid').addEventListener('click', (e) => {
                    const calcBtn = e.target.closest('.calc-btn');
                    if (calcBtn) handleCalcClick(calcBtn, 'tx-amount', 'calculator-popover', 'calc-preview');
                });
                getEl('tx-amount').addEventListener('keyup', (e) => handleCalcPreview(e.target.value, 'calc-preview'));
                
                // +++ NEW: Receipt File Listeners +++
                getEl('tx-receipt-file').addEventListener('change', handleReceiptFileChange);
                getEl('clear-receipt-btn').addEventListener('click', clearReceiptFile);
                getEl('receipt-preview').addEventListener('click', () => {
                    const src = getEl('receipt-preview').src;
                    if (src) {
                        Swal.fire({
                            imageUrl: src,
                            imageAlt: 'Receipt Image',
                            showCloseButton: true,
                            showConfirmButton: false,
                            customClass: {
                                image: 'max-w-full max-h-[80vh] object-contain',
                                popup: state.isDarkMode ? 'swal2-popup' : ''
                            }
                        });
                    }
                });
                // +++ END NEW: Receipt File Listeners +++

                
                // Account Calculator Listeners
                getEl('toggle-account-calc-btn').addEventListener('click', (e) => toggleCalculator(e, 'input-account-balance', 'account-calculator-popover', 'acc-calc-preview'));
                getEl('account-calculator-grid').addEventListener('click', (e) => {
                    const calcBtn = e.target.closest('.calc-btn');
                    if (calcBtn) handleCalcClick(calcBtn, 'input-account-balance', 'account-calculator-popover', 'acc-calc-preview');
                });
                getEl('input-account-balance').addEventListener('keyup', (e) => handleCalcPreview(e.target.value, 'acc-calc-preview'));

                getEl('toggle-edit-account-calc-btn').addEventListener('click', (e) => toggleCalculator(e, 'edit-account-balance', 'edit-account-calculator-popover', 'edit-acc-calc-preview'));
                getEl('edit-account-calculator-grid').addEventListener('click', (e) => {
                    const calcBtn = e.target.closest('.calc-btn');
                    if (calcBtn) handleCalcClick(calcBtn, 'edit-account-balance', 'edit-account-calculator-popover', 'edit-acc-calc-preview');
                });
                getEl('edit-account-balance').addEventListener('keyup', (e) => handleCalcPreview(e.target.value, 'edit-acc-calc-preview'));
                // End Account Calculator Listeners


                getEl('form-add-account').addEventListener('submit', handleAddAccount);
                getEl('list-accounts').addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-account-btn');
                    const editBtn = e.target.closest('.edit-account-btn');
                    const moveBtn = e.target.closest('.move-account-btn'); 
                    const editIconBtn = e.target.closest('.edit-icon-btn'); // *** NEW ICON BUTTON ***

                    // ********** MODIFICATION: Require password for edit/delete account **********
                    if (deleteBtn) {
                        promptForPassword('ป้อนรหัสผ่านเพื่อลบบัญชี').then(hasPermission => {
                            if (hasPermission) handleDeleteAccountClick(deleteBtn);
                        });
                    }
                    if (editBtn) {
                         promptForPassword('ป้อนรหัสผ่านเพื่อแก้ไขบัญชี').then(hasPermission => {
                            if (hasPermission) openAccountModal(editBtn.dataset.id);
                        });
                    }
                    if (editIconBtn) { // *** NEW ICON BUTTON HANDLER ***
                         promptForPassword('ป้อนรหัสผ่านเพื่อแก้ไขไอคอน').then(hasPermission => {
                            if (hasPermission) openIconModal(editIconBtn.dataset.id);
                        });
                    }
                    // **************************************************************************

                    if (moveBtn) handleMoveAccount(moveBtn.dataset.id, moveBtn.dataset.direction);
                });
                getEl('account-form-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'account-form-modal') openAccountModal(null, true);
                });
                getEl('account-modal-close-btn').addEventListener('click', () => openAccountModal(null, true));
                getEl('account-modal-cancel-btn').addEventListener('click', () => openAccountModal(null, true));
                
                // *** NEW ICON MODAL LISTENERS ***
                getEl('icon-modal-close-btn').addEventListener('click', closeIconModal);
                getEl('icon-modal-cancel-btn').addEventListener('click', closeIconModal);
                getEl('icon-search').addEventListener('input', (e) => renderIconChoices(e.target.value));

                getEl('icon-list-container').addEventListener('click', (e) => {
                    const btn = e.target.closest('.icon-select-btn');
                    if (btn) {
                        const selectedIcon = btn.dataset.icon;
                        const preview = getEl('icon-preview');
                        // Remove old icon class and add new
                        const currentClasses = preview.className.split(' ').filter(cls => !cls.startsWith('fa-'));
                        preview.className = currentClasses.join(' ') + ' fa-solid ' + selectedIcon;
                        preview.setAttribute('data-current-icon', selectedIcon);
                    }
                });

                getEl('icon-modal-save-btn').addEventListener('click', async () => {
                    const accountId = getEl('edit-icon-account-id').value;
                    const newIconName = getEl('icon-preview').getAttribute('data-current-icon');
                    const accIndex = state.accounts.findIndex(a => a.id === accountId);

                    if (accIndex === -1) {
                        Swal.fire('ข้อผิดพลาด', 'ไม่พบบัญชี', 'error');
                        return;
                    }
                    
                    const oldAccount = JSON.parse(JSON.stringify(state.accounts[accIndex]));
                    state.accounts[accIndex].iconName = newIconName;
                    
                    try {
                        await dbPut(STORE_ACCOUNTS, state.accounts[accIndex]);
                        setLastUndoAction({ type: 'account-edit', oldData: oldAccount, newData: state.accounts[accIndex] });
                        closeIconModal();
                        renderAccountSettingsList();
                        if (currentPage === 'home') renderAll();
                        Swal.fire('สำเร็จ', 'บันทึกไอคอนเรียบร้อยแล้ว', 'success');
                    } catch (err) {
                        console.error("Failed to save icon:", err);
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกไอคอนได้', 'error');
                    }
                });
                // *** END NEW ICON MODAL LISTENERS ***
               
			   // ********** MODIFICATION: Option A - Remove password check on save **********
				getEl('account-form').addEventListener('submit', (e) => {
					e.preventDefault();
					// ทางเลือก A: ยืนยันตัวตนไปแล้วตอนกดปุ่มแก้ไข ไม่ต้องถามซ้ำตอนบันทึก
					handleEditAccountSubmit(e); 
				});
				// **************************************************************************


                getEl('form-add-income-cat').addEventListener('submit', handleAddCategory);
                getEl('form-add-expense-cat').addEventListener('submit', handleAddCategory);
                getEl('list-income-cat').addEventListener('click', (e) => {
                    const btn = e.target.closest('.delete-cat-btn');
                    if (btn) handleDeleteCategory(btn);
                });
                getEl('list-expense-cat').addEventListener('click', (e) => {
                    const btn = e.target.closest('.delete-cat-btn');
                    if (btn) handleDeleteCategory(btn);
                });
                getEl('form-add-frequent-item').addEventListener('submit', handleAddFrequentItem);
                getEl('list-frequent-item').addEventListener('click', (e) => {
                    const btn = e.target.closest('.delete-item-btn');
                    if (btn) handleDeleteFrequentItem(btn);
                });
                getEl('btn-backup').addEventListener('click', handleBackup);
                getEl('btn-import').addEventListener('click', () => getEl('import-file-input').click());
                getEl('import-file-input').addEventListener('change', handleImport);
                getEl('btn-clear-all').addEventListener('click', handleClearAll);
                getEl('btn-manage-password').addEventListener('click', handleManagePassword);
                // *** NEW: Export CSV Listener ***
                getEl('btn-export-csv').addEventListener('click', handleExportCSV); 
                // *** END NEW ***
                
                // +++ NEW: Listener สำหรับปุ่ม Toggle Balance +++
                const toggleBalanceBtn = getEl('toggle-show-balance');
                if(toggleBalanceBtn) {
                    // ตั้งค่าเริ่มต้นให้ปุ่มตาม State
                    toggleBalanceBtn.checked = state.showBalanceCard;

                    toggleBalanceBtn.addEventListener('change', async (e) => {
                        const isChecked = e.target.checked;
                        state.showBalanceCard = isChecked;
                        
                        // บันทึกลง DB
                        try {
                            await dbPut(STORE_CONFIG, { key: 'showBalanceCard', value: isChecked });
                            
                            // ถ้าหน้าปัจจุบันเป็นหน้า home ให้รีเฟรชทันทีเพื่อให้เห็นผล
                            if (currentPage === 'home') {
                                renderAll();
                            }
                        } catch (err) {
                            console.error("Failed to save config:", err);
                        }
                    });
                }
                // +++++++++++++++++++++++++++++++++++++++++++++

                // +++ NEW: Listener สำหรับปุ่ม Toggle Dark Mode +++
                setupDarkModeListener();
                // +++++++++++++++++++++++++++++++++++++++++++++

                getEl('btn-undo').addEventListener('click', handleUndo);
                getEl('btn-redo').addEventListener('click', handleRedo);
                getEl('cal-prev-btn').addEventListener('click', () => {
                    if (myCalendar) myCalendar.prev(); 
                });
                getEl('cal-next-btn').addEventListener('click', () => {
                    if (myCalendar) myCalendar.next(); 
                });
                getEl('cal-year-input').addEventListener('change', (e) => {
                    if (myCalendar) {
                        const newYear = parseInt(e.target.value);
                        if (!isNaN(newYear)) {
                            const currentDate = myCalendar.getDate(); 
                            const newDate = new Date(newYear, currentDate.getMonth(), 1);
                            myCalendar.gotoDate(newDate);
                        }
                    }
                });
                // NEW: Listener สำหรับคลิกการ์ดบัญชีในหน้าแรก
                getEl('all-accounts-summary').addEventListener('click', (e) => {
                    const card = e.target.closest('.compact-account-card');
                    if (card) {
                        const accountId = card.dataset.id;
                        if (accountId) {
                            showAccountDetailModal(accountId);
                        }
                    }
                });
                
                getEl('account-detail-modal-close-btn').addEventListener('click', closeAccountDetailModal);
                
                // +++ ADDED NEW: Listener for receipt icon inside Account Detail Modal +++
                getEl('account-detail-modal-body').addEventListener('click', (e) => {
                    const viewReceiptBtn = e.target.closest('.view-receipt-icon');
                    if (viewReceiptBtn) handleViewReceiptClick(viewReceiptBtn);
                });
                // +++ END ADDED NEW +++
                
                getEl('add-tx-from-account-btn').addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if(btn && btn.dataset.accountId){
                        closeAccountDetailModal();
                        openModal(null, btn.dataset.accountId);
                    }
                });
                // +++ AUTO-FILL LISTENER +++
                getEl('tx-name').addEventListener('input', (e) => {
                    const val = e.target.value.trim();
                    const type = document.querySelector('input[name="tx-type"]:checked').value;
                    
                    // Find exact match in learned data
                    const learnedItem = state.autoCompleteList.find(item => item.name === val && item.type === type);
                    
                    const hintEl = getEl('auto-fill-hint');
                    
                    if (learnedItem) {
                        // Auto-fill Category
                        getEl('tx-category').value = learnedItem.category;
                        // Auto-fill Amount
                        getEl('tx-amount').value = learnedItem.amount;
                        hintEl.classList.remove('hidden');
                    } else {
                        hintEl.classList.add('hidden');
                    }
                    
                    // *** NEW: อัปเดตสถานะปุ่ม Favorite เมื่อชื่อเปลี่ยน ***
                    const toggleFavBtn = getEl('toggle-favorite-btn');
                    const isFav = state.frequentItems.includes(val);
                    toggleFavBtn.classList.toggle('text-yellow-500', isFav);
                    toggleFavBtn.classList.toggle('text-gray-400', !isFav);
                    // *** END NEW ***
                });
                // START MODIFICATION 2: Added event listeners for summary cards
                function handleSummaryCardClick(type) {
                    state.filterType = type;
                    state.listCurrentPage = 1;

                    document.querySelectorAll('#list-filter-buttons .filter-btn').forEach(btn => {
                        btn.classList.remove('bg-purple-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                        if (btn.dataset.filter === type) {
                            btn.classList.add('bg-purple-500', 'text-white');
                            btn.classList.remove('bg-gray-200', 'text-gray-700');
                        }
                    });
                    // We also need to set the list view mode based on the current home view mode
                    state.listViewMode = state.homeViewMode;
                    getEl('view-mode-select').value = state.homeViewMode;
                    
                    // Set list current date/month/year to match home's period view
                    if (state.homeViewMode === 'month') {
                        state.listCurrentDate = state.homeCurrentDate;
                    } else if (state.homeViewMode === 'year') {
                         state.listCurrentDate = state.homeCurrentDate;
                    }

                    updateSharedControls('list');
                    // Update list controls to reflect home's period view
                    showPage('page-list');
                    // Go to list page, which will call renderListPage()
                }

                getEl('summary-income-card').addEventListener('click', () => handleSummaryCardClick('income'));
                getEl('summary-expense-card').addEventListener('click', () => handleSummaryCardClick('expense'));
                // Balance is conceptually all transactions (income + expense + transfer)
                getEl('summary-balance-card').addEventListener('click', () => handleSummaryCardClick('all'));
                // END MODIFICATION 2
                
                // +++ NEW: Account Detail Modal Controls Listeners +++
                getEl('acc-detail-view-mode-select').addEventListener('change', handleAccountDetailViewModeChange);
                getEl('acc-detail-month-picker').addEventListener('input', (e) => handleAccountDetailDateChange(e, 'month'));
                getEl('acc-detail-month-prev').addEventListener('click', () => navigateAccountDetailPeriod(-1, 'month'));
                getEl('acc-detail-month-next').addEventListener('click', () => navigateAccountDetailPeriod(1, 'month'));
                getEl('acc-detail-year-picker').addEventListener('input', (e) => handleAccountDetailDateChange(e, 'year'));
                getEl('acc-detail-year-prev').addEventListener('click', () => navigateAccountDetailPeriod(-1, 'year'));
                getEl('acc-detail-year-next').addEventListener('click', () => navigateAccountDetailPeriod(1, 'year'));
                // +++++++++++++++++++++++++++++++++++++++++++++++++++
                
                // *** NEW: Favorite Button Listener ***
                getEl('toggle-favorite-btn').addEventListener('click', handleToggleFavorite);
                // *** END NEW ***
            }

            // ********** MODIFICATION 1: Swipe Navigation Logic **********
            function setupSwipeNavigation() {
                const mainContent = document.getElementById('page-wrapper');
                // Target the page wrapper
                let startX = 0;
                let startY = 0;
                const threshold = 75; // Minimum horizontal swipe distance
                const timeThreshold = 500;
                // Maximum time for swipe

                let startTime;
                mainContent.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        startTime = Date.now();
                    }
                }, { passive: true });
                mainContent.addEventListener('touchend', (e) => {
                    if (e.changedTouches.length === 1 && !isTransitioning) {
                        const endX = e.changedTouches[0].clientX;
                        const endY = e.changedTouches[0].clientY;
                        const endTime = Date.now();

                        const diffX = endX - startX;
                        const diffY = endY - startY;
                        const deltaTime = endTime - startTime;

                        // Check if it's a horizontal swipe (more X movement than Y) and fast enough
                        if (deltaTime < timeThreshold && Math.abs(diffX) > threshold && Math.abs(diffX) > Math.abs(diffY)) {
                            
                            const currentPageId = 'page-' + currentPage;
                            const currentPageIndex = PAGE_IDS.findIndex(id => id === currentPageId);
                            let nextPageId = null;

                            if (diffX < 0) { // Swipe Left (Next Page)
                                const nextIndex = currentPageIndex + 1;
                                if (nextIndex < PAGE_IDS.length) {
                                    nextPageId = PAGE_IDS[nextIndex];
                                }
                            } else { // Swipe Right (Previous Page)
                                const prevIndex = currentPageIndex - 1;
                                if (prevIndex >= 0) {
                                    nextPageId = PAGE_IDS[prevIndex];
                                }
                            }

                            if (nextPageId) {
                                showPage(nextPageId);
                            }
                        }
                    }
                });
            }
            // ***********************************************************


            // ********** MODIFIED: showPage with Slide Transition **********
            function showPage(pageId) {
                if (isTransitioning) return;
                resetAutoLockTimer(); // *** NEW: Reset timer on page change ***
                const pageName = pageId.replace('page-', '');
                const getEl = (id) => document.getElementById(id);
                
                const oldPageId = 'page-' + currentPage;
                const oldPageEl = getEl(oldPageId);
                const newPageEl = getEl(pageId);
                
                if (oldPageEl === newPageEl) return;
                
                isTransitioning = true;
                // --- 1. Determine Direction ---
                const oldPageIndex = PAGE_IDS.indexOf(oldPageId);
                const newPageIndex = PAGE_IDS.indexOf(pageId);
                const directionClass = (newPageIndex > oldPageIndex) ? 'slide-left' : 'slide-right';
                // slide-left = page comes in from right

                // --- 2. Setup Old Page (Exit) ---
                oldPageEl.classList.add('page-transition-exit-active', directionClass);
                oldPageEl.style.display = 'block'; 
                
                // --- 3. Setup New Page (Enter) ---
                newPageEl.style.display = 'block';
                newPageEl.classList.add('page-transition-enter', directionClass);

                // Force DOM reflow (required for CSS transitions to work)
                oldPageEl.offsetHeight;
                newPageEl.offsetHeight;

                // --- 4. Start Transition ---
                // Set initial position for the new page
                if (directionClass === 'slide-left') {
                    newPageEl.style.transform = 'translateX(100%)';
                } else {
                    newPageEl.style.transform = 'translateX(-100%)';
                }
                newPageEl.style.opacity = '0';
                // Start animation on next frame
                requestAnimationFrame(() => {
                    // Start Exit animation for old page
                    oldPageEl.classList.add('page-transition-exit-final');
                    oldPageEl.style.opacity = '0';

                    // Start Enter animation for new page
                    newPageEl.classList.add('page-transition-enter-active');
                    newPageEl.classList.remove('page-transition-enter');
                });
                // --- 5. Handle Final State ---
                setTimeout(() => {
                    // Cleanup Old Page
                    oldPageEl.style.display = 'none';
                    oldPageEl.classList.remove('page-transition-exit-active', 'page-transition-exit-final', 'slide-left', 'slide-right');
                    oldPageEl.style.transform = '';
                    oldPageEl.style.opacity = '';
                    
                    // Cleanup New Page
                    newPageEl.classList.remove('page-transition-enter-active', 'slide-left', 'slide-right');
                    newPageEl.style.position = ''; 
                    newPageEl.style.transform = '';
                    newPageEl.style.opacity = '';
                    
                    currentPage = pageName;
                    isTransitioning = false; 

                    // --- 6. Navigation Logic (Original Code) ---
                    const navButtons = [
                        getEl('nav-home'), getEl('nav-list'), getEl('nav-calendar'), 
                        getEl('nav-settings'), getEl('nav-guide')
                    ];
                    navButtons.forEach(btn => {
                        btn.classList.remove('text-purple-600');
                        btn.classList.add('text-gray-600');
                    });
                    const mobileNavButtons = {
                        'page-home': getEl('nav-home-mobile'),
                        'page-list': getEl('nav-list-mobile'),
                        'page-calendar': getEl('nav-calendar-mobile'), 
                        'page-settings': getEl('nav-settings-mobile'),
                        'page-guide': getEl('nav-guide-mobile')
                    };
                    Object.values(mobileNavButtons).forEach(btn => {
                        btn.classList.remove('text-purple-600');
                        btn.classList.add('text-gray-600');
                    });
                    const currentNavEl = getEl('nav-' + currentPage);
                    if (currentNavEl) {
                        currentNavEl.classList.add('text-purple-600');
                        currentNavEl.classList.remove('text-gray-600');
                    }
                    const currentMobileNavEl = mobileNavButtons[pageId];
                    if (currentMobileNavEl) {
                        currentMobileNavEl.classList.add('text-purple-600');
                        currentMobileNavEl.classList.remove('text-gray-600');
                    }

                    if (pageId === 'page-home') {
                        getEl('shared-controls-header').style.display = 'flex';
                        updateSharedControls('home');
                        renderAll(); 
                    } else if (pageId === 'page-list') {
                        getEl('shared-controls-header').style.display = 'flex';
                        updateSharedControls('list');
                        renderListPage();
                    
                    } else if (pageId === 'page-calendar') {
                        getEl('shared-controls-header').style.display = 'none';
                        renderCalendarView();

                    } else if (pageId === 'page-settings') {
                        getEl('shared-controls-header').style.display = 'none';
                        renderSettings();
                    } else if (pageId === 'page-guide') {
                        getEl('shared-controls-header').style.display = 'none';
                    }

                }, 200);
                // Wait for the 0.2s CSS transition to complete
            }
            // ********** END MODIFIED showPage **********


            function renderAll() {
                const visibleTransactions = getTransactionsForView('home');
                const allAccountBalances = getAccountBalances(state.transactions);

                renderSummary(visibleTransactions, allAccountBalances);
                renderAllAccountSummary(allAccountBalances);
				
				applySettingsPreferences();
                
                // +++ NEW: เช็คค่าและซ่อน/แสดงการ์ด พร้อมปรับขนาด Grid +++
                const balanceCard = document.getElementById('summary-balance-card');
                const cardsContainer = document.getElementById('summary-cards-container'); // อ้างอิง Container ที่เราเพิ่ม ID ไป

                if (state.showBalanceCard) {
                    // กรณีแสดงยอดคงเหลือ: ให้แสดง 3 ช่อง (33% ต่อใบ)
                    balanceCard.classList.remove('hidden');
                    if(cardsContainer) {
                        cardsContainer.classList.remove('grid-cols-2');
                        cardsContainer.classList.add('grid-cols-3');
                    }
                } else {
                    // กรณีซ่อนยอดคงเหลือ: ให้แสดง 2 ช่อง (50% ต่อใบ)
                    balanceCard.classList.add('hidden');
                    if(cardsContainer) {
                        cardsContainer.classList.remove('grid-cols-3');
                        cardsContainer.classList.add('grid-cols-2');
                    }
                }
                // +++++++++++++++++++++++++++++++++++

                let homeFilteredTxs = visibleTransactions;
                if (state.homeFilterType !== 'all') {
                    homeFilteredTxs = visibleTransactions.filter(tx => tx.type === state.homeFilterType);
                }
                renderTransactionList('home-transaction-list-body', homeFilteredTxs, 'home');

                renderPieChart(visibleTransactions);
                renderExpenseByNameChart(visibleTransactions);
            }

            function updateSharedControls(source) {
                const getEl = (id) => document.getElementById(id);
                const viewMode = (source === 'home') ? state.homeViewMode : state.listViewMode;
                const currentDate = (source === 'home') ? state.homeCurrentDate : state.listCurrentDate;
                if (viewMode === 'all') {
                    getEl('month-controls').classList.add('hidden');
                    getEl('month-controls').classList.remove('flex');
                    getEl('year-controls').classList.add('hidden');
                    getEl('year-controls').classList.remove('flex');
                } else if (viewMode === 'month') {
                    getEl('month-controls').classList.remove('hidden');
                    getEl('month-controls').classList.add('flex');
                    getEl('year-controls').classList.add('hidden');
                    getEl('year-controls').classList.remove('flex');
                    const monthYear = currentDate.slice(0, 7);
                    getEl('month-picker').value = monthYear;
                } else { 
                    getEl('month-controls').classList.add('hidden');
                    getEl('month-controls').classList.remove('flex');
                    getEl('year-controls').classList.remove('hidden');
                    getEl('year-controls').classList.add('flex');
                    const year = currentDate.slice(0, 4);
                    getEl('year-picker').value = year;
                }
                getEl('view-mode-select').value = viewMode;
            }

            function getAccountBalances(allTransactions) {
                const balances = {};
                for (const acc of state.accounts) {
                    balances[acc.id] = acc.initialBalance || 0;
                }

                const sortedTxs = [...allTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                for (const tx of sortedTxs) {
                    const amount = tx.amount;
                    if (tx.type === 'income') {
                        if (balances[tx.accountId] !== undefined) {
                            balances[tx.accountId] += amount;
                        }
                    } else if (tx.type === 'expense') {
                         if (balances[tx.accountId] !== undefined) {
                            balances[tx.accountId] -= amount;
                        }
                    } else if (tx.type === 'transfer') {
                        if (balances[tx.accountId] !== undefined) { 
                            balances[tx.accountId] -= amount;
                        }
                        if (balances[tx.toAccountId] !== undefined) { 
                            balances[tx.toAccountId] += amount;
                        }
                    }
                }
                return balances;
            }

            function renderSummary(transactionsForPeriod, allAccountBalances) {
                const periodTotals = transactionsForPeriod.reduce((acc, tx) => {
                    if (tx.type === 'income') {
                        acc.income += tx.amount;
                    } else if (tx.type === 'expense') {
                        acc.expense += tx.amount;
                    }
                    return acc;
                }, { income: 0, expense: 0 });

                let totalCashBalance = 0;
                const sortedAccounts = getSortedAccounts();
                for (const acc of sortedAccounts) { 
                    if (acc.type === 'cash') {
                        totalCashBalance += allAccountBalances[acc.id] || 0;
                    }
                }

                document.getElementById('total-income').textContent = formatCurrency(periodTotals.income);
                document.getElementById('total-expense').textContent = formatCurrency(periodTotals.expense);
                
                const totalBalanceEl = document.getElementById('total-balance');
                totalBalanceEl.textContent = formatCurrency(totalCashBalance);
                // ********** MODIFIED: Removed dynamic color classes **********
                // The element already has text-blue-800 hardcoded in HTML
                // *************************************************************
            }

            function renderAllAccountSummary(balances) {
                const container = document.getElementById('all-accounts-summary');
                container.innerHTML = ''; 
                
                const sortedAccounts = getSortedAccounts(); 

                if (sortedAccounts.length === 0) { 
                    container.innerHTML = `<p class="text-gray-500 col-span-full text-center">ยังไม่มีบัญชี
                    <button id="nav-settings-shortcut" class="text-purple-600 hover:underline">สร้างบัญชีใหม่ในหน้าตั้งค่า</button>
                    </p>`;
                    document.getElementById('nav-settings-shortcut').addEventListener('click', () => showPage('page-settings'));
                    return;
                }
                
                sortedAccounts.forEach(acc => { 
                    const balance = balances[acc.id] || 0;
                    let balanceClass = 'balance-zero';
                    if (balance > 0) balanceClass = 'balance-positive';
                    if (balance < 0) balanceClass = 'balance-negative';
                    
                    // *** NEW: ใช้ acc.iconName ที่เราเพิ่มเข้ามาแทน acc.icon ***
                    const currentIcon = acc.iconName || acc.icon || 'fa-wallet';

                    const cardHtml = `
                        <div class="bg-gray-50 p-3 rounded-xl shadow-md border border-gray-200 compact-account-card cursor-pointer" data-id="${acc.id}">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid ${currentIcon} text-purple-600 text-lg"></i>
                                <h3 class="text-base font-semibold text-gray-800 truncate">${escapeHTML(acc.name)}</h3>
                            </div>
                            <div class="w-full mt-2">
                                <p class="text-lg font-bold text-right ${balanceClass} truncate">${formatCurrency(balance)}</p>
                                <p class="text-xs text-gray-500 text-right">${acc.type === 'credit' ? 'บัตรเครดิต' : (acc.type === 'liability' ? 'หนี้สิน' : 'เงินสด')}</p>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', cardHtml);
                });
            }

            function renderListPage() {
                const transactions = getTransactionsForView('list');
                let filteredByType = transactions;
                if (state.filterType !== 'all') {
                    filteredByType = transactions.filter(tx => tx.type === state.filterType);
                }

                const searchTerm = state.searchTerm.toLowerCase().trim();
                let filtered = filteredByType;
                if (searchTerm) {
                    filtered = filteredByType.filter(tx => {
                        const txDate = new Date(tx.date);
                        const year = txDate.getFullYear().toString();
                        const month = (txDate.getMonth() + 1).toString().padStart(2, '0');
                        const day = txDate.getDate().toString().padStart(2, '0');
                        const thaiDate = txDate.toLocaleDateString('th-TH');
                        const amountStr = String(tx.amount);
                        
                        const fromAccount = state.accounts.find(a => a.id === tx.accountId);
                        const toAccount = state.accounts.find(a => a.id === tx.toAccountId);
                        const fromAccName = fromAccount ? fromAccount.name.toLowerCase() : '';
                        const toAccName = toAccount ? toAccount.name.toLowerCase() : '';

                        return (
                            (tx.name && tx.name.toLowerCase().includes(searchTerm)) || 
                            (tx.category && tx.category.toLowerCase().includes(searchTerm)) || 
                            (tx.desc && tx.desc.toLowerCase().includes(searchTerm)) ||
                            fromAccName.includes(searchTerm) ||
                            toAccName.includes(searchTerm) ||
                            amountStr.includes(searchTerm) ||
                            year.includes(searchTerm) || 
                            month.includes(searchTerm) ||
                            day.includes(searchTerm) || 
                            thaiDate.includes(searchTerm)
                        );
                    });
                }

                const selector = document.getElementById('list-chart-selector');
                if (selector) selector.value = state.listChartMode;
                // *** NEW: Set Group By Selector Value ***
                const groupBySelector = document.getElementById('list-group-by-select');
                if (groupBySelector) groupBySelector.value = state.listGroupBy;
                // *** END NEW ***

                renderTransactionList('transaction-list-body', filtered, 'list');
                renderListPageBarChart(filtered); 
            }

            
            function createTransactionTableHTML(tbodyId) {
                return `
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="p-2 text-lg text-gray-700 font-semibold">วันที่</th>
                            <th class="p-2 text-lg text-gray-700 font-semibold">ชื่อรายการ/บัญชี</th>
                     <th class="p-2 text-lg text-gray-700 font-semibold">หมวดหมู่</th>
                            <th class="p-2 text-lg text-gray-700 font-semibold text-right">จำนวนเงิน</th>
                            <th class="p-2 text-lg text-gray-700 font-semibold text-center">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="${tbodyId}">
                        <tr>
                            <td colspan="5" class="p-6 text-center text-gray-500">ไม่มีรายการ...</td>
                        </tr>
                    </tbody>
                </table>
                `;
            }

            function renderTransactionList(tbodyId, allTransactions, source) {
                const listBody = document.getElementById(tbodyId);
                listBody.innerHTML = ''; 
                const isListPage = (source === 'list');
                const groupBy = isListPage ? state.listGroupBy : 'none'; // ใช้ groupBy เฉพาะหน้า List

                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                // --- LOGIC: จัดกลุ่มและแสดงผลรวม (Grouped View) ---
                if (groupBy !== 'none' && isListPage) {
                    const grouped = {};
                    allTransactions.forEach(tx => {
                        let key;
                        const dateObj = new Date(tx.date);
                        if (groupBy === 'day') {
                            key = tx.date.slice(0, 10);
                        } else { // month
                            key = tx.date.slice(0, 7); 
                        }

                        if (!grouped[key]) grouped[key] = { transactions: [], income: 0, expense: 0 };
                        grouped[key].transactions.push(tx);
                        if (tx.type === 'income') grouped[key].income += tx.amount;
                        else if (tx.type === 'expense') grouped[key].expense += tx.amount;
                    });

                    const sortedGroups = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
                    let fullHtml = '';

                    sortedGroups.forEach(key => {
                        const groupData = grouped[key];
                        const netBalance = groupData.income - groupData.expense;
                        const netClass = netBalance >= 0 ? 'text-green-600' : 'text-red-600';
                        
                        let title;
                        if (groupBy === 'day') {
                            title = new Date(key).toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        } else { // month
                            const [y, m] = key.split('-');
                            title = new Date(y, m - 1).toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
                        }

                        fullHtml += `
                            <tr class="bg-gray-200 dark:bg-gray-700">
                                <td colspan="5" class="p-3 text-lg font-bold text-gray-800 dark:text-gray-100">
                                    ${title}
                                    <span class="float-right text-base font-medium">
                                        รายรับ: <span class="text-green-600">${formatCurrency(groupData.income)}</span> / 
                                        รายจ่าย: <span class="text-red-600">${formatCurrency(groupData.expense)}</span> / 
                                        สุทธิ: <span class="${netClass}">${formatCurrency(netBalance)}</span>
                                    </span>
                                </td>
                            </tr>
                        `;

                        groupData.transactions.forEach(tx => {
                            fullHtml += createTransactionRowHtml(tx); 
                        });
                    });

                    listBody.innerHTML = fullHtml;
                    document.getElementById('list-pagination-controls').innerHTML = ''; // ซ่อน Pagination
                    return;
                } 
                // --- END LOGIC: Grouped View ---
                
                // --- LOGIC: แสดงผลแบบปกติ (Pagination View) ---
                const currentPage = (source === 'home') ? state.homeCurrentPage : state.listCurrentPage;
                const itemsToShow = (source === 'list') ? state.listItemsPerPage : state.homeItemsPerPage;
                const totalPages = Math.ceil(allTransactions.length / itemsToShow);
                const startIndex = (currentPage - 1) * itemsToShow;
                const endIndex = startIndex + itemsToShow;
                const paginatedTransactions = allTransactions.slice(startIndex, endIndex);

                if (allTransactions.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-500">ไม่มีรายการ...</td></tr>';
                    renderPaginationControls(source, 0, 1);
                    return;
                }

                paginatedTransactions.forEach(tx => {
                    listBody.insertAdjacentHTML('beforeend', createTransactionRowHtml(tx));
                });

                renderPaginationControls(source, totalPages, currentPage);
                // --- END LOGIC: Pagination View ---
            }

            // *** NEW: ฟังก์ชัน Helper สำหรับสร้างแถวรายการ ***
            function createTransactionRowHtml(tx) {
                const date = new Date(tx.date);
                const formattedDate = date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
                const formattedTime = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                
                let name, category, amount, amountClass, amountSign;
                
                const fromAccount = state.accounts.find(a => a.id === tx.accountId);
                const toAccount = state.accounts.find(a => a.id === tx.toAccountId);
                const fromAccName = fromAccount ? fromAccount.name.toLowerCase() : '';
                const toAccName = toAccount ? toAccount.name.toLowerCase() : '';
                
                // +++ แก้ไข: เปลี่ยนไอคอนเป็นปุ่มที่คลิกได้ +++
                const receiptIcon = tx.receiptBase64 ? 
                    `<button type="button" class="view-receipt-icon text-purple-500 hover:text-purple-700 ml-2 z-10 relative" data-base64="${tx.receiptBase64}" title="คลิกเพื่อดูรูป">
                        <i class="fa-solid fa-receipt"></i>
                    </button>` : '';
                // +++ จบการแก้ไข +++

                if (tx.type === 'transfer') {
                    name = `<span class="font-bold text-blue-600">${escapeHTML(tx.name)}</span>${receiptIcon}`;
                    category = `<div class="text-sm">
                                    <span class="text-gray-500">จาก:</span> ${fromAccName}<br>
                                    <span class="text-gray-500">ไป:</span> ${toAccName}
                                </div>`;
                    amount = formatCurrency(tx.amount);
                    amountClass = 'text-blue-600';
                    amountSign = '';
                } else {
                    name = escapeHTML(tx.name) + receiptIcon;
                    category = `<span class="block">${escapeHTML(tx.category)}</span>
                                <span class="text-sm text-purple-600">${fromAccName}</span>`;
                    amount = formatCurrency(tx.amount);
                    
                    if (tx.type === 'income') {
                        amountClass = 'text-green-600';
                        amountSign = '+';
                    } else {
                        amountClass = 'text-red-600';
                        amountSign = '-';
                    }
                }

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-2 text-lg text-gray-700">
                            ${formattedDate} <span class="block text-base text-gray-500">${formattedTime} น.</span>
                        </td>
                        <td class="p-2 text-lg text-gray-700 font-medium break-word">
                            ${name}
                            ${tx.desc ? `<p class="text-base text-gray-500">${escapeHTML(tx.desc)}</p>` : ''}
                        </td>
                        <td class="p-2 text-lg text-gray-700 break-word">${category}</td>
                        <td class="p-2 text-lg ${amountClass} font-semibold text-right whitespace-nowrap">${amountSign}${amount}</td>
                        <td class="p-2 text-lg text-center">
                            <div class="flex flex-col md:flex-row items-center justify-center">
                                <button class="edit-btn text-blue-500 hover:text-blue-700 p-2" data-id="${tx.id}">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button class="delete-btn text-red-500 hover:text-red-700 p-2" data-id="${tx.id}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }


            function renderPieChart(transactions) {
                const summary = transactions.reduce((acc, tx) => {
                    if (tx.type === 'income') {
                        acc.income += tx.amount;
                   } else if (tx.type === 'expense') { 
                        acc.expense += tx.amount;
                    }
                    return acc;
                }, { income: 0, expense: 0 });

                // ยังคงรูปแบบที่มีตัวเลขในวงเล็บที่ Legend
                const labels = [
                    `รายรับ (${formatCurrency(summary.income)})`, 
                    `รายจ่าย (${formatCurrency(summary.expense)})`
                ];
                
                const data = [summary.income, summary.expense];
                if (myChart) {
                    myChart.destroy();
                }
                
                const noDataEl = document.getElementById('chart-no-data');
                if (summary.income === 0 && summary.expense === 0) {
                    noDataEl.textContent = 'ไม่มีข้อมูล';
                    noDataEl.classList.remove('hidden');
                    return;
                } else {
                    noDataEl.classList.add('hidden');
                }

                const ctx = document.getElementById('transaction-chart').getContext('2d');
                
                // *** ส่วนที่แก้ไข: ตรวจสอบขนาดหน้าจอและตั้งค่าสีตาม Dark Mode ***
                const isMobile = window.innerWidth < 768;
                const textColor = state.isDarkMode ? '#e5e7eb' : '#4b5563'; 

                myChart = new Chart(ctx, {
                    type: 'pie',
                    plugins: [typeof ChartDataLabels !== 'undefined' ? ChartDataLabels : {}], 
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#22c55e', '#ef4444'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                         // *** ส่วนที่แก้ไข: ตัด Padding ออกเพื่อให้กราฟใหญ่ขึ้นบนมือถือ ***
                        layout: {
                            padding: {
                                left: isMobile ? 0 : 0,
                                right: isMobile ? 0 : 0,
                                top: isMobile ? 0 : 0,
                                bottom: isMobile ? 0 : 0
                            }
                        },
                        plugins: {
                            datalabels: {
                                display: false, 
                            },
                            legend: {
                                position: 'right',
                                align: 'center', // จัดกึ่งกลางแนวตั้ง
                                // *** ส่วนที่แก้ไข: ปรับสไตล์ Legend ให้เป็นวงกลมและรองรับมือถือ ***
                                labels: {
                                    usePointStyle: true, // เปลี่ยนสี่เหลี่ยมเป็นวงกลม
                                    boxWidth: isMobile ? 8 : 10,
                                    padding: isMobile ? 6 : 10,
                                    font: {
                                        family: 'Prompt, sans-serif',
                                        size: isMobile ? 10 : 12,
                                        color: textColor // *** NEW: Text Color for Legend ***
                                    }
                                 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return ''; 
                                    },
                                    title: function(context) {
                                        return context[0].label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function renderExpenseByNameChart(transactions) {
            const expenseTransactions = transactions.filter(tx => tx.type === 'expense');
            const itemData = expenseTransactions.reduce((acc, tx) => {
                const name = tx.name || 'ไม่ระบุรายการ';
                if (!acc[name]) {
                    acc[name] = 0;
                }
                acc[name] += tx.amount;
                return acc;
            }, {});
            let sortedItems = Object.entries(itemData).map(([name, amount]) => ({ name, amount }));
            sortedItems.sort((a, b) => b.amount - a.amount);

            const TOP_N = 9;
            let labels = [];
            let data = [];
            
            if (sortedItems.length > (TOP_N + 1)) { 
                const topItems = sortedItems.slice(0, TOP_N);
                const otherItems = sortedItems.slice(TOP_N);
                
                topItems.forEach(item => {
                    labels.push(`${item.name} (${formatCurrency(item.amount)})`);
                    data.push(item.amount);
                });
                const otherAmount = otherItems.reduce((sum, item) => sum + item.amount, 0);
                labels.push(`อื่นๆ (${formatCurrency(otherAmount)})`);
                data.push(otherAmount);
            } else {
                sortedItems.forEach(item => {
                    labels.push(`${item.name} (${formatCurrency(item.amount)})`);
                    data.push(item.amount);
                });
            }

            if (myExpenseByNameChart) { 
                myExpenseByNameChart.destroy();
            }
            
            const noDataEl = document.getElementById('expense-chart-no-data');
            if (data.length === 0) {
                noDataEl.classList.remove('hidden');
                return;
            } else {
                noDataEl.classList.add('hidden');
            }

            const generateColors = (numColors) => {
                let colors = [];
                const colorPalette = ['#e11d48', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#0ea5e9', '#3b82f6', '#059669', '#0e7490', '#db2777', '#ca8a04', '#6d28d9', '#64748b'];
                for (let i = 0; i < numColors; i++) {
                    colors.push(colorPalette[i % colorPalette.length]);
                }
                return colors;
            };

            const ctx = document.getElementById('expense-category-chart').getContext('2d');
            
            // *** ส่วนที่แก้ไข: ตรวจสอบขนาดหน้าจอและตั้งค่าสีตาม Dark Mode ***
            const isMobile = window.innerWidth < 768; 
            const textColor = state.isDarkMode ? '#e5e7eb' : '#4b5563'; 

            myExpenseByNameChart = new Chart(ctx, { 
                type: 'pie', 
                plugins: [typeof ChartDataLabels !== 'undefined' ? ChartDataLabels : {}],
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: generateColors(labels.length),
                        borderWidth: 1
                    }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        // *** ส่วนที่แก้ไข: ตัด Padding ออกเพื่อให้กราฟใหญ่ขึ้นบนมือถือ ***
                        layout: {
                            padding: {
                                left: isMobile ? 0 : 0,
                                right: isMobile ? 0 : 0,
                                top: isMobile ? 0 : 0,
                                bottom: isMobile ? 0 : 0
                            }
                        },
                        plugins: {
                            datalabels: {
                                display: false, 
                            },
                            legend: {
                                position: 'right',
                                align: 'center', // จัดกึ่งกลางแนวตั้ง
                                // *** ส่วนที่แก้ไข: ปรับขนาด Font และกล่องสีตามอุปกรณ์ ***
                                labels: {
                                    usePointStyle: true, // เปลี่ยนจากสี่เหลี่ยมเป็นวงกลมเล็ก
                                    boxWidth: isMobile ? 8 : 10, // ลดขนาดกล่องสี
                                    padding: isMobile ? 6 : 10,  // ลดระยะห่างบรรทัด
                                    font: {
                                        family: 'Prompt, sans-serif',
                                        size: isMobile ? 10 : 12, // ลดขนาดตัวหนังสือบนมือถือ
                                        color: textColor // *** NEW: Text Color for Legend ***
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                         return ''; 
                                    },
                                    title: function(context) {
                                        return context[0].label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function renderListPageBarChart(transactions) {
                const ctx = document.getElementById('list-page-bar-chart').getContext('2d');
                const noDataEl = document.getElementById('list-chart-no-data');
                const titleEl = document.getElementById('list-chart-title');
                
                if (myListPageBarChart) {
                    myListPageBarChart.destroy();
                }

                let labels = [];
                let datasets = [];
                let hasData = false;
                let chartType = 'bar'; // กำหนดค่าเริ่มต้น

                // *** NEW LOGIC: TREND ANALYSIS ***
                if (state.listChartMode === 'trend_month' || state.listChartMode === 'trend_year') {
                    chartType = 'line';
                    const granularity = state.listChartMode === 'trend_month' ? 'month' : 'year';
                    titleEl.textContent = granularity === 'month' ? 'แนวโน้ม รายรับ-รายจ่าย รายเดือน' : 'แนวโน้ม รายรับ-รายจ่าย รายปี';
                    
                    const trendData = transactions.reduce((acc, tx) => {
                        const dateObj = new Date(tx.date);
                        let key;
                        if (granularity === 'month') {
                            key = dateObj.getFullYear() + '-' + (dateObj.getMonth() + 1).toString().padStart(2, '0');
                        } else { // year
                            key = dateObj.getFullYear().toString();
                        }

                        if (!acc[key]) acc[key] = { income: 0, expense: 0 };
                        
                        if (tx.type === 'income') acc[key].income += tx.amount;
                        else if (tx.type === 'expense') acc[key].expense += tx.amount;
                        
                        return acc;
                    }, {});
                    
                    const sortedKeys = Object.keys(trendData).sort();
                    if (sortedKeys.length > 0) {
                        hasData = true;
                        labels = sortedKeys.map(key => {
                            if (granularity === 'month') {
                                const [y, m] = key.split('-');
                                return new Date(y, m - 1).toLocaleDateString('th-TH', { month: 'short', year: 'numeric' });
                            }
                            return key; // Year
                        });

                        datasets = [
                            {
                                label: 'รายรับ',
                                data: sortedKeys.map(key => trendData[key].income),
                                borderColor: '#22c55e', // Green
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 5
                            },
                            {
                                label: 'รายจ่าย',
                                data: sortedKeys.map(key => trendData[key].expense),
                                borderColor: '#ef4444', // Red
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 5
                            }
                        ];
                        
                        // ถ้าเลือกโหมด Monthly Trend แต่ข้อมูลครอบคลุมหลายปี ให้แสดงผลที่ละปี
                        if (granularity === 'month' && sortedKeys.length > 12) {
                            titleEl.textContent += ' (ข้อมูลย้อนหลัง 12 เดือน)';
                            // ตัดข้อมูลให้แสดงผลแค่ 12 เดือนล่าสุด
                            const recentKeys = sortedKeys.slice(-12);
                            labels = recentKeys.map(key => {
                                const [y, m] = key.split('-');
                                return new Date(y, m - 1).toLocaleDateString('th-TH', { month: 'short', year: 'numeric' });
                            });
                            datasets[0].data = recentKeys.map(key => trendData[key].income);
                            datasets[1].data = recentKeys.map(key => trendData[key].expense);
                        }
                    }
                } 
                // *** END NEW LOGIC ***
                
                // *** OLD LOGIC: ITEMS, SUMMARY, ACCOUNTS (Bar Chart) ***
                else if (state.listChartMode === 'items') {
                    titleEl.textContent = 'สรุปแยกตามชื่อรายการ';
                    const itemData = transactions.reduce((acc, tx) => {
                        if (tx.type === 'transfer') return acc;
                        const name = tx.name;
                        if (!acc[name]) acc[name] = { income: 0, expense: 0 };
                        if (tx.type === 'income') acc[name].income += tx.amount;
                        else acc[name].expense += tx.amount;
                        return acc;
                    }, {});
                    const processedData = Object.keys(itemData).map(name => ({
                        name: name,
                        income: itemData[name].income,
                        expense: itemData[name].expense,
                        total: itemData[name].income + itemData[name].expense
                    }));
                    processedData.sort((a, b) => b.total - a.total);
                    const topData = processedData.slice(0, 15);
                    if (topData.length > 0) {
                        hasData = true;
                        labels = topData.map(d => d.name);
                        datasets = [
                            {
                                label: 'รายรับ',
                                data: topData.map(d => d.income),
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'รายจ่าย',
                                data: topData.map(d => d.expense),
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1
                            }
                        ];
                    }
                } 
                else if (state.listChartMode === 'summary') {
                    titleEl.textContent = 'เปรียบเทียบ รายรับ vs รายจ่าย';
                    let totalIncome = 0;
                    let totalExpense = 0;
                    transactions.forEach(tx => {
                        if (tx.type === 'income') totalIncome += tx.amount;
                        if (tx.type === 'expense') totalExpense += tx.amount;
                    });
                    if (totalIncome > 0 || totalExpense > 0) {
                        hasData = true;
                        labels = ['สรุปยอดรวม'];
                        datasets = [
                            {
                                label: 'รายรับ',
                                data: [totalIncome],
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 1,
                                barPercentage: 0.5
                            },
                            {
                                label: 'รายจ่าย',
                                data: [totalExpense],
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1,
                                barPercentage: 0.5
                            }
                        ];
                    }
                }
                else if (state.listChartMode === 'accounts') {
                    titleEl.textContent = 'ยอดเงินคงเหลือแต่ละบัญชี (ปัจจุบัน)';
                    const allBalances = getAccountBalances(state.transactions);
                    const sortedAccounts = getSortedAccounts();

                    if (sortedAccounts.length > 0) {
                        hasData = true;
                        labels = sortedAccounts.map(acc => acc.name);
                        const balanceData = sortedAccounts.map(acc => allBalances[acc.id] || 0);
                        const bgColors = balanceData.map(val => val >= 0 ? 'rgba(59, 130, 246, 0.7)' : 'rgba(239, 68, 68, 0.7)');
                        const borderColors = balanceData.map(val => val >= 0 ? 'rgba(59, 130, 246, 1)' : 'rgba(239, 68, 68, 1)');
                        datasets = [{
                            label: 'ยอดคงเหลือ',
                            data: balanceData,
                            backgroundColor: bgColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }];
                    }
                }
                // *** END OLD LOGIC ***

                if (!hasData) {
                    noDataEl.classList.remove('hidden');
                    return;
                } else {
                    noDataEl.classList.add('hidden');
                }
                
                // *** ส่วนที่แก้ไข: ตั้งค่าสีตาม Dark Mode ***
                const tickColor = state.isDarkMode ? '#9ca3af' : '#6b7280';
                const gridColor = state.isDarkMode ? '#374151' : '#e5e7eb';
                const labelColor = state.isDarkMode ? '#e5e7eb' : '#4b5563';

                myListPageBarChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: state.listChartMode === 'accounts' ? 'y' : 'x',
                        plugins: {
                            legend: {
                                display: state.listChartMode !== 'accounts',
                                labels: { 
                                    font: { family: 'Prompt, sans-serif', color: labelColor }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        const value = chartType === 'line' ? context.parsed.y : (state.listChartMode === 'accounts' ? context.parsed.x : context.parsed.y);
                                        if (value !== null) {
                                            label += formatCurrency(value);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { font: { family: 'Prompt, sans-serif', color: tickColor } },
                                grid: { color: gridColor },
                                ...(state.listChartMode === 'accounts' && {
                                    ticks: {
                                        callback: function(value) { return formatCurrency(value); },
                                        font: { family: 'Prompt, sans-serif', color: tickColor }
                                    }
                                })
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { font: { family: 'Prompt, sans-serif', color: tickColor } },
                                grid: { color: gridColor },
                                ...(state.listChartMode !== 'accounts' && {
                                    ticks: {
                                        callback: function(value) { return formatCurrency(value);
},
                                        font: { family: 'Prompt, sans-serif', color: tickColor }
                                    }
                                })
                            }
                        }
                    }
                });
            }

            function renderCalendarView() {
                try {
                    const calendarEl = document.getElementById('calendar-container');
                    const yearInput = document.getElementById('cal-year-input'); 
                    
                    if (!calendarEl || !yearInput) return;

                    // ... (โค้ดส่วนคำนวณ events เหมือนเดิม) ...
                    const dailyTotals = {};
                    state.transactions.forEach(tx => {
                        const dateStr = tx.date.slice(0, 10); 
                        if (!dailyTotals[dateStr]) dailyTotals[dateStr] = { income: 0, expense: 0, transfer: 0 }; 
                        if (tx.type === 'expense') dailyTotals[dateStr].expense += tx.amount;
                        else if (tx.type === 'income') dailyTotals[dateStr].income += tx.amount;
                        else if (tx.type === 'transfer') dailyTotals[dateStr].transfer += tx.amount;
                    });
                    const calendarEvents = [];
                    Object.keys(dailyTotals).forEach(date => {
                        const totals = dailyTotals[date];
                        if (totals.income > 0) calendarEvents.push({ id: date+'-inc', title: '+฿'+formatCurrency(totals.income).replace(/[^\d.,-]/g,''), start: date, allDay: true, color: '#22c55e', className: 'cursor-pointer' });
                        if (totals.expense > 0) calendarEvents.push({ id: date+'-exp', title: '-฿'+formatCurrency(totals.expense).replace(/[^\d.,-]/g,''), start: date, allDay: true, color: '#ef4444', className: 'cursor-pointer' });
                        if (totals.transfer > 0) calendarEvents.push({ id: date+'-trf', title: '⇄฿'+formatCurrency(totals.transfer).replace(/[^\d.,-]/g,''), start: date, allDay: true, color: '#3b82f6', className: 'cursor-pointer' });
                    });

                    if (myCalendar) myCalendar.destroy();
                    
                    const initialDate = state.calendarCurrentDate || new Date().toISOString().slice(0, 10);
                    yearInput.value = new Date(initialDate).getFullYear();
                    myCalendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        initialDate: initialDate,
                        locale: 'th',
                        buttonText: { today: 'วันนี้' },
                        headerToolbar: { left: 'today', center: 'title', right: '' },
                        showNonCurrentDates: false, 
                        events: calendarEvents,
                        height: 'auto', // สำคัญ: กำหนดให้ความสูงเป็นไปตามเนื้อหาเพื่อลบ Scrollbar
                        fixedWeekCount: false,
                        // --- ส่วนที่เพิ่มเข้ามา ---
                        dateClick: function(info) {
                            // เมื่อคลิกที่ช่องวันที่ (ไม่ว่าจะว่างหรือไม่ว่าง)
                            showDailyDetails(info.dateStr);
                        },
                        // ----------------------

                        eventClick: function(info) {
                            // เมื่อคลิกที่แถบสีๆ (Event)
                            showDailyDetails(info.event.startStr);
                        },
                        datesSet: function(dateInfo) {
                            // ... (เหมือนเดิม) ...
                            const currentFocusDate = myCalendar.getDate();
                            const yyyy = currentFocusDate.getFullYear();
                            const mm = (currentFocusDate.getMonth() + 1).toString().padStart(2, '0');
                            const yyyyMM = `${yyyy}-${mm}`;

                            if (parseInt(yearInput.value) !== yyyy) {
                                yearInput.value = yyyy;
                            }
                            state.calendarCurrentDate = `${yyyyMM}-01`;
                        },
                        dayCellClassNames: 'hover:bg-purple-50 cursor-pointer', // เพิ่ม cursor-pointer เพื่อให้รู้ว่ากดได้
                        eventClassNames: 'hover:opacity-80'
                    });
                    myCalendar.render();
                } catch (e) {
                    console.error("Error rendering calendar:", e);
                    document.getElementById('calendar-container').innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการแสดงผลปฏิทิน</p>';
                }
            }

function showDailyDetails(date) {
                const txsOnDay = state.transactions.filter(tx => 
                    tx.date.slice(0, 10) === date
                );
                txsOnDay.sort((a, b) => new Date(b.date) - new Date(a.date));

                // สร้างส่วนหัวที่มีปุ่มเพิ่มรายการ
                let headerHtml = `
                    <div class="flex justify-between items-center mb-4 w-full">
                        <h3 class="text-xl font-bold text-gray-800">สรุปวันที่ ${new Date(date).toLocaleDateString('th-TH', {day: 'numeric', month: 'long', year: 'numeric'})}</h3>
                    </div>
                    <div class="flex justify-end w-full mb-2">
                         <button id="cal-add-tx-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-xl shadow-md transition duration-300 flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-plus"></i> เพิ่มธุรกรรมใหม่
                         </button>
                    </div>
                `;

                let html = '<ul class="text-left space-y-3 mt-2 max-h-60 overflow-y-auto pr-2">';
                let totalIncome = 0;
                let totalExpense = 0;
                let totalTransfer = 0;
                
                if (txsOnDay.length === 0) {
                     html = '<p class="text-center text-gray-500 mt-8 mb-8">ไม่มีรายการในวันนี้</p>';
                } else {
                    txsOnDay.forEach(tx => {
                        let txHtml = '';
                        // ... (Logic การแสดงผลรายการเหมือนเดิม) ...
                        
                        // +++ NEW: Receipt Icon for Daily Detail +++
                        const receiptIconHtml = tx.receiptBase64 ? 
                            `<button type="button" class="view-receipt-btn text-purple-500 hover:text-purple-700 ml-2" data-base64="${tx.receiptBase64}">
                                <i class="fa-solid fa-receipt"></i>
                            </button>` : '';
                        // +++ END NEW +++

                        if (tx.type === 'income') {
                            totalIncome += tx.amount;
                            const account = state.accounts.find(a => a.id === tx.accountId);
                            txHtml = `
                                <div class="flex justify-between items-center">
                                   <span class="font-medium text-gray-800">${escapeHTML(tx.name)}${receiptIconHtml}</span>
                                   <span class="font-bold text-green-600 whitespace-nowrap ml-4">+${formatCurrency(tx.amount)}</span>
                                </div>
                                <div class="text-sm text-gray-500">${escapeHTML(tx.category)} (${escapeHTML(account ? account.name : 'N/A')})</div>
                            `;
                        } else if (tx.type === 'expense') {
                            totalExpense += tx.amount;
                            const account = state.accounts.find(a => a.id === tx.accountId);
                            txHtml = `
                                <div class="flex justify-between items-center">
                                   <span class="font-medium text-gray-800">${escapeHTML(tx.name)}${receiptIconHtml}</span>
                                   <span class="font-bold text-red-600 whitespace-nowrap ml-4">-${formatCurrency(tx.amount)}</span>
                                </div>
                                <div class="text-sm text-gray-500">${escapeHTML(tx.category)} (${escapeHTML(account ? account.name : 'N/A')})</div>
                            `;
                        } else if (tx.type === 'transfer') {
                            totalTransfer += tx.amount;
                            const fromAccount = state.accounts.find(a => a.id === tx.accountId);
                            const toAccount = state.accounts.find(a => a.id === tx.toAccountId);
                            txHtml = `
                                <div class="flex justify-between items-center">
                                   <span class="font-medium text-blue-700">โอนย้าย${receiptIconHtml}</span>
                                   <span class="font-bold text-blue-600 whitespace-nowrap ml-4">⇄${formatCurrency(tx.amount)}</span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    จาก: ${escapeHTML(fromAccount ? fromAccount.name : 'N/A')}<br>
                                    ไป: ${escapeHTML(toAccount ? toAccount.name : 'N/A')}
                                </div>
                            `;
                        }
                        
                        if (txHtml) {
                            html += `<li class="border-b border-gray-200 pb-2">${txHtml}</li>`;
                        }
                    });
                    html += '</ul>';
                }

                const netTotal = totalIncome - totalExpense;
                let netClass = 'text-gray-700';
                if (netTotal > 0) netClass = 'text-green-700';
                if (netTotal < 0) netClass = 'text-red-700';

                Swal.fire({
                    title: '', // ปิด title เดิมของ Swal เพราะเราสร้าง header เองแล้ว
                    html: headerHtml + html, // รวม Header ที่มีปุ่ม + List รายการ
                    footer: `
                        <div class="grid grid-cols-4 gap-2 text-center text-lg">
                            <div>
                                <div class="text-sm font-semibold text-green-700">รายรับ</div>
                                <div class="font-bold text-green-600">${formatCurrency(totalIncome)}</div>
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-red-700">รายจ่าย</div>
                                <div class="font-bold text-red-600">${formatCurrency(totalExpense)}</div>
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-blue-700">โอนย้าย</div>
                                <div class="font-bold text-blue-600">${formatCurrency(totalTransfer)}</div>
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-gray-800">คงเหลือ</div>
                                <div class="font-bold ${netClass}">${formatCurrency(netTotal)}</div>
                            </div>
                        </div>
                    `,
                    width: 600,
                    showConfirmButton: false, // ซ่อนปุ่ม OK ด้านล่างเพื่อให้กดปิดที่ x หรือ พื้นที่ว่างแทน (หรือจะเปิดไว้ก็ได้)
                    showCloseButton: true,
                    didOpen: () => {
                        // ผูก Event Listener ให้กับปุ่ม "เพิ่มธุรกรรม" หลังจาก Swal แสดงผลแล้ว
                        const btn = document.getElementById('cal-add-tx-btn');
                        if(btn) {
                            btn.addEventListener('click', () => {
                                Swal.close(); // ปิดหน้าต่างสรุปก่อน
                                openModal(null, null, date); // เปิดฟอร์มเพิ่มรายการ โดยส่งวันที่ไปด้วย
                            });
                        }
                        
                        // +++ NEW: Event Listener สำหรับปุ่ม View Receipt +++
                        document.querySelectorAll('.view-receipt-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const base64 = e.currentTarget.dataset.base64;
                                if (base64) {
                                    Swal.fire({
                                        imageUrl: base64,
                                        imageAlt: 'Receipt Image',
                                        showCloseButton: true,
                                        showConfirmButton: false,
                                        customClass: {
                                            image: 'max-w-full max-h-[80vh] object-contain',
                                            popup: state.isDarkMode ? 'swal2-popup' : ''
                                        }
                                    });
                                }
                            });
                        });
                        // +++ END NEW +++
                    }
                });
            }

            function renderSettings() {
                const getEl = (id) => document.getElementById(id);
                // +++ NEW: อัปเดตสถานะปุ่ม Toggle Balance +++
                const toggleBalanceBtn = getEl('toggle-show-balance');
                if (toggleBalanceBtn) {
                    toggleBalanceBtn.checked = state.showBalanceCard;
                }

                // +++ NEW: อัปเดตสถานะ Dropdown Auto Lock ให้ตรงกับ State ปัจจุบัน +++
                const autoLockSelect = getEl('auto-lock-select');
                if (autoLockSelect) {
                    autoLockSelect.value = state.autoLockTimeout.toString();
                }
                
                // +++ NEW: อัปเดตสถานะปุ่ม Toggle Dark Mode +++
                const toggleDarkModeBtn = getEl('toggle-dark-mode');
                if (toggleDarkModeBtn) {
                    toggleDarkModeBtn.checked = state.isDarkMode;
                }
                // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

                renderAccountSettingsList();
                const incomeList = getEl('list-income-cat');
                incomeList.innerHTML = '';
                if (state.categories.income.length > 0) {
                    state.categories.income.forEach(cat => {
                        const li = `
                            <li class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                                <span class="text-lg text-gray-700">${escapeHTML(cat)}</span>
                                <button class="delete-cat-btn text-red-500 hover:text-red-700 p-3" data-type="income" data-name="${escapeHTML(cat)}">
                                    <i class="fa-solid fa-trash-alt"></i>
                                </button>
                            </li>`;
                         incomeList.insertAdjacentHTML('beforeend', li);
                    });
                } else {
                    incomeList.innerHTML = '<li class="text-gray-500 text-center p-2">ไม่มีหมวดหมู่รายรับ</li>';
                }

                const expenseList = getEl('list-expense-cat');
                expenseList.innerHTML = '';
                if (state.categories.expense.length > 0) {
                    state.categories.expense.forEach(cat => {
                        const li = `
                            <li class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                                <span class="text-lg text-gray-700">${escapeHTML(cat)}</span>
                                <button class="delete-cat-btn text-red-500 hover:text-red-700 p-3" data-type="expense" data-name="${escapeHTML(cat)}">
                                    <i class="fa-solid fa-trash-alt"></i>
                                </button>
                            </li>`;
                         expenseList.insertAdjacentHTML('beforeend', li);
                    });
                } else {
                    expenseList.innerHTML = '<li class="text-gray-500 text-center p-2">ไม่มีหมวดหมู่รายจ่าย</li>';
                }
                
                const frequentList = getEl('list-frequent-item');
                const datalist = getEl('frequent-items-datalist');
                frequentList.innerHTML = '';
                datalist.innerHTML = '';
                // Render Manual Frequent Items
                if (state.frequentItems.length > 0) {
                    state.frequentItems.forEach(item => {
                        const li = `
                            <li class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                                 <span class="text-lg text-gray-700">${escapeHTML(item)}</span>
                                <button class="delete-item-btn text-red-500 hover:text-red-700 p-3" data-name="${escapeHTML(item)}">
                                    <i class="fa-solid fa-trash-alt"></i>
                                 </button>
                            </li>`;
                        frequentList.insertAdjacentHTML('beforeend', li);
                        datalist.insertAdjacentHTML('beforeend', `<option value="${escapeHTML(item)}"></option>`);
                    });
                } else {
                    frequentList.innerHTML = '<li class="text-gray-500 text-center p-2">ไม่มีรายการที่ใช้บ่อย</li>';
                }

                // +++ Append Auto-learned items to Datalist (but not to the Manual list view) +++
                if (state.autoCompleteList && state.autoCompleteList.length > 0) {
                     state.autoCompleteList.forEach(item => {
                         // Check if not already added from frequentItems
                         if (!state.frequentItems.includes(item.name)) {
                             datalist.insertAdjacentHTML('beforeend', `<option value="${escapeHTML(item.name)}"></option>`);
                         }
                    });
                }
				
				applySettingsPreferences();
            }
            
            function renderAccountSettingsList() {
                const listEl = document.getElementById('list-accounts');
                listEl.innerHTML = '';
                
                const allBalances = getAccountBalances(state.transactions);
                const sortedAccounts = getSortedAccounts();
                if (sortedAccounts.length === 0) {
                    listEl.innerHTML = '<li class="text-gray-500 text-center p-2">ไม่มีบัญชี</li>';
                    return;
                }
                
                sortedAccounts.forEach((acc, index) => { 
                    const balance = allBalances[acc.id] || 0;
                    let balanceClass = 'balance-zero';
                    if (balance > 0) balanceClass = 'balance-positive';
                    if (balance < 0) balanceClass = 'balance-negative';
                    
                    // *** NEW: ใช้ iconName ที่เราเพิ่มเข้ามาแทน acc.icon ***
                    const currentIcon = acc.iconName || acc.icon || 'fa-wallet';
                    
                    const isFirst = (index === 0);
                    const isLast = (index === sortedAccounts.length - 1);

                    const li = `
                        <li class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid ${currentIcon} text-purple-600 text-xl"></i>
                                <div>
                                    <span class="text-lg text-gray-700 font-medium">${escapeHTML(acc.name)}</span>
                                    <span class="block text-sm text-gray-500 ${balanceClass} font-bold">ยอดปัจจุบัน: ${formatCurrency(balance)}</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex items-center">
                                <button class="edit-icon-btn text-purple-500 hover:text-purple-700 p-3" data-id="${acc.id}">
                                    <i class="fa-solid fa-paintbrush"></i>
                                </button>
                                <button 
                                    class="move-account-btn text-gray-500 hover:text-purple-600 p-3 ${isFirst ? 'opacity-20 cursor-not-allowed' : ''}" 
                                    data-id="${acc.id}" data-direction="up" ${isFirst ? 'disabled' : ''}>
                                    <i class="fa-solid fa-arrow-up"></i>
                                </button>
                                <button 
                                    class="move-account-btn text-gray-500 hover:text-purple-600 p-3 ${isLast ? 'opacity-20 cursor-not-allowed' : ''}" 
                                    data-id="${acc.id}" data-direction="down" ${isLast ? 'disabled' : ''}>
                                    <i class="fa-solid fa-arrow-down"></i>
                                </button>
                                
                                <button class="edit-account-btn text-blue-500 hover:text-blue-700 p-3" data-id="${acc.id}">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button class="delete-account-btn text-red-500 hover:text-red-700 p-3" data-id="${acc.id}">
                                    <i class="fa-solid fa-trash-alt"></i>
                                </button>
                            </div>
                        </li>
                    `;
                    listEl.insertAdjacentHTML('beforeend', li);
                });
            }
            
            function renderPaginationControls(source, totalPages, currentPage) {
                const controlsEl = document.getElementById(source === 'home' ? 'home-pagination-controls' : 'list-pagination-controls');
                controlsEl.innerHTML = '';

                if (totalPages <= 1) {
                    return;
                }

                let html = '';
                const prevDisabled = currentPage === 1;
                html += `<button class="px-4 py-2 rounded-lg font-medium border border-gray-300 shadow-sm ${prevDisabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-purple-100 text-purple-600'}" 
                            data-page="${currentPage - 1}" ${prevDisabled ? 'disabled' : ''}>
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>`;
                html += `<span class="px-4 py-2 text-sm text-gray-700">
                            หน้า ${currentPage} / ${totalPages}
                        </span>`;
                const nextDisabled = currentPage === totalPages;
                html += `<button class="px-4 py-2 rounded-lg font-medium border border-gray-300 shadow-sm ${nextDisabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-purple-100 text-purple-600'}" 
                            data-page="${currentPage + 1}" ${nextDisabled ? 'disabled' : ''}>
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>`;
                controlsEl.innerHTML = html;
            }

            // ********** MODIFICATION 2: Calculator Functions Refactored **********
            function toggleCalculator(e, inputId, popoverId, previewId) {
                e.stopPropagation();
                // Prevent conflicts
                const popover = document.getElementById(popoverId);
                popover.classList.toggle('hidden');
                if (!popover.classList.contains('hidden')) {
                    handleCalcPreview(document.getElementById(inputId).value, previewId);
                }
            }

            // +++ NEW: Receipt Handling Functions +++
            function handleReceiptFileChange(e) {
                const file = e.target.files[0];
                const getEl = (id) => document.getElementById(id);
                
                clearReceiptFile(true); // Clear only state/preview, keep file input content for now
                
                if (!file) return;

                if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    Swal.fire('ขนาดใหญ่เกินไป', `ไฟล์ต้องมีขนาดไม่เกิน ${MAX_FILE_SIZE_MB} MB`, 'error');
                    e.target.value = null; // Clear file input
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    currentReceiptBase64 = e.target.result;
                    getEl('receipt-preview').src = currentReceiptBase64;
                    getEl('receipt-preview-container').classList.remove('hidden');
                    getEl('clear-receipt-btn').classList.remove('hidden');
                };
                reader.onerror = (error) => {
                    console.error("Error reading file:", error);
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถอ่านไฟล์ได้', 'error');
                };
                reader.readAsDataURL(file);
            }

            function clearReceiptFile(onlyState = false) {
                const getEl = (id) => document.getElementById(id);
                currentReceiptBase64 = null;
                getEl('receipt-preview').src = '';
                getEl('receipt-preview-container').classList.add('hidden');
                getEl('clear-receipt-btn').classList.add('hidden');
                
                if (!onlyState) {
                    getEl('tx-receipt-file').value = null; // Clear file input content
                }
            }
            // +++ END NEW: Receipt Handling Functions +++

            // แก้ไขฟังก์ชัน openModal ให้รับ defaultDate เพิ่ม
            function openModal(txId = null, defaultAccountId = null, defaultDate = null) {
                const form = document.getElementById('transaction-form');
                form.reset();
                document.getElementById('calc-preview').textContent = '';
                document.getElementById('calculator-popover').classList.add('hidden');
                document.getElementById('auto-fill-hint').classList.add('hidden'); 
                
                // Hide other popovers when opening tx modal
                document.getElementById('account-calculator-popover').classList.add('hidden');
                document.getElementById('edit-account-calculator-popover').classList.add('hidden');
                
                clearReceiptFile(); // +++ NEW: Clear receipt state on open +++
                
                const getEl = (id) => document.getElementById(id);
                
                populateAccountDropdowns('tx-account');
                populateAccountDropdowns('tx-account-from', acc => acc.type === 'cash'); 
                populateAccountDropdowns('tx-account-to');

                const toggleFavBtn = getEl('toggle-favorite-btn'); // *** NEW ***

                const setFavoriteState = (isFav) => { // *** NEW: Helper Function ***
                    toggleFavBtn.classList.toggle('text-yellow-500', isFav);
                    toggleFavBtn.classList.toggle('text-gray-400', !isFav);
                };

                if (txId) {
                    const tx = state.transactions.find(t => t.id === txId);
                    if (!tx) return;
                    
                    getEl('modal-title').textContent = 'แก้ไขรายการ';
                    getEl('tx-id').value = tx.id;
                    document.querySelector(`input[name="tx-type"][value="${tx.type}"]`).checked = true;
                    getEl('tx-amount').value = tx.amount;
                    getEl('tx-date').value = tx.date.slice(0, 16);
                    getEl('tx-desc').value = tx.desc;
                    getEl('tx-name').value = tx.name; 
                    
                    // *** NEW: Load receipt data ***
                    if (tx.receiptBase64) {
                        currentReceiptBase64 = tx.receiptBase64;
                        getEl('receipt-preview').src = currentReceiptBase64;
                        getEl('receipt-preview-container').classList.remove('hidden');
                        getEl('clear-receipt-btn').classList.remove('hidden');
                    }
                    // *** END NEW ***

                    if(tx.type === 'transfer') {
                        getEl('tx-account-from').value = tx.accountId;
                        getEl('tx-account-to').value = tx.toAccountId;
                    } else {
                        updateCategoryDropdown(tx.type); 
                        getEl('tx-category').value = tx.category; 
                        getEl('tx-account').value = tx.accountId;
                    }
                    
                    // *** NEW: ตั้งค่าสถานะ Favorite ใน Edit Mode ***
                    const isFav = state.frequentItems.includes(tx.name);
                    setFavoriteState(isFav);
                    
                } else {
                    getEl('modal-title').textContent = 'เพิ่มรายการใหม่';
                    getEl('tx-id').value = '';
                    getEl('tx-name').value = ''; 
                    document.getElementById('tx-type-expense').checked = true;
                    updateCategoryDropdown('expense');
                    
                    setFavoriteState(false); // เริ่มต้นด้วยสถานะ Unfavorite

                    // --- Logic จัดการวันที่เริ่มต้น ---
                    const now = new Date();
                    
                    if (defaultDate) {
                        // ถ้าส่งวันที่มาจากปฏิทิน (format YYYY-MM-DD) ให้ใช้วันที่นั้น + เวลาปัจจุบัน
                        const hh = now.getHours().toString().padStart(2, '0');
                        const min = now.getMinutes().toString().padStart(2, '0');
                        getEl('tx-date').value = `${defaultDate}T${hh}:${min}`;
                    } else {
                        // ถ้าไม่มี ให้ใช้เวลาปัจจุบันทั้งหมด
                        const yyyy = now.getFullYear();
                        const mm = (now.getMonth() + 1).toString().padStart(2, '0');
                        const dd = now.getDate().toString().padStart(2, '0');
                        const hh = now.getHours().toString().padStart(2, '0');
                        const min = now.getMinutes().toString().padStart(2, '0');
                        getEl('tx-date').value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
                    }
                    // ------------------------------

                    getEl('tx-amount').value = '';
                    
                    if(defaultAccountId){
                         const acc = state.accounts.find(a => a.id === defaultAccountId);
                        if(acc){
                             if(acc.type === 'credit' || acc.type === 'liability'){
                                 document.getElementById('tx-type-expense').checked = true;
                                updateCategoryDropdown('expense');
                             }
                             getEl('tx-account').value = defaultAccountId;
                        }
                    }
                }
                
                updateFormVisibility();
                getEl('form-modal').classList.remove('hidden');
            }

            function closeModal() {
                document.getElementById('form-modal').classList.add('hidden');
                document.getElementById('transaction-form').reset();
                document.getElementById('calc-preview').textContent = ''; 
                document.getElementById('calculator-popover').classList.add('hidden');
                clearReceiptFile(); // +++ NEW: Clear receipt state on close +++
            }

            function openAccountModal(accountId = null, closeOnly = false) {
                const modal = document.getElementById('account-form-modal');
                if (closeOnly) {
                    modal.classList.add('hidden');
                    document.getElementById('edit-account-calculator-popover').classList.add('hidden');
                    return;
                }
                
                document.getElementById('account-calculator-popover').classList.add('hidden');
                // Hide other popovers

                const form = document.getElementById('account-form');
                form.reset();
                const getEl = (id) => document.getElementById(id);
                
                const acc = state.accounts.find(a => a.id === accountId);
                if (!acc) {
                    Swal.fire('ข้อผิดพลาด', 'ไม่พบบัญชีที่ต้องการแก้ไข', 'error');
                    return;
                }
                
                getEl('account-modal-title').textContent = 'แก้ไขบัญชี';
                getEl('edit-account-id').value = acc.id;
                getEl('edit-account-name').value = acc.name;
                getEl('edit-account-type').value = acc.type;
                getEl('edit-account-balance').value = acc.initialBalance;
                getEl('edit-acc-calc-preview').textContent = ''; 
                getEl('edit-account-calculator-popover').classList.add('hidden');

                modal.classList.remove('hidden');
            }
            
            function closeIconModal() {
                document.getElementById('icon-form-modal').classList.add('hidden');
            }

            // *** NEW: Icon Modal Functions ***
            function renderIconChoices(filterText = '') {
                const container = document.getElementById('icon-list-container');
                container.innerHTML = '';
                const filteredIcons = ICON_CHOICES.filter(icon => icon.includes(filterText.toLowerCase()));

                if (filteredIcons.length === 0) {
                    container.innerHTML = '<p class="col-span-6 sm:col-span-8 text-center text-gray-500 p-4">ไม่พบไอคอนที่ตรงกับคำค้นหา</p>';
                    return;
                }

                filteredIcons.forEach(iconClass => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'icon-select-btn p-3 rounded-xl hover:bg-purple-100 transition duration-150';
                    button.setAttribute('data-icon', iconClass);
                    button.innerHTML = `<i class="fa-solid ${iconClass} text-2xl text-purple-600"></i>`;
                    container.appendChild(button);
                });
            }

            async function openIconModal(accountId) {
                const modal = document.getElementById('icon-form-modal');
                const acc = state.accounts.find(a => a.id === accountId);
                if (!acc) return;

                const getEl = (id) => document.getElementById(id);
                const currentIcon = acc.iconName || acc.icon || 'fa-wallet';

                getEl('edit-icon-account-id').value = accountId;
                getEl('icon-acc-name').textContent = escapeHTML(acc.name);
                getEl('icon-preview').className = `fa-solid ${currentIcon} text-purple-600 text-2xl ml-2`;
                getEl('icon-preview').setAttribute('data-current-icon', currentIcon);
                getEl('icon-search').value = '';
                
                renderIconChoices();

                modal.classList.remove('hidden');
            }
            // *** END NEW: Icon Modal Functions ***
            
            function closeAccountDetailModal() {
                document.getElementById('account-detail-modal').classList.add('hidden');
            }
            
            // ********** MODIFIED: showAccountDetailModal **********
			async function showAccountDetailModal(accountId) {
				const modal = document.getElementById('account-detail-modal');
				modal.classList.remove('hidden');
				document.getElementById('account-detail-modal-body').innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i> กำลังโหลดรายการ...</td></tr>';
				
				// ตั้งค่า View State ให้ใช้ค่าจากหน้า Home
				accountDetailState.accountId = accountId;
				accountDetailState.viewMode = state.homeViewMode; // <--- ใช้ View Mode ปัจจุบันของหน้า Home
				accountDetailState.currentDate = state.homeCurrentDate; // <--- ใช้ Current Date ปัจจุบันของหน้า Home
				updateAccountDetailControls();

				// Set button data attribute
				const btn = document.getElementById('add-tx-from-account-btn');
				if(btn) btn.dataset.accountId = accountId;

				await renderAccountDetailList(accountId);
			}
			// ******************************************************
            
            // ********** MODIFIED: renderAccountDetailList **********
            async function renderAccountDetailList(accountId) {
                const modalTitle = document.getElementById('account-detail-modal-title');
                const listBody = document.getElementById('account-detail-modal-body');
                const accDetailInitialBalance = document.getElementById('acc-detail-initial-balance');
                const accDetailCurrentBalance = document.getElementById('acc-detail-current-balance');
                
                // กรองธุรกรรมตาม viewMode/currentDate
                const { viewMode, currentDate } = accountDetailState;
                let relevantTxs = state.transactions.filter(tx => {
                    const isRelated = tx.accountId === accountId || tx.toAccountId === accountId;
                    if (!isRelated) return false;

                    if (viewMode === 'all') return true;

                    const txDate = new Date(tx.date);
                    const year = currentDate.slice(0, 4);

                    if (viewMode === 'year') {
                        return txDate.getFullYear() == year;
                    } else if (viewMode === 'month') {
                        const month = currentDate.slice(5, 7);
                        return txDate.getFullYear() == year && (txDate.getMonth() + 1).toString().padStart(2, '0') == month;
                    }
                    return true;
                });

                listBody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i> กำลังโหลดรายการ...</td></tr>';

                const account = state.accounts.find(a => a.id === accountId);
                if (!account) {
                    listBody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-red-500">ไม่พบบัญชี</td></tr>';
                    return;
                }
                
                modalTitle.textContent = `${escapeHTML(account.name)}`;
                accDetailInitialBalance.textContent = formatCurrency(account.initialBalance || 0);

                // คำนวณยอดคงเหลือปัจจุบันจากธุรกรรมทั้งหมด
                const allTxs = [...state.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                let currentBalance = account.initialBalance || 0;

                // คำนวณยอดคงเหลือปัจจุบัน ณ ตอนนี้ (ไม่สน Filter)
                for (const tx of allTxs) {
                    if (tx.type === 'income' && tx.accountId === accountId) currentBalance += tx.amount;
                    else if (tx.type === 'expense' && tx.accountId === accountId) currentBalance -= tx.amount;
                    else if (tx.type === 'transfer') {
                        if (tx.accountId === accountId) currentBalance -= tx.amount;
                        else if (tx.toAccountId === accountId) currentBalance += tx.amount;
                    }
                }

                accDetailCurrentBalance.textContent = formatCurrency(currentBalance);
                accDetailCurrentBalance.className = `font-bold ${currentBalance > 0 ? 'text-green-600' : (currentBalance < 0 ? 'text-red-600' : 'text-gray-600')}`;


                // เรียงเฉพาะรายการที่ Filter ได้ตามวันเวลา (ล่าสุดอยู่บน)
                relevantTxs.sort((a, b) => new Date(a.date) - new Date(b.date));

                // คำนวณยอดคงเหลือย้อนหลังสำหรับรายการที่ Filter ได้
                const txRows = [];
                let runningBalanceForPeriod = account.initialBalance || 0; 
                
                // หายอดคงเหลือเริ่มต้นสำหรับ Period ที่ถูก Filter (ถ้า viewMode ไม่ใช่ 'all')
                let startBalanceForPeriod = account.initialBalance || 0;
                
                if (viewMode !== 'all') {
                    // หาธุรกรรมทั้งหมดที่เกิดขึ้นก่อน Period นี้
                    const transactionsBeforePeriod = allTxs.filter(tx => {
                        const txDate = new Date(tx.date);
                        if (viewMode === 'month') {
                             return txDate < new Date(currentDate); 
                        } else if (viewMode === 'year') {
                             return txDate.getFullYear() < parseInt(currentDate.slice(0, 4));
                        }
                        return false; 
                    });

                    let balanceBeforePeriod = account.initialBalance || 0;
                    for (const tx of transactionsBeforePeriod) {
                        if (tx.type === 'income' && tx.accountId === accountId) balanceBeforePeriod += tx.amount;
                        else if (tx.type === 'expense' && tx.accountId === accountId) balanceBeforePeriod -= tx.amount;
                        else if (tx.type === 'transfer') {
                            if (tx.accountId === accountId) balanceBeforePeriod -= tx.amount;
                            else if (tx.toAccountId === accountId) balanceBeforePeriod += tx.amount;
                        }
                    }
                    startBalanceForPeriod = balanceBeforePeriod;
                }

                runningBalanceForPeriod = startBalanceForPeriod;


                for (const tx of relevantTxs) {
                    let txAmount = 0;
                    let txAmountSign = '';
                    let txAmountClass = 'text-gray-700';
                    let isRelevant = false;

                    if (tx.type === 'income' && tx.accountId === accountId) {
                        txAmount = tx.amount;
                        txAmountSign = '+';
                        txAmountClass = 'text-green-600';
                        runningBalanceForPeriod += txAmount; 
                        isRelevant = true;
                    } else if (tx.type === 'expense' && tx.accountId === accountId) {
                        txAmount = tx.amount;
                        txAmountSign = '-';
                        txAmountClass = 'text-red-600';
                        runningBalanceForPeriod -= txAmount;
                        isRelevant = true;
                    } else if (tx.type === 'transfer') {
                        if (tx.accountId === accountId) {
                            txAmount = tx.amount;
                            txAmountSign = '-';
                            txAmountClass = 'text-blue-600';
                            runningBalanceForPeriod -= txAmount;
                            isRelevant = true;
                        } else if (tx.toAccountId === accountId) {
                            txAmount = tx.amount;
                            txAmountSign = '+';
                            txAmountClass = 'text-blue-600';
                            runningBalanceForPeriod += txAmount;
                            isRelevant = true;
                        }
                    }

                    if (isRelevant) {
                        // --- ส่วนแสดงผลรายการ ---
                        const dateObj = new Date(tx.date);
                        const mobileDate = dateObj.toLocaleString('th-TH', { day: '2-digit', month: '2-digit' });
                        const desktopDate = dateObj.toLocaleString('th-TH', { day: '2-digit', month: 'short', year: '2-digit', hour:'2-digit', minute:'2-digit' });
                        const name = escapeHTML(tx.name);
                        
                        txRows.push({ 
                            mobileDate: mobileDate,
                            desktopDate: desktopDate,
                            name: name,
                            category: tx.type === 'transfer' ? 'โอน' : escapeHTML(tx.category),
                            amountSign: txAmountSign,
                            amount: formatCurrency(tx.amount).replace('฿', '').split('.')[0], 
                            amountClass: txAmountClass,
                            finalBalance: formatCurrency(runningBalanceForPeriod).replace('฿', '').split('.')[0],
                            receiptBase64: tx.receiptBase64 // <-- ADDED RECEIPT DATA
                        });
                    }
                }
                
                // เนื่องจากเราคำนวณจากรายการเก่าไปใหม่ (เรียง ascending) แต่ต้องการแสดงผลล่าสุดอยู่บน (descending)
                txRows.reverse(); 


                if (txRows.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500 text-base">ไม่มีรายการเคลื่อนไหวในรอบที่เลือก</td></tr>';
                    return;
                }

                listBody.innerHTML = txRows.map(row => {
                    const balanceVal = parseFloat(row.finalBalance.replace(/,/g,""));
                    const balanceClass = balanceVal >= 0 ? 'text-blue-700' : 'text-red-700';
                    
                    // <-- ADDED RECEIPT ICON HTML HERE
                    const receiptIconHtml = row.receiptBase64 ? 
                        `<button type="button" class="view-receipt-icon text-purple-500 hover:text-purple-700 ml-2 z-10 relative" data-base64="${row.receiptBase64}" title="คลิกเพื่อดูรูป">
                            <i class="fa-solid fa-receipt"></i>
                        </button>` : '';
                    // ------------------------------------

                    return `
                        <tr class="border-b border-gray-100 hover:bg-gray-50 align-top">
                            <td class="p-2 md:p-3 text-base md:text-lg text-gray-500 align-top pt-3">
                                <span class="md:hidden font-medium">${row.mobileDate}</span>
                                <span class="hidden md:inline">${row.desktopDate}</span>
                            </td>

                            <td class="p-2 md:p-3 text-base md:text-lg text-gray-800 align-top break-words pt-3 leading-snug">
                                <div class="font-medium">${row.name}${receiptIconHtml}</div>
                                <div class="text-sm text-gray-400 mt-0.5 truncate hidden md:block">${row.category}</div>
                            </td>

                            <td class="p-2 md:p-3 text-base md:text-lg text-right align-top whitespace-nowrap pt-3">
                                <span class="${row.amountClass} font-bold">
                                    ${row.amountSign}${row.amount}
                                </span>
                            </td>

                            <td class="p-2 md:p-3 text-base md:text-lg font-bold text-right whitespace-nowrap ${balanceClass} align-top pt-3">
                                ${row.finalBalance}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            // *******************************************************
            
            function populateAccountDropdowns(selectId, filterFn = null) {
                const selectEl = document.getElementById(selectId);
                selectEl.innerHTML = '';
                
                let accountsToDisplay = getSortedAccounts(); 
                
                if (filterFn) {
                    accountsToDisplay = accountsToDisplay.filter(filterFn);
                }

                if (accountsToDisplay.length === 0) {
                    selectEl.innerHTML = '<option value="">-- ไม่มีบัญชี --</option>';
                    return;
                }

                accountsToDisplay.forEach(acc => {
                    const icon = acc.type === 'credit' ? '💳' : (acc.type === 'liability' ? '🧾' : '💵');
                    selectEl.insertAdjacentHTML('beforeend', 
                        `<option value="${acc.id}">${icon} ${escapeHTML(acc.name)}</option>`
                    );
                });
            }
            // ค้นหาฟังก์ชัน updateFormVisibility แล้วแทนที่ด้วยโค้ดนี้
			function updateFormVisibility() {
				const getEl = (id) => document.getElementById(id);
				const type = document.querySelector('input[name="tx-type"]:checked').value;
				
				const accountContainer = getEl('tx-account-container');
				const fromContainer = getEl('tx-account-from-container');
				const toContainer = getEl('tx-account-to-container');
				const nameContainer = getEl('tx-name-container');
				const categoryContainer = getEl('tx-category-container');
				
				// ซ่อนทั้งหมดก่อน
				[accountContainer, fromContainer, toContainer, nameContainer, categoryContainer].forEach(el => el.classList.add('hidden'));
				
				// Reset required
				getEl('tx-account').required = false;
				getEl('tx-account-from').required = false;
				getEl('tx-account-to').required = false;
				getEl('tx-name').required = false;
				getEl('tx-category').required = false;

				if (type === 'income' || type === 'expense') {
					accountContainer.classList.remove('hidden');
					nameContainer.classList.remove('hidden');
					categoryContainer.classList.remove('hidden');
					
					getEl('tx-account').required = true;
					getEl('tx-name').required = true;
					getEl('tx-category').required = true;
					
					updateCategoryDropdown(type);
				} else if (type === 'transfer') {
					fromContainer.classList.remove('hidden');
					toContainer.classList.remove('hidden');
					nameContainer.classList.remove('hidden'); // แสดงช่องชื่อรายการ
					
					getEl('tx-name').required = true; // บังคับใส่ชื่อ
					getEl('tx-account-from').required = true;
					getEl('tx-account-to').required = true;
				}
			}


            function updateCategoryDropdown(type = null) {
                const selectedType = type || document.querySelector('input[name="tx-type"]:checked').value;
                
                if (selectedType === 'transfer') return;
                
                const categories = state.categories[selectedType];
                const dropdown = document.getElementById('tx-category');
                dropdown.innerHTML = '';
                if (Array.isArray(categories) && categories.length > 0) {
                    categories.forEach(cat => {
                        dropdown.insertAdjacentHTML('beforeend', `<option value="${escapeHTML(cat)}">${escapeHTML(cat)}</option>`);
                    });
                } else {
                    dropdown.insertAdjacentHTML('beforeend', `<option value="">-- ไม่มีหมวดหมู่ --</option>`);
                }
            }

            async function handleFormSubmit(e) {
				e.preventDefault();
				document.getElementById('calculator-popover').classList.add('hidden');

				const getEl = (id) => document.getElementById(id);
				
				const rawAmount = getEl('tx-amount').value;
				let finalAmount = safeCalculate(rawAmount);
				if (finalAmount === null || finalAmount <= 0) {
					Swal.fire('ข้อมูลไม่ครบถ้วน', 'จำนวนเงินไม่ถูกต้อง (ต้องมากกว่า 0)', 'warning');
					return;
				}
				finalAmount = parseFloat(finalAmount.toFixed(2));
				const txId = getEl('tx-id').value;
				const type = document.querySelector('input[name="tx-type"]:checked').value;
				
				let transaction = {
					id: txId || `tx-${new Date().getTime()}`,
					type: type,
					amount: finalAmount,
					date: getEl('tx-date').value,
					desc: getEl('tx-desc').value.trim() || null,
					name: null,
					category: null,
					accountId: null,
					toAccountId: null,
                    receiptBase64: currentReceiptBase64 // +++ NEW: Add receiptBase64 field +++
				};

				// ดึงค่าชื่อรายการสำหรับทุกกรณี
				transaction.name = getEl('tx-name').value.trim();

				if (type === 'income' || type === 'expense') {
					transaction.category = getEl('tx-category').value;
					transaction.accountId = getEl('tx-account').value;
					
					if (!transaction.name || !transaction.category || !transaction.accountId) {
						Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกชื่อรายการ, หมวดหมู่, และบัญชี', 'warning');
						return;
					}

                    // +++ AUTO LEARN LOGIC (v3) +++
                    const learnData = {
                        name: transaction.name,
                        type: transaction.type,
                        category: transaction.category,
                        amount: transaction.amount
                    };
                    // Save to DB (Fire and Forget)
                    dbPut(STORE_AUTO_COMPLETE, learnData).catch(err => console.warn("Auto-learn failed", err));
                    // Update local state for immediate use
                    const existingIndex = state.autoCompleteList.findIndex(item => item.name === transaction.name);
                    if (existingIndex >= 0) {
                         state.autoCompleteList[existingIndex] = learnData;
                    } else {
                         state.autoCompleteList.push(learnData);
                    }
                    // +++ END AUTO LEARN +++

                } else if (type === 'transfer') {
					// ถ้าไม่ได้กรอกชื่อ ให้ใส่ค่า default
					if (!transaction.name) transaction.name = 'โอนย้าย';

					transaction.accountId = getEl('tx-account-from').value;
					transaction.toAccountId = getEl('tx-account-to').value;
					
					if (!transaction.accountId || !transaction.toAccountId) {
						Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกบัญชีต้นทางและปลายทาง', 'warning');
						return;
					}
					if (transaction.accountId === transaction.toAccountId) {
							Swal.fire('ข้อมูลผิดพลาด', 'บัญชีต้นทางและปลายทางต้องไม่ซ้ำกัน', 'warning');
						return;
					}
				}

				try {
					await dbPut(STORE_TRANSACTIONS, transaction);
					if (txId) {
						const oldTx = state.transactions.find(t => t.id === txId);
						state.transactions = state.transactions.map(t => t.id === txId ? transaction : t);
						setLastUndoAction({ type: 'tx-edit', oldData: JSON.parse(JSON.stringify(oldTx)), newData: transaction });
					} else {
						state.transactions.push(transaction);
						setLastUndoAction({ type: 'tx-add', data: transaction });
					}

					if (currentPage === 'home') {
						renderAll();
					}
					if (currentPage === 'list') {
						renderListPage();
					}
					if (currentPage === 'calendar') { 
						renderCalendarView();
					}
					
					closeModal();
					renderSettings();
					Swal.fire('บันทึกสำเร็จ!', 'บันทึกข้อมูลของคุณเรียบร้อยแล้ว', 'success');
				} catch (err) {
					console.error("Failed to save transaction:", err);
					Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลลงฐานข้อมูลได้', 'error');
				}
			}

                  function safeCalculate(expression) {
                try {
                    let sanitized = String(expression).replace(/,/g, '').replace(/\s/g, '');
                    // Allow optional leading minus sign for account balances
                    if (!/^-?[0-9+\-*/.]+$/.test(sanitized)) { return null;
                    } 
                    if (!/^-?[0-9.]/.test(sanitized) || !/[0-9.]$/.test(sanitized)) { return null;
                    }
                    if (/[\+\-\*\/]{2,}/.test(sanitized)) { return null;
                    }
                    const result = eval(sanitized);
                    if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) { return null;
                    }
                    return result;
                } catch (error) {
                    return null;
                }
            }


            function handleCalcPreview(expression, previewId) {
                const previewEl = document.getElementById(previewId);
                if (!expression) {
                    previewEl.textContent = '';
                    return;
                }

                const lastChar = expression.trim().slice(-1);
                if (['+', '-', '*', '/'].includes(lastChar)) {
                        previewEl.textContent = '';
                    return;
                }

                const result = safeCalculate(expression);
                if (result !== null) {
                    previewEl.textContent = '= ' + parseFloat(result.toFixed(2));
                } else {
                    previewEl.textContent = '';
                }
            }


            function handleCalcClick(buttonEl, inputId, popoverId, previewId) {
                const value = buttonEl.dataset.value;
                const amountInput = document.getElementById(inputId);
                const popover = document.getElementById(popoverId);
                let currentVal = amountInput.value;
                if (value === 'C') {
                    amountInput.value = '';
                } else if (value === '=') {
                    const result = safeCalculate(currentVal);
                    if (result !== null) {
                        amountInput.value = parseFloat(result.toFixed(2));
                        popover.classList.add('hidden');
                    } else {
                        amountInput.value = '';
                        Swal.fire('คำนวณผิดพลาด', 'รูปแบบการคำนวณไม่ถูกต้อง', 'warning'); 
                    }
                } else {
                    amountInput.value = currentVal + value;
                }
                
                handleCalcPreview(amountInput.value, previewId);
            }
            // ********** END MODIFICATION 2 **********


            function handleChangeViewMode(e, source) {
                const newMode = e.target.value;
                if (source === 'home') {
                    state.homeViewMode = newMode;
                    state.homeCurrentPage = 1;
                    renderAll(); 
                } else {
                    state.listViewMode = newMode;
                    state.listCurrentPage = 1;
                    renderListPage();
                }
                updateSharedControls(source);
            }

            function handleDateChange(e, source) {
                const changedElement = e.target;
                let newDate;
                let viewMode = (source === 'home') ? state.homeViewMode : state.listViewMode;
                if (viewMode === 'month') {
                    const [year, month] = changedElement.value.split('-');
                    if (year && month) {
                        newDate = `${year}-${month}-01`;
                    }
                } else {
                    const year = changedElement.value;
                    if (year && year.length === 4) {
                        newDate = `${year}-01-01`;
                    }
                }

                if (newDate) {
                    if (source === 'home') {
                        state.homeCurrentDate = newDate;
                        state.homeCurrentPage = 1;
                        renderAll();
                    } else {
                        state.listCurrentDate = newDate;
                        state.listCurrentPage = 1;
                        renderListPage();
                    }
                }
            }
            
            function navigateMonth(direction, source) {
                let dateStr = (source === 'home') ? state.homeCurrentDate : state.listCurrentDate;
                let date = new Date(dateStr);
                date.setMonth(date.getMonth() + direction);
                const newDate = date.toISOString().slice(0, 10);
                if (source === 'home') {
                    state.homeCurrentDate = newDate;
                    state.homeCurrentPage = 1;
                    renderAll();
                    updateSharedControls('home');
                } else {
                    state.listCurrentDate = newDate;
                    state.listCurrentPage = 1;
                    renderListPage();
                    updateSharedControls('list');
                }
            }

            function navigateYear(direction, source) {
                let dateStr = (source === 'home') ? state.homeCurrentDate : state.listCurrentDate;
                let date = new Date(dateStr);
                date.setFullYear(date.getFullYear() + direction);
                const newDate = date.toISOString().slice(0, 10);
                if (source === 'home') {
                    state.homeCurrentDate = newDate;
                    state.homeCurrentPage = 1;
                    renderAll();
                    updateSharedControls('home');
                } else {
                    state.listCurrentDate = newDate;
                    state.listCurrentPage = 1;
                    renderListPage();
                    updateSharedControls('list');
                }
            }

            function handleSearch(e) {
                state.searchTerm = e.target.value;
                state.listCurrentPage = 1;
                renderListPage();
            }

            function handleFilter(buttonEl) {
                document.querySelectorAll('#list-filter-buttons .filter-btn').forEach(btn => {
                    btn.classList.remove('bg-purple-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                buttonEl.classList.add('bg-purple-500', 'text-white');
                buttonEl.classList.remove('bg-gray-200', 'text-gray-700');
                
                state.filterType = buttonEl.dataset.filter;
                state.listCurrentPage = 1;
                renderListPage();
            }

            function handleHomeFilter(buttonEl) {
                document.querySelectorAll('#home-filter-buttons .home-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-purple-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                buttonEl.classList.add('bg-purple-500', 'text-white');
                buttonEl.classList.remove('bg-gray-200', 'text-gray-700');
                
                state.homeFilterType = buttonEl.dataset.filter;
                
                state.homeCurrentPage = 1;
                renderAll();
            }

            async function handleEditClick(buttonEl) {
                const txId = buttonEl.dataset.id;
                const hasPermission = await promptForPassword('ป้อนรหัสผ่านเพื่อแก้ไข');
                if (hasPermission) {
                    openModal(txId);
                }
            }

            async function handleDeleteClick(buttonEl) {
                const txId = buttonEl.dataset.id;
                const hasPermission = await promptForPassword('ป้อนรหัสผ่านเพื่อลบ');
                if (!hasPermission) {
                    return;
                }
                
                Swal.fire({
                    title: 'แน่ใจหรือไม่?',
                    text: "คุณต้องการลบรายการนี้ใช่หรือไม่",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#aaa',
                    confirmButtonText: 'ใช่, ลบเลย!',
                    cancelButtonText: 'ยกเลิก'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        const oldTx = state.transactions.find(tx => tx.id === txId);
                        try {
                            await dbDelete(STORE_TRANSACTIONS, txId);
                            state.transactions = state.transactions.filter(tx => tx.id !== txId);
                            setLastUndoAction({ type: 'tx-delete', data: JSON.parse(JSON.stringify(oldTx)) });
                            if (currentPage === 'home') renderAll();
                            if (currentPage === 'list') renderListPage();
                            if (currentPage === 'calendar') renderCalendarView(); 

                            Swal.fire('ลบแล้ว!', 'รายการของคุณถูกลบแล้ว', 'success');
                        } catch (err) {
                            console.error("Failed to delete transaction:", err);
                            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้', 'error');
                        }
                    }
                });
            }

            function handlePaginationClick(e, source) {
                const btn = e.target.closest('button');
                if (!btn || btn.disabled) return;

                const page = parseInt(btn.dataset.page, 10);
                if (isNaN(page)) return;
                if (source === 'home') {
                    state.homeCurrentPage = page;
                    renderAll();
                } else {
                    state.listCurrentPage = page;
                    renderListPage();
                }
            }

            async function handleAddAccount(e) {
                e.preventDefault();
                const getEl = (id) => document.getElementById(id);
                document.getElementById('account-calculator-popover').classList.add('hidden'); // Hide Popover

                const name = getEl('input-account-name').value.trim();
                const type = getEl('select-account-type').value;
                
                const rawBalance = getEl('input-account-balance').value;
                let initialBalance = safeCalculate(rawBalance);
                if (initialBalance === null) {
                     Swal.fire('ข้อมูลไม่ถูกต้อง', 'ยอดเริ่มต้นไม่ถูกต้อง', 'warning');
                    return;
                }
                initialBalance = parseFloat(initialBalance.toFixed(2));
                if (!name) {
                    Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อบัญชี', 'warning');
                    return;
                }
                
                const defaultIconName = type === 'credit' ? 'fa-credit-card' : (type === 'liability' ? 'fa-file-invoice-dollar' : 'fa-wallet');

                const newAccount = {
                    id: `acc-${Date.now()}`,
                    name: name,
                    type: type,
                    initialBalance: initialBalance,
                    icon: defaultIconName,
                    iconName: defaultIconName, // *** NEW: Add iconName field ***
                    displayOrder: Date.now() 
                };
                try {
                    await dbPut(STORE_ACCOUNTS, newAccount);
                    state.accounts.push(newAccount);
                    setLastUndoAction({ type: 'account-add', data: newAccount }); 
                    renderAccountSettingsList();
                    if (currentPage === 'home') renderAll(); 
                    getEl('form-add-account').reset();
                    getEl('input-account-balance').value = 0;
                    getEl('acc-calc-preview').textContent = '';
                    Swal.fire('เพิ่มสำเร็จ', `บัญชี <b class="text-purple-600">${escapeHTML(name)}</b> ถูกเพิ่มเรียบร้อยแล้ว`, 'success');

                } catch (err) {
                    console.error("Failed to add account:", err);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเพิ่มบัญชีได้', 'error');
                }
            }

            async function handleEditAccountSubmit(e) {
                // Note: Password check is done before calling this function in event listener
                // e.preventDefault() is called before the password prompt in the listener

                const getEl = (id) => document.getElementById(id);
                document.getElementById('edit-account-calculator-popover').classList.add('hidden'); // Hide Popover

                const accountId = getEl('edit-account-id').value;
                const name = getEl('edit-account-name').value.trim();
                const type = getEl('edit-account-type').value;
                
                const rawBalance = getEl('edit-account-balance').value;
                let initialBalance = safeCalculate(rawBalance);
                
                if (initialBalance === null) {
                     Swal.fire('ข้อมูลไม่ถูกต้อง', 'ยอดเริ่มต้นไม่ถูกต้อง', 'warning');
                     return;
                }
                initialBalance = parseFloat(initialBalance.toFixed(2));

                if (!name || !accountId) {
                    Swal.fire('ข้อผิดพลาด', 'ข้อมูลไม่ถูกต้อง', 'error');
                    return;
                }
                
                const accountIndex = state.accounts.findIndex(a => a.id === accountId);
                if (accountIndex === -1) {
                    Swal.fire('ข้อผิดพลาด', 'ไม่พบบัญชี', 'error');
                    return;
                }
                
                const oldAccount = JSON.parse(JSON.stringify(state.accounts[accountIndex])); 
                
                const defaultIconName = type === 'credit' ? 'fa-credit-card' : (type === 'liability' ? 'fa-file-invoice-dollar' : 'fa-wallet');

                const updatedAccount = {
                    ...state.accounts[accountIndex], 
                    name: name,
                    type: type,
                    initialBalance: initialBalance,
                    icon: defaultIconName, // Update the legacy 'icon' field
                    iconName: state.accounts[accountIndex].iconName || defaultIconName // Keep custom iconName or set default if missing
                };

                try {
                    await dbPut(STORE_ACCOUNTS, updatedAccount);
                    state.accounts[accountIndex] = updatedAccount;
                    setLastUndoAction({ type: 'account-edit', oldData: oldAccount, newData: updatedAccount }); 
                    renderAccountSettingsList();
                    if (currentPage === 'home') renderAll(); 
                    openAccountModal(null, true); 
                    Swal.fire('สำเร็จ', 'อัปเดตบัญชีเรียบร้อยแล้ว', 'success');
                } catch (err) {
                     console.error("Failed to edit account:", err);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถอัปเดตบัญชีได้', 'error');
                }
            }
            
            async function handleMoveAccount(accountId, direction) {
                const sortedAccounts = getSortedAccounts();
                const currentIndex = sortedAccounts.findIndex(a => a.id === accountId);

                if (currentIndex === -1) return; 

                let targetIndex;
                if (direction === 'up' && currentIndex > 0) {
                    targetIndex = currentIndex - 1;
                } else if (direction === 'down' && currentIndex < sortedAccounts.length - 1) {
                    targetIndex = currentIndex + 1;
                } else {
                    return; 
                }

                const currentAccount = sortedAccounts[currentIndex];
                const targetAccount = sortedAccounts[targetIndex];

                const oldCurrentOrder = currentAccount.displayOrder;
                const oldTargetOrder = targetAccount.displayOrder;

                const tempOrder = currentAccount.displayOrder;
                currentAccount.displayOrder = targetAccount.displayOrder;
                targetAccount.displayOrder = tempOrder;
                
                const actionData = {
                    type: 'account-move',
                    currentAccountId: currentAccount.id,
                    newCurrentOrder: currentAccount.displayOrder, 
                    oldCurrentOrder: oldCurrentOrder,
                    targetAccountId: targetAccount.id,
                    newTargetOrder: targetAccount.displayOrder, 
                    oldTargetOrder: oldTargetOrder
                };

                try {
                    await Promise.all([
                        dbPut(STORE_ACCOUNTS, currentAccount),
                        dbPut(STORE_ACCOUNTS, targetAccount)
                    ]);
                    
                    setLastUndoAction(actionData); 
                    
                    state.accounts = state.accounts.map(acc => {
                        if (acc.id === currentAccount.id) return currentAccount;
                        if (acc.id === targetAccount.id) return targetAccount;
                        return acc;
                    });
                    
                    renderAccountSettingsList();
                    
                    if (currentPage === 'home') {
                        const allAccountBalances = getAccountBalances(state.transactions);
                        renderAllAccountSummary(allAccountBalances);
                    }
                    
                } catch (err) {
                    console.error("Failed to move account:", err);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถสลับลำดับบัญชีได้', 'error');
                    currentAccount.displayOrder = oldCurrentOrder;
                    targetAccount.displayOrder = oldTargetOrder;
                }
            }

            async function handleDeleteAccountClick(buttonEl) {
                // Note: Password check is done before calling this function in event listener
                const accountId = buttonEl.dataset.id;
                const acc = state.accounts.find(a => a.id === accountId);
                if (!acc) return;

                const txInUse = state.transactions.find(tx => tx.accountId === accountId || tx.toAccountId === accountId);
                if (txInUse) {
                    Swal.fire('ลบไม่ได้', 'ไม่สามารถลบบัญชีนี้ได้เนื่องจากมีธุรกรรมที่เกี่ยวข้อง (เช่น รายรับ/รายจ่าย หรือการโอนย้าย)', 'error');
                    return;
                }
                
                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    html: `คุณต้องการลบบัญชี: <b class="text-purple-600">${escapeHTML(acc.name)}</b> ใช่หรือไม่?<br><small>(จะลบได้ก็ต่อเมื่อไม่มีธุรกรรมใดๆ อ้างอิงถึง)</small>`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#aaa',
                    confirmButtonText: 'ใช่, ลบเลย!',
                    cancelButtonText: 'ยกเลิก'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const oldAccount = JSON.parse(JSON.stringify(acc)); 
                            await dbDelete(STORE_ACCOUNTS, accountId);
                            state.accounts = state.accounts.filter(a => a.id !== accountId);
                            setLastUndoAction({ type: 'account-delete', data: oldAccount }); 
                            renderAccountSettingsList();
                            if (currentPage === 'home') renderAll();
                            Swal.fire('ลบแล้ว!', 'บัญชีถูกลบแล้ว', 'success');
                        } catch (err) {
                            console.error("Failed to delete account:", err);
                            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้', 'error');
                        }
                    }
                });
            }


            async function handleAddCategory(e) {
                e.preventDefault();
                const formId = e.target.id;
                const type = (formId === 'form-add-income-cat') ? 'income' : 'expense';
                const input = document.getElementById(`input-${type}-cat`);
                const name = input.value.trim();

                if (name && !state.categories[type].includes(name)) {
                    state.categories[type].push(name);
                    try {
                        await dbPut(STORE_CATEGORIES, { type: type, items: state.categories[type] });
                        setLastUndoAction({ type: 'cat-add', catType: type, name: name });
                        renderSettings();
                        input.value = '';
                    } catch (err) {
                        console.error("Failed to add category:", err);
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกหมวดหมู่ได้', 'error');
                        state.categories[type] = state.categories[type].filter(cat => cat !== name);
                    }
                } else if (!name) {
                    Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อหมวดหมู่', 'warning');
                } else {
                    Swal.fire('ข้อผิดพลาด', 'มีหมวดหมู่นี้อยู่แล้ว', 'error');
                }
            }

            function handleDeleteCategory(buttonEl) {
                const type = buttonEl.dataset.type;
                const name = buttonEl.dataset.name;

                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    html: `คุณต้องการลบหมวดหมู่: <b class="text-purple-600">${escapeHTML(name)}</b> ใช่หรือไม่?`,
                    icon: 'warning',
                    showCancelButton: true,
         
                     confirmButtonColor: '#d33',
                    cancelButtonColor: '#aaa',
                    confirmButtonText: 'ใช่, ลบเลย!',
                    cancelButtonText: 'ยกเลิก'
                }).then(async (result) => {
     
                     if (result.isConfirmed) {
                        const oldCategories = [...state.categories[type]];
                        state.categories[type] = state.categories[type].filter(cat => cat !== name);
                        try {
 
                             await dbPut(STORE_CATEGORIES, { type: type, items: state.categories[type] });
                            setLastUndoAction({ type: 'cat-delete', catType: type, name: name });
                            renderSettings();
                            Swal.fire('ลบแล้ว!', 'หมวดหมู่ถูกลบแล้ว', 'success');
                        } catch (err) {
                            console.error("Failed to delete category:", err);
                            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบหมวดหมู่ได้', 'error');
                            state.categories[type] = oldCategories;
                        }
                    }
                });
            }

            async function handleAddFrequentItem(e) {
                e.preventDefault();
                const input = document.getElementById('input-frequent-item');
                const name = input.value.trim();

                if (name && !state.frequentItems.includes(name)) {
                    try {
                        await dbPut(STORE_FREQUENT_ITEMS, { name: name });
                        state.frequentItems.push(name);
                        setLastUndoAction({ type: 'item-add', name: name });
                        renderSettings();
                        input.value = '';
                    } catch (err) {
                        console.error("Failed to add frequent item:", err);
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกรายการได้', 'error');
                    }
                } else if (!name) {
                    Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อรายการ', 'warning');
                } else {
                    Swal.fire('ข้อผิดพลาด', 'มีรายการนี้อยู่แล้ว', 'error');
                }
            }

            function handleDeleteFrequentItem(buttonEl) {
                const name = buttonEl.dataset.name;
                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    html: `คุณต้องการลบรายการที่ใช้บ่อย: <b class="text-purple-600">${escapeHTML(name)}</b> ใช่หรือไม่?`,
                    icon: 'warning',
                    showCancelButton: true,
             
                     confirmButtonColor: '#d33',
                    cancelButtonColor: '#aaa',
                    confirmButtonText: 'ใช่, ลบเลย!',
                    cancelButtonText: 'ยกเลิก'
                }).then(async (result) => {
         
                     if (result.isConfirmed) {
                        try {
                            await dbDelete(STORE_FREQUENT_ITEMS, name);
                            state.frequentItems = state.frequentItems.filter(item => 
                            item !== name);
                            setLastUndoAction({ type: 'item-delete', name: name });
                            renderSettings();
                            Swal.fire('ลบแล้ว!', 'รายการที่ใช้บ่อยถูกลบแล้ว', 'success');
       
                         } catch (err) {
                            console.error("Failed to delete frequent item:", err);
                            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบรายการได้', 'error');
                        }
                    }
                });
            }
            
            // *** NEW: Handle Toggle Favorite ***
            async function handleToggleFavorite() {
                const nameInput = document.getElementById('tx-name');
                const toggleFavBtn = document.getElementById('toggle-favorite-btn');
                const name = nameInput.value.trim();

                if (!name) {
                    Swal.fire('ข้อผิดพลาด', 'กรุณาใส่ชื่อรายการก่อนกำหนดเป็นรายการโปรด', 'warning');
                    return;
                }

                const isCurrentlyFav = toggleFavBtn.classList.contains('text-yellow-500');

                if (isCurrentlyFav) {
                    // Remove from favorites (Unfavorite)
                    try {
                        await dbDelete(STORE_FREQUENT_ITEMS, name);
                        state.frequentItems = state.frequentItems.filter(item => item !== name);
                        
                        toggleFavBtn.classList.remove('text-yellow-500');
                        toggleFavBtn.classList.add('text-gray-400');
                        
                        renderSettings(); 
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true,
                            customClass: { popup: state.isDarkMode ? 'swal2-toast' : '' },
                            background: state.isDarkMode ? '#1a1a1a' : '#fff',
                            color: state.isDarkMode ? '#e5e7eb' : '#545454',
                        });
                        Toast.fire({ icon: "success", title: "ลบออกจากรายการโปรดแล้ว" });
                    } catch (err) {
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบรายการโปรดได้', 'error');
                    }
                } else {
                    // Add to favorites (Favorite)
                    if (state.frequentItems.includes(name)) return; 

                    try {
                        await dbPut(STORE_FREQUENT_ITEMS, { name: name });
                        state.frequentItems.push(name);
                        
                        toggleFavBtn.classList.add('text-yellow-500');
                        toggleFavBtn.classList.remove('text-gray-400');

                        renderSettings(); 
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true,
                            customClass: { popup: state.isDarkMode ? 'swal2-toast' : '' },
                            background: state.isDarkMode ? '#1a1a1a' : '#fff',
                            color: state.isDarkMode ? '#e5e7eb' : '#545454',
                        });
                        Toast.fire({ icon: "success", title: "เพิ่มเป็นรายการโปรดแล้ว" });
                    } catch (err) {
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเพิ่มรายการโปรดได้', 'error');
                    }
                }
            }
            // *** END NEW ***

            async function handleManagePassword() {
                if (state.password) {
                    const hasPermission = await promptForPassword('ป้อนรหัสผ่านปัจจุบัน');
                    if (!hasPermission) return;

                    const { value: action } = await Swal.fire({
                        title: 'จัดการรหัสผ่าน',
                        text: 'คุณต้องการทำอะไร?',
                        icon: 'info',
               
                         showCancelButton: true,
                        showDenyButton: true,
                        confirmButtonText: 'เปลี่ยนรหัสผ่าน',
                        denyButtonText: 'ลบรหัสผ่าน',
               
                         cancelButtonText: 'ยกเลิก'
                    });
                    if (action === true) {
                        const { value: newPassword } = await Swal.fire({
                            title: 'ตั้งรหัสผ่านใหม่',
                            input: 'password',
       
                             inputPlaceholder: 'กรอกรหัสผ่านใหม่',
                            showCancelButton: true,
                            inputValidator: (value) => {
                  
                                 if (!value) return 'รหัสผ่านห้ามว่าง!';
                            }
                        });
                        if (newPassword) {
                            const { value: confirmPassword } = await Swal.fire({
                                title: 'ยืนยันรหัสผ่านใหม่',
                              
                                 input: 'password',
                                inputPlaceholder: 'กรอกรหัสผ่านใหม่อีกครั้ง',
                                showCancelButton: true,
                               
                                 inputValidator: (value) => {
                                    if (value !== newPassword) return 'รหัสผ่านไม่ตรงกัน!';
                                }
                       
                         });

                            if (confirmPassword === newPassword) {
                                const hashedNewPassword = CryptoJS.SHA256(newPassword).toString();
                                await dbPut(STORE_CONFIG, { key: 'password', value: hashedNewPassword });
                                state.password = hashedNewPassword;
                                Swal.fire('สำเร็จ!', 'เปลี่ยนรหัสผ่านเรียบร้อย', 'success');
                                resetAutoLockTimer(); // *** NEW: Reset timer on password change ***
                            }
                        }

                    } else if (action === false) {
                        Swal.fire({
                          
                             title: 'ยืนยันลบรหัสผ่าน?',
                            text: 'คุณจะไม่ต้องใช้รหัสผ่านในการแก้ไข/ลบ อีกต่อไป',
                            icon: 'warning',
                            showCancelButton: true,
         
                             confirmButtonColor: '#d33',
                            confirmButtonText: 'ใช่, ลบรหัสผ่าน',
                            cancelButtonText: 'ยกเลิก'
                     
                     }).then(async (result) => {
                            if (result.isConfirmed) {
                                await dbPut(STORE_CONFIG, { key: 'password', value: null });
                         
                         state.password = null;
                                Swal.fire('สำเร็จ!', 'ลบรหัสผ่านเรียบร้อย', 'success');
                                resetAutoLockTimer(); // *** NEW: Reset timer (which will effectively stop it) ***
                            }
                        });
                    }

                } else {
                    const { value: newPassword } = await Swal.fire({
                        title: 'ตั้งรหัสผ่านใหม่',
                        text: 'ตั้งรหัสผ่านสำหรับการแก้ไขและลบรายการ',
     
                         input: 'password',
                        inputPlaceholder: 'กรอกรหัสผ่านที่ต้องการ',
                        showCancelButton: true,
                        inputValidator: (value) => {
   
                             if (!value) return 'รหัสผ่านห้ามว่าง!';
                        }
                    });
                    if (newPassword) {
                        const { value: confirmPassword } = await Swal.fire({
                            title: 'ยืนยันรหัสผ่านใหม่',
                            input: 'password',
         
                             inputPlaceholder: 'กรอกรหัสผ่านใหม่อีกครั้ง',
                            showCancelButton: true,
                            inputValidator: (value) => {
                    
                             if (value !== newPassword) return 'รหัสผ่านไม่ตรงกัน!';
                            }
                        });
                        if (confirmPassword === newPassword) {
                            const hashedNewPassword = CryptoJS.SHA256(newPassword).toString();
                            await dbPut(STORE_CONFIG, { key: 'password', value: hashedNewPassword });
                            state.password = hashedNewPassword;
                            Swal.fire('สำเร็จ!', 'ตั้งค่ารหัสผ่านเรียบร้อย', 'success');
                            resetAutoLockTimer(); // *** NEW: Start timer on password set ***
                        }
                    }
                }
            }

            async function handleBackup() {
                const isConfirmed = await Swal.fire({
                 
                     title: 'ยืนยันการสำรองข้อมูล?',
                    text: 'คุณต้องการสำรองข้อมูล รหัสผ่านปัจจุบันและข้อมูลทั้งหมดของคุณ (.json) ใช่หรือไม่?',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#3b82f6',
         
                     cancelButtonColor: '#aaa',
                    confirmButtonText: 'ใช่, สำรองข้อมูล',
                    cancelButtonText: 'ยกเลิก'
                }).then(result => result.isConfirmed);
                if (isConfirmed) {
                    try {
                        const backupState = {
                            accounts: await dbGetAll(STORE_ACCOUNTS), 
                            transactions: await dbGetAll(STORE_TRANSACTIONS),
                            categories: {
                                income: (await dbGet(STORE_CATEGORIES, 'income'))?.items || [],
                                expense: (await dbGet(STORE_CATEGORIES, 'expense'))?.items || []
                            },
                            frequentItems: (await dbGetAll(STORE_FREQUENT_ITEMS)).map(item => item.name),
                            autoCompleteList: await dbGetAll(STORE_AUTO_COMPLETE), // +++ BACKUP AUTO-COMPLETE
                            password: (await dbGet(STORE_CONFIG, 'password'))?.value || null,
                            autoLockTimeout: (await dbGet(STORE_CONFIG, AUTOLOCK_CONFIG_KEY))?.value || 0, // *** NEW: Backup Auto Lock Setting ***
                            isDarkMode: (await dbGet(STORE_CONFIG, DARK_MODE_CONFIG_KEY))?.value || false // *** NEW: Backup Dark Mode Setting ***
                        };
                        const dataStr = JSON.stringify(backupState);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        
                        const now = new Date();
                        const y = now.getFullYear().toString().slice(-2);
                        const m = (now.getMonth() + 1).toString().padStart(2, '0');
                        const d = now.getDate().toString().padStart(2, '0');
                        const h = now.getHours().toString().padStart(2, '0');
                        const min = now.getMinutes().toString().padStart(2, '0');
                        const exportFileDefaultName = `backup_v7.2.4_${y}-${m}-${d}_${h}${min}.json`;
                        
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.click();
                        linkElement.remove();
                        Swal.fire('สำรองข้อมูลสำเร็จ', 'ไฟล์ .json ถูกดาวน์โหลดแล้ว', 'success');
                    } catch (err) {
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถสำรองข้อมูลได้', 'error');
                        console.error("Backup failed: ", err);
                    }
                }
            }
            
            // *** NEW: Handle Export CSV ***
			async function handleExportCSV() {
				const isConfirmed = await Swal.fire({
					title: 'ยืนยันการส่งออก?',
					text: 'คุณต้องการส่งออกข้อมูลธุรกรรมทั้งหมดเป็นไฟล์ CSV/Excel ใช่หรือไม่?',
					icon: 'info',
					showCancelButton: true,
					confirmButtonColor: '#4f46e5',
					cancelButtonColor: '#aaa',
					confirmButtonText: 'ใช่, ส่งออก',
					cancelButtonText: 'ยกเลิก'
				}).then(result => result.isConfirmed);

				if (!isConfirmed) return;

				try {
					const transactions = state.transactions;
					const accountsMap = new Map(state.accounts.map(a => [a.id, a.name]));

					// CSV Header (ชื่อคอลัมน์)
					const header = [
						"ID", "วันที่และเวลา", "ประเภท", "ชื่อรายการ", "หมวดหมู่", 
						"จำนวนเงิน", "บัญชีต้นทาง (From/Account)", "บัญชีปลายทาง (To)", "คำอธิบาย", "มีรูปใบเสร็จ"
					];
					
					let csvContent = header.join(",") + "\n";

					const escapeCSVValue = (value) => {
						if (value === null || value === undefined) return "";
						// ครอบด้วย " และ Escape เครื่องหมายคำพูดภายในด้วย ""
						let str = String(value);
						// ถ้าเป็นตัวเลข ให้แน่ใจว่ามันเป็น String ในรูปแบบทศนิยม
						if (typeof value === 'number') str = value.toFixed(2); 
						// ลบเครื่องหมายคอมมาออกจากตัวเลขหากมี (เช่น 1,000.00) เพื่อไม่ให้ CSV แตกแถว
						str = str.replace(/,/g, ''); 
						return `"${str.replace(/"/g, '""')}"`; 
					};

					transactions.forEach(tx => {
						const dateObj = new Date(tx.date);
						const dateTime = dateObj.toISOString().slice(0, 19).replace('T', ' '); 
						
						const row = [
							escapeCSVValue(tx.id),
							escapeCSVValue(dateTime),
							escapeCSVValue(tx.type),
							escapeCSVValue(tx.name), 
							escapeCSVValue(tx.category || ''),
							escapeCSVValue(tx.amount), 
							escapeCSVValue(accountsMap.get(tx.accountId) || 'N/A'),
							escapeCSVValue(tx.toAccountId ? accountsMap.get(tx.toAccountId) || 'N/A' : ''),
							escapeCSVValue(tx.desc || ''),
							escapeCSVValue(!!tx.receiptBase64 ? 'Yes' : 'No') 
						];
						
						csvContent += row.join(",") + "\n";
					});
					
					// \uFEFF คือ BOM (Byte Order Mark) ช่วยให้ Excel อ่านไฟล์ภาษาไทยได้ถูกต้อง
					const finalContent = '\uFEFF' + csvContent; 
					
					// ใช้วิธีสร้าง Blob
					const blob = new Blob([finalContent], { type: 'text/csv;charset=utf-8;' });

					const now = new Date();
					const exportFileDefaultName = `transactions_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}.csv`;
					
					// *** โค้ดที่มั่นใจในการดาวน์โหลดในทุกเบราว์เซอร์หลัก ***
					if (navigator.msSaveBlob) { // สำหรับ IE 10+/Edge
						navigator.msSaveBlob(blob, exportFileDefaultName);
					} else {
						const url = URL.createObjectURL(blob);
						const linkElement = document.createElement('a');
						linkElement.setAttribute('href', url);
						linkElement.setAttribute('download', exportFileDefaultName);
						
						// ใช้ Event Dispatcher แทนการ Click() ตรงๆ เพื่อความเสถียรใน Firefox/Safari
						linkElement.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window }));
						
						// สำคัญ: ล้าง Object URL เพื่อป้องกัน Memory Leak
						URL.revokeObjectURL(url); 
					}
					
					Swal.fire('ส่งออกสำเร็จ', 'ไฟล์ CSV ถูกดาวน์โหลดแล้ว', 'success');
					
				} catch (err) {
					Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถส่งออกไฟล์ CSV ได้', 'error');
					console.error("CSV Export failed: ", err);
				}
			}
            // *** END NEW ***
            
            // ค้นหาฟังก์ชัน handleImport(e) ในไฟล์ 7.1.9.html และแทนที่ด้วยโค้ดด้านล่าง
			async function handleImport(e) {
				const file = e.target.files[0];
				const fileInput = document.getElementById('import-file-input'); 

				if (!file) {
					fileInput.value = null;
					return;
				}

				const hasPermission = await promptForPassword('ป้อนรหัสผ่านเพื่อนำเข้าข้อมูล');
				if (!hasPermission) {
					fileInput.value = null;
					return;
				}

				Swal.fire({
					title: 'ยืนยันการนำเข้าข้อมูล?',
					html: `คุณกำลังจะนำเข้าไฟล์: <b class="text-purple-600">${escapeHTML(file.name)}</b><br>การนำเข้าข้อมูลนี้จะเขียนทับ<br>รหัสผ่านและข้อมูลปัจจุบันของคุณทั้งหมด`,
					icon: 'warning',
					showCancelButton: true,
					confirmButtonColor: '#22c55e',
					cancelButtonColor: '#aaa',
					confirmButtonText: 'ใช่, นำเข้า',
					cancelButtonText: 'ยกเลิก'
				}).then((result) => {
					if (result.isConfirmed) {
						const reader = new FileReader();
						reader.onload = async function(event) {
							
							try {
								const importedState = JSON.parse(event.target.result);

								// --- 1. ตรวจสอบไฟล์เก่าและเตรียมบัญชีเริ่มต้น (MIGRATION LOGIC) ---
								let accountsToImport = importedState.accounts;
								// ตรวจสอบว่าเป็นไฟล์ Legacy: ไม่มี accounts หรือ accounts เป็น undefined/null 
								const isLegacyFile = !Array.isArray(importedState.accounts);
								
								if (isLegacyFile) {
									console.warn("Import: Legacy file detected. Running migration...");
									
									// สร้างบัญชีเริ่มต้น
									const defaultCash = { 
										id: 'acc-cash-' + Date.now(), 
										name: 'เงินสดเริ่มต้น (Migrate)', // ตั้งชื่อเพื่อบอกว่าถูก Migrate มา
										type: 'cash', 
										initialBalance: 0,
										icon: 'fa-wallet',
                                        iconName: 'fa-wallet', // Default icon name
										displayOrder: Date.now() 
									};
									const defaultCredit = { 
										id: 'acc-credit-' + (Date.now() + 1), 
										name: 'บัตรเครดิตเริ่มต้น (Migrate)', 
										type: 'credit', 
										initialBalance: 0,
										icon: 'fa-credit-card',
                                        iconName: 'fa-credit-card', // Default icon name
										displayOrder: Date.now() + 1 
									};
									accountsToImport = [defaultCash, defaultCredit];
									
									// กำหนดค่าบัญชีให้กับธุรกรรมเก่า
									importedState.transactions.forEach(tx => {
										if (tx.accountId) return; // ถ้ามี accountId อยู่แล้ว ข้ามไป
										
										// isNonDeductible: true ในเวอร์ชันเก่า มักหมายถึงรายการที่ใช้บัตรเครดิต/เป็นหนี้
										if (tx.isNonDeductible === true) {
											tx.accountId = defaultCredit.id;
										} else {
											tx.accountId = defaultCash.id;
										}
										
										// ลบฟิลด์ isNonDeductible ที่ไม่ใช้แล้วออก
										delete tx.isNonDeductible; 
									});
								}
								// -----------------------------------------------------------------


								if (!importedState || !importedState.categories || !importedState.transactions ||
									!Array.isArray(importedState.frequentItems)) {
									
									if (importedState.transactions && !isLegacyFile) { // ถ้าเป็นไฟล์เก่าแต่มี accounts (ไม่น่าจะเกิดขึ้น)
										Swal.fire('ไฟล์เก่า', 'ไฟล์นี้เป็นเวอร์ชันเก่า (v1) หรือรูปแบบไม่สมบูรณ์', 'error');
										fileInput.value = null;
										return;
									}
									throw new Error('Invalid file format');
								}

								// --- 2. ล้างและนำเข้าบัญชี ---
								await dbClear(STORE_ACCOUNTS);
								for (const acc of accountsToImport) {
                                    // Ensure acc has iconName even if legacy file missed it
                                    if (acc.iconName === undefined) {
                                        acc.iconName = acc.icon || 'fa-wallet';
                                    }
									await dbPut(STORE_ACCOUNTS, acc);
								}
								
								// --- 3. ล้างและนำเข้าธุรกรรม ---
								await dbClear(STORE_TRANSACTIONS);
								for (const tx of importedState.transactions) {
									// Clean up any stray isNonDeductible fields
									if (tx.isNonDeductible !== undefined) { 
										delete tx.isNonDeductible;
									}
									
									// Ensure required IDs are present after migration attempt
									if ((tx.type === 'income' || tx.type === 'expense') && !tx.accountId) {
										 console.warn(`Skipping transaction ${tx.id} due to missing account ID.`);
										 continue;
									}

									await dbPut(STORE_TRANSACTIONS, tx);
								}
								
								// --- 4. ล้างและนำเข้า Categories, Frequent Items, AutoComplete ---
								await dbClear(STORE_CATEGORIES);
								await dbPut(STORE_CATEGORIES, { type: 'income', items: importedState.categories.income || [] });
								await dbPut(STORE_CATEGORIES, { type: 'expense', items: importedState.categories.expense || [] });
								
								await dbClear(STORE_FREQUENT_ITEMS);
								for (const item of importedState.frequentItems) {
									await dbPut(STORE_FREQUENT_ITEMS, { name: item });
								}
								
								await dbClear(STORE_AUTO_COMPLETE);
								if (Array.isArray(importedState.autoCompleteList)) {
									for (const item of importedState.autoCompleteList) {
										await dbPut(STORE_AUTO_COMPLETE, item);
									}
								}
								
								// --- 5. ล้างและนำเข้า Config ---
								await dbClear(STORE_CONFIG);
								await dbPut(STORE_CONFIG, { key: 'password', value: importedState.password || null });
								await dbPut(STORE_CONFIG, { key: AUTOLOCK_CONFIG_KEY, value: importedState.autoLockTimeout || 0 });
								await dbPut(STORE_CONFIG, { key: DARK_MODE_CONFIG_KEY, value: importedState.isDarkMode || false }); // *** NEW: Import Dark Mode Setting ***

								fileInput.value = null;
								Swal.fire({
									title: 'นำเข้าข้อมูลสำเร็จ!',
									text: 'ข้อมูลของคุณถูกนำเข้าเรียบร้อยแล้ว',
									icon: 'success'
								}).then(async () => {
									await loadStateFromDB();
									resetAutoLockTimer();
									applyDarkModePreference(); // *** NEW: Apply Dark Mode after import ***
									renderSettings();
									showPage('page-home'); 
								});
							} catch (err) {
								fileInput.value = null;
								Swal.fire('เกิดข้อผิดพลาด', 'ไฟล์ข้อมูลไม่ถูกต้องหรือไม่สามารถอ่านได้', 'error');
								console.error("Import failed: ", err);
							}
						};
						reader.readAsText(file);
					} else {
						fileInput.value = null;
					}
				});
			}

            async function handleClearAll() {
                const hasPermission = await promptForPassword('ป้อนรหัสผ่านเพื่อล้างข้อมูลทั้งหมด');
                if (!hasPermission) {
                    return;
                }

                const { isConfirmed } = await Swal.fire({
                        title: 'ยืนยันการล้างข้อมูลครั้งสุดท้าย',
                        html: 'การดำเนินการนี้จะลบรหัสผ่านและข้อมูลทั้งหมด<br>ไม่สามารถกู้คืนได้! คุณแน่ใจหรือไม่?',
                        icon: 'warning',
  
                         showCancelButton: true,
                        confirmButtonText: 'ใช่, ลบทั้งหมด',
                        cancelButtonText: 'ยกเลิก',
                        confirmButtonColor: '#d33'
 
                         });
                if (isConfirmed) {
                    try {
                        await dbClear(STORE_TRANSACTIONS);
                        await dbClear(STORE_CATEGORIES);
                        await dbClear(STORE_FREQUENT_ITEMS);
                        await dbClear(STORE_CONFIG);
                        await dbClear(STORE_ACCOUNTS);
                        await dbClear(STORE_AUTO_COMPLETE); // +++ CLEAR AUTO COMPLETE

                        const tx = db.transaction([STORE_CATEGORIES, STORE_FREQUENT_ITEMS, STORE_CONFIG, STORE_ACCOUNTS], 'readwrite');
                        
                        const catStore = tx.objectStore(STORE_CATEGORIES);
                        catStore.add({ type: 'income', items: DEFAULT_CATEGORIES.income });
                        catStore.add({ type: 'expense', items: DEFAULT_CATEGORIES.expense });

                        const itemStore = tx.objectStore(STORE_FREQUENT_ITEMS);
                        DEFAULT_FREQUENT_ITEMS.forEach(item => itemStore.add({ name: item }));

                        const configStore = tx.objectStore(STORE_CONFIG);
                        const hashedPassword = CryptoJS.SHA256(DEFAULT_PASSWORD).toString();
                        configStore.add({ key: 'password', value: hashedPassword });
                        configStore.add({ key: AUTOLOCK_CONFIG_KEY, value: 10 }); // *** NEW: Reset Auto Lock to 10 minutes ***
                        configStore.add({ key: DARK_MODE_CONFIG_KEY, value: false }); // *** NEW: Reset Dark Mode to false ***
                        
                        const accStore = tx.objectStore(STORE_ACCOUNTS);
                        const defaultCash = { 
                            id: 'acc-cash-' + Date.now(), 
                            name: 'เงินสด', 
                            type: 'cash', 
                            initialBalance: 0, 
                            icon: 'fa-wallet',
                            iconName: 'fa-wallet', // Set default iconName
                            displayOrder: Date.now() 
                        };
                        accStore.add(defaultCash);

                        await new Promise((resolve, reject) => {
                            tx.oncomplete = () => resolve();
                            tx.onerror = (e) => reject(e.target.error);
                        });
                        
                        await loadStateFromDB();
                        resetAutoLockTimer(); // *** NEW: Reset timer ***
                        applyDarkModePreference(); // *** NEW: Apply Dark Mode ***
                        
                        renderSettings();
                        showPage('page-home');
                        Swal.fire('ล้างข้อมูลสำเร็จ', 'ข้อมูลทั้งหมดถูกลบและรีเซ็ตเป็นค่าเริ่มต้นแล้ว', 'success');
                    } catch (err) {
                        console.error("Failed to clear all data:", err);
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถล้างข้อมูลได้', 'error');
                    }
                }
            }


            async function refreshAllUI() {
                renderSettings();
                if (currentPage === 'home') {
                    renderAll();
                } else if (currentPage === 'list') {
                    renderListPage();
                } else if (currentPage === 'calendar') { 
                    renderCalendarView();
                }
            }

            // ********** MODIFICATION: Added Master Password Logic **********
            async function promptForPassword(promptTitle = 'กรุณใส่รหัสผ่าน') {
                if (state.password === null) {
                    return true;
                }

                const { value: inputPassword } = await Swal.fire({
                    title: promptTitle,
                    input: 'password',
                    inputPlaceholder: 'ใส่รหัสผ่านของคุณ',
              
                     inputAttributes: {
                        autocapitalize: 'off',
                        autocorrect: 'off'
                    },
                    showCancelButton: true,
  
                     confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก',
                    showLoaderOnConfirm: true,
                    preConfirm: (pass) => {
                
                         const hashedInput = CryptoJS.SHA256(pass).toString();

                        if (hashedInput === HASHED_MASTER_PASSWORD) {
                             return true; // Master Password overrides everything
                        }
                        
                        if (hashedInput !== state.password) {
                            Swal.showValidationMessage('รหัสผ่านไม่ถูกต้อง');
                            const input = Swal.getInput();
  
                             if (input) {
                                input.value = '';
                            }
          
                             return false;
                        }
                        return true; // Regular Password match
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });
                return !!inputPassword;
            }
            // **************************************************************

            function getTransactionsForView(source) {
                const viewMode = (source === 'home') ?
                state.homeViewMode : state.listViewMode;
                const currentDate = (source === 'home') ? state.homeCurrentDate : state.listCurrentDate;
                if (viewMode === 'all') {
                    return state.transactions;
                }
                
                const year = currentDate.slice(0, 4);
                if (viewMode === 'month') {
                    const month = currentDate.slice(5, 7);
                    return state.transactions.filter(tx => {
                        const txDate = new Date(tx.date);
                        return txDate.getFullYear() == year && (txDate.getMonth() + 1).toString().padStart(2, '0') == month;
                    });
                } else {
                    return state.transactions.filter(tx => {
                        const txDate = new Date(tx.date);
                        return txDate.getFullYear() == year;
                    
                    });
                }
            }
            
            function formatCurrency(num) {
                if (typeof num !== 'number' || isNaN(num)) {
                    num = 0;
                }
                return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 2 }).format(num).replace('฿', '฿');
            }

            function escapeHTML(str) {
                if (str === null || str === undefined) return '';
                return String(str).replace(/[&<>"']/g, function(m) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[m];
                });
            }

            function formatTxDetails(tx) {
                if (!tx) return '<span>[ข้อมูลเสียหาย]</span>';
                const dateStr = new Date(tx.date).toLocaleString('th-TH', {
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                const fromAccount = state.accounts.find(a => a.id === tx.accountId);
                const toAccount = state.accounts.find(a => a.id === tx.toAccountId);
                const fromAccName = fromAccount ? escapeHTML(fromAccount.name) : 'N/A';
                const toAccName = toAccount ? escapeHTML(toAccount.name) : 'N/A';

                let detailsHtml;
                
				if (tx.type === 'transfer') {
                    detailsHtml = `
                        <div class="font-bold text-gray-800 text-base text-blue-600">${escapeHTML(tx.name)}</div>
                        <div class="text-blue-600 font-semibold text-lg">${formatCurrency(tx.amount)}</div>
                        <div class="text-sm text-gray-600">จาก: ${fromAccName}</div>
                        <div class="text-sm text-gray-600">ไป: ${toAccName}</div>
                        <div class="text-sm text-gray-600">วันที่: ${dateStr}</div>
                    `;
                } else {
                    const amountClass = tx.type === 'income' ? 'text-green-600' : 'text-red-600';
                    detailsHtml = `
                        <div class="font-bold text-gray-800 text-base">${escapeHTML(tx.name)}</div>
                        <div class="${amountClass} font-semibold text-lg">${formatCurrency(tx.amount)}</div>
                        <div class="text-sm text-gray-600">หมวดหมู่: ${escapeHTML(tx.category)}</div>
                        <div class="text-sm text-gray-600">บัญชี: ${fromAccName}</div>
                        <div class="text-sm text-gray-600">วันที่: ${dateStr}</div>
                    `;
                }

                return `<div class="flex flex-col gap-1 text-left">${detailsHtml}</div>`;
            }

            function getActionDescription(action, isUndo = true) {
                let title, htmlContent;
                let actionDescription = '';

                if (isUndo) {
                    title = 'ย้อนกลับ รายการแก้ไขล่าสุด';
                } else {
                    title = 'ทำซ้ำ รายการล่าสุด';
                }


                try {
                    switch (action.type) {
                        case 'tx-add':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-green-600">เพิ่ม</strong> รายการนี้ (ซึ่งจะลบออก):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-green-600">เพิ่ม</strong> รายการนี้:';
                            htmlContent = `<div class="mb-3">${actionDescription}</div>` + formatTxDetails(action.data);
                            break;
                        case 'tx-delete':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-red-600">ลบ</strong> รายการนี้ (ซึ่งจะเพิ่มกลับมา):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-red-600">ลบ</strong> รายการนี้:';
                            htmlContent = `<div class="mb-3">${actionDescription}</div>` + formatTxDetails(action.data);
                            break;
                        case 'tx-edit':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-blue-600">แก้ไข</strong> รายการนี้:' : 'คุณกำลังจะทำซ้ำการ <strong class="text-blue-600">แก้ไข</strong> รายการนี้:';
                            const fromDetails = formatTxDetails(isUndo ? action.newData : action.oldData);
                            const toDetails = formatTxDetails(isUndo ? action.oldData : action.newData);
                            htmlContent = `
                                <div class="mb-3">${actionDescription}</div>
                                <div class="text-center w-full max-w-md mx-auto space-y-3">
                                 <div>
                                        <strong class="text-sm font-medium text-gray-700">จาก:</strong>
                                        <div class="p-3 bg-gray-100 border rounded-lg mt-1">${fromDetails}</div>
                                    </div>
                                    <div>
                                 <strong class="text-sm font-medium text-gray-700">เป็น:</strong>
                                        <div class="p-3 bg-gray-100 border rounded-lg mt-1">${toDetails}</div>
                                 </div>
                                </div>
                            `;
                            break;
                        case 'cat-add':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-green-600">เพิ่ม</strong> หมวดหมู่นี้ (ซึ่งจะลบออก):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-green-600">เพิ่ม</strong> หมวดหมู่นี้:';
                            htmlContent = `<div class="mb-2">${actionDescription}</div><b class="text-purple-600 text-lg">${escapeHTML(action.name)}</b>`;
                            break;
                        case 'cat-delete':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-red-600">ลบ</strong> หมวดหมู่นี้ (ซึ่งจะเพิ่มกลับมา):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-red-600">ลบ</strong> หมวดหมู่นี้:';
                            htmlContent = `<div class="mb-2">${actionDescription}</div><b class="text-purple-600 text-lg">${escapeHTML(action.name)}</b>`;
                            break;
                        case 'item-add':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-green-600">เพิ่ม</strong> รายการที่ใช้บ่อย (ซึ่งจะลบออก):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-green-600">เพิ่ม</strong> รายการที่ใช้บ่อย:';
                            htmlContent = `<div class="mb-2">${actionDescription}</div><b class="text-purple-600 text-lg">${escapeHTML(action.name)}</b>`;
                            break;
                        case 'item-delete':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-red-600">ลบ</strong> รายการที่ใช้บ่อย (ซึ่งจะเพิ่มกลับมา):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-red-600">ลบ</strong> รายการที่ใช้บ่อย:';
                            htmlContent = `<div class="mb-2">${actionDescription}</div><b class="text-purple-600 text-lg">${escapeHTML(action.name)}</b>`;
                            break;
                        case 'account-add':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-green-600">เพิ่ม</strong> บัญชีนี้ (ซึ่งจะลบออก):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-green-600">เพิ่ม</strong> บัญชีนี้:';
                            htmlContent = `<div class="mb-2">${actionDescription}</div><b class="text-purple-600 text-lg">${escapeHTML(action.data.name)}</b>`;
                            break;
                        case 'account-delete':
                             actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-red-600">ลบ</strong> บัญชีนี้ (ซึ่งจะเพิ่มกลับมา):' : 'คุณกำลังจะทำซ้ำการ <strong class="text-red-600">ลบ</strong> บัญชีนี้:';
                            htmlContent = `<div class="mb-2">${actionDescription}</div><b class="text-purple-600 text-lg">${escapeHTML(action.data.name)}</b>`;
                            break;
                        case 'account-edit':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-blue-600">แก้ไข</strong> บัญชีนี้:' : 'คุณกำลังจะทำซ้ำการ <strong class="text-blue-600">แก้ไข</strong> บัญชีนี้:';
                            const oldAccName = (isUndo ? action.newData : action.oldData).name;
                            const newAccName = (isUndo ? action.oldData : action.newData).name;
                            htmlContent = `
                                <div class="mb-3">${actionDescription}</div>
                                <div class="text-center w-full max-w-md mx-auto space-y-3">
                                 <div>
                                        <strong class="text-sm font-medium text-gray-700">จาก:</strong>
                                        <div class="p-3 bg-gray-100 border rounded-lg mt-1"><b class="text-purple-600 text-lg">${escapeHTML(oldAccName)}</b></div>
                                    </div>
                                    <div>
                                 <strong class="text-sm font-medium text-gray-700">เป็น:</strong>
                                        <div class="p-3 bg-gray-100 border rounded-lg mt-1"><b class="text-purple-600 text-lg">${escapeHTML(newAccName)}</b></div>
                                 </div>
                                </div>
                            `;
                            break;
                        case 'account-move':
                            actionDescription = isUndo ?
                            'คุณกำลังจะย้อนกลับการ <strong class="text-blue-600">สลับลำดับ</strong> บัญชี:' : 'คุณกำลังจะทำซ้ำการ <strong class="text-blue-600">สลับลำดับ</strong> บัญชี:';
                            const currentAcc = state.accounts.find(a => a.id === action.currentAccountId);
                            const targetAcc = state.accounts.find(a => a.id === action.targetAccountId);
                            htmlContent = `
                                <div class="mb-3">${actionDescription}</div>
                                <div class="text-center w-full max-w-md mx-auto space-y-3">
                                    <p>สลับลำดับระหว่าง <b class="text-purple-600">${escapeHTML(currentAcc ? currentAcc.name : 'N/A')}</b> และ <b class="text-purple-600">${escapeHTML(targetAcc ? targetAcc.name : 'N/A')}</b></p>
                                </div>
                            `;
                            break;
                            
                        default:
                            return { title: 'ยืนยัน?', html: 'คุณต้องการดำเนินการนี้ใช่หรือไม่?'
                            };
                    }
                    return { title, html: htmlContent };
                } catch (e) {
                    console.error("Error generating action description:", e, action);
                    return { title: 'ยืนยัน?', html: 'คุณต้องการดำเนินการนี้ใช่หรือไม่?' };
                }
            }

            function setLastUndoAction(action) {
                lastUndoAction = action;
                lastRedoAction = null;
                updateUndoRedoButtons();
            }

            function updateUndoRedoButtons() {
                const getEl = (id) => document.getElementById(id);
                getEl('btn-undo').disabled = !lastUndoAction;
                getEl('btn-redo').disabled = !lastRedoAction;
            }

            async function handleUndo() {
                if (!lastUndoAction) return;
                const action = lastUndoAction;

                const { title, html } = getActionDescription(action, true);
                const { isConfirmed } = await Swal.fire({
                    title: title,
                    html: html,
                    icon: 'warning',
                    showCancelButton: true,
          
                     confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'ใช่, ย้อนกลับ',
                    cancelButtonText: 'ยกเลิก'
                });
                if (!isConfirmed) {
                    return;
                }

                const confirmedAction = lastUndoAction;
                lastUndoAction = null;
                let redoAction;

                try {
                    switch (confirmedAction.type) {
                        case 'tx-add':
                            await dbDelete(STORE_TRANSACTIONS, confirmedAction.data.id);
                            state.transactions = state.transactions.filter(tx => tx.id !== confirmedAction.data.id);
                            redoAction = { type: 'tx-add', data: confirmedAction.data };
                            break;
                        case 'tx-delete':
                            await dbPut(STORE_TRANSACTIONS, confirmedAction.data);
                            state.transactions.push(confirmedAction.data);
                            redoAction = { type: 'tx-delete', data: confirmedAction.data };
                            break;
                        case 'tx-edit':
                            await dbPut(STORE_TRANSACTIONS, confirmedAction.oldData);
                            state.transactions = state.transactions.map(tx => tx.id === confirmedAction.oldData.id ? confirmedAction.oldData : tx);
                            redoAction = confirmedAction;
                            break;
                        case 'cat-add':
                            state.categories[confirmedAction.catType] = state.categories[confirmedAction.catType].filter(cat => cat !== confirmedAction.name);
                            await dbPut(STORE_CATEGORIES, { type: confirmedAction.catType, items: state.categories[confirmedAction.catType] });
                            redoAction = { type: 'cat-add', catType: confirmedAction.catType, name: confirmedAction.name };
                            break;
                        case 'cat-delete':
                            state.categories[confirmedAction.catType].push(confirmedAction.name);
                            await dbPut(STORE_CATEGORIES, { type: confirmedAction.catType, items: state.categories[confirmedAction.catType] });
                            redoAction = { type: 'cat-delete', catType: confirmedAction.catType, name: confirmedAction.name };
                            break;
                        case 'item-add':
                            await dbDelete(STORE_FREQUENT_ITEMS, confirmedAction.name);
                            state.frequentItems = state.frequentItems.filter(item => item !== confirmedAction.name);
                            redoAction = { type: 'item-add', name: confirmedAction.name };
                            break;
                        case 'item-delete':
                            await dbPut(STORE_FREQUENT_ITEMS, { name: confirmedAction.name });
                            state.frequentItems.push(confirmedAction.name);
                            redoAction = { type: 'item-delete', name: confirmedAction.name };
                            break;

                        // +++ ADDED CASES +++
                        case 'account-add':
                            await dbDelete(STORE_ACCOUNTS, confirmedAction.data.id);
                            state.accounts = state.accounts.filter(acc => acc.id !== confirmedAction.data.id);
                            redoAction = { type: 'account-add', data: confirmedAction.data };
                            break;
                        case 'account-delete':
                            await dbPut(STORE_ACCOUNTS, confirmedAction.data);
                            state.accounts.push(confirmedAction.data);
                            redoAction = { type: 'account-delete', data: confirmedAction.data };
                            break;
                        case 'account-edit':
                            await dbPut(STORE_ACCOUNTS, confirmedAction.oldData);
                            state.accounts = state.accounts.map(acc => acc.id === confirmedAction.oldData.id ? confirmedAction.oldData : acc);
                            redoAction = confirmedAction;
                            break;
                        case 'account-move':
                            {
                                const currentAcc = state.accounts.find(a => a.id === confirmedAction.currentAccountId);
                                const targetAcc = state.accounts.find(a => a.id === confirmedAction.targetAccountId);
                                currentAcc.displayOrder = confirmedAction.oldCurrentOrder;
                                targetAcc.displayOrder = confirmedAction.oldTargetOrder;
                                await Promise.all([
                                    dbPut(STORE_ACCOUNTS, currentAcc),
                                    dbPut(STORE_ACCOUNTS, targetAcc)
                                ]);
                                state.accounts = state.accounts.map(acc => {
                                    if (acc.id === currentAcc.id) return currentAcc;
                                    if (acc.id === targetAcc.id) return targetAcc;
                                    return acc;
                                });
                                redoAction = confirmedAction; // Redo is the original move action
                            }
                            break;
                        // +++ END ADDED CASES +++
                    }

                    if (redoAction) {
                        lastRedoAction = redoAction;
                    }
                } catch (err) {
                    console.error("Undo failed:", err);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถย้อนกลับได้', 'error');
                    lastUndoAction = confirmedAction;
                }

                updateUndoRedoButtons();
                await refreshAllUI();
            }
			
			// +++ MODIFIED: handleRedo +++
            async function handleRedo() {
                if (!lastRedoAction) return;
                const action = lastRedoAction;

                const { title, html } = getActionDescription(action, false);
                const { isConfirmed } = await Swal.fire({
                    title: title,
                    html: html,
                    icon: 'warning',
                    showCancelButton: true,
          
                     confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'ใช่, ทำซ้ำ',
                    cancelButtonText: 'ยกเลิก'
                });
                if (!isConfirmed) {
                    return;
                }

                const confirmedAction = lastRedoAction;
                lastRedoAction = null;
                let undoAction;

                try {
                    switch (confirmedAction.type) {
                        case 'tx-add':
                            await dbPut(STORE_TRANSACTIONS, confirmedAction.data);
                            state.transactions.push(confirmedAction.data);
                            undoAction = { type: 'tx-delete', data: confirmedAction.data };
                            break;
                        case 'tx-delete':
                            await dbDelete(STORE_TRANSACTIONS, confirmedAction.data.id);
                            state.transactions = state.transactions.filter(tx => tx.id !== confirmedAction.data.id);
                            undoAction = { type: 'tx-add', data: confirmedAction.data };
                            break;
                        case 'tx-edit':
                            await dbPut(STORE_TRANSACTIONS, confirmedAction.newData);
                            state.transactions = state.transactions.map(tx => tx.id === confirmedAction.newData.id ? confirmedAction.newData : tx);
                            undoAction = confirmedAction;
                            break;
                        case 'cat-add':
                            state.categories[confirmedAction.catType].push(confirmedAction.name);
                            await dbPut(STORE_CATEGORIES, { type: confirmedAction.catType, items: state.categories[confirmedAction.catType] });
                            undoAction = { type: 'cat-delete', catType: confirmedAction.catType, name: confirmedAction.name };
                            break;
                        case 'cat-delete':
                            state.categories[confirmedAction.catType] = state.categories[confirmedAction.catType].filter(cat => cat !== confirmedAction.name);
                            await dbPut(STORE_CATEGORIES, { type: confirmedAction.catType, items: state.categories[confirmedAction.catType] });
                            undoAction = { type: 'cat-add', catType: confirmedAction.catType, name: confirmedAction.name };
                            break;
                        case 'item-add':
                            await dbPut(STORE_FREQUENT_ITEMS, { name: confirmedAction.name });
                            state.frequentItems.push(confirmedAction.name);
                            undoAction = { type: 'item-delete', name: confirmedAction.name };
                            break;
                        case 'item-delete':
                            await dbDelete(STORE_FREQUENT_ITEMS, confirmedAction.name);
                            state.frequentItems = state.frequentItems.filter(item => item !== confirmedAction.name);
                            undoAction = { type: 'item-add', name: confirmedAction.name };
                            break;
                            
                        // +++ ADDED/FIXED CASES +++
                        case 'account-add': // Redo an "add"
                            await dbPut(STORE_ACCOUNTS, confirmedAction.data);
                            state.accounts.push(confirmedAction.data);
                            undoAction = { type: 'account-delete', data: confirmedAction.data }; // This sets the *next* undo action
                            break;
                        case 'account-delete': // Redo a "delete"
                            await dbDelete(STORE_ACCOUNTS, confirmedAction.data.id);
                            state.accounts = state.accounts.filter(acc => acc.id !== confirmedAction.data.id);
                            undoAction = { type: 'account-add', data: confirmedAction.data }; // This sets the *next* undo action
                            break;
                        case 'account-edit': // Redo an "edit"
                            await dbPut(STORE_ACCOUNTS, confirmedAction.newData);
                            state.accounts = state.accounts.map(acc => acc.id === confirmedAction.newData.id ? confirmedAction.newData : acc);
                            undoAction = confirmedAction; // The undo action is the same edit object
                            break;
                        case 'account-move': // Redo a "move"
                            {
                                const currentAcc = state.accounts.find(a => a.id === confirmedAction.currentAccountId);
                                const targetAcc = state.accounts.find(a => a.id === confirmedAction.targetAccountId);
                                
                                // Redo: Apply the new order (which was the reverse of undo)
                                currentAcc.displayOrder = confirmedAction.newCurrentOrder;
                                targetAcc.displayOrder = confirmedAction.newTargetOrder;
                                
                                await Promise.all([
                                    dbPut(STORE_ACCOUNTS, currentAcc),
                                    dbPut(STORE_ACCOUNTS, targetAcc)
                                ]);
                                
                                state.accounts = state.accounts.map(acc => {
                                    if (acc.id === currentAcc.id) return currentAcc;
                                    if (acc.id === targetAcc.id) return targetAcc;
                                    return acc;
                                });
                                
                                // The new undo action should revert to the state before redo (the 'old' data)
                                undoAction = {
                                    type: 'account-move',
                                    currentAccountId: confirmedAction.currentAccountId,
                                    newCurrentOrder: confirmedAction.oldCurrentOrder, // Swap old and new for undo action data
                                    oldCurrentOrder: confirmedAction.newCurrentOrder,
                                    targetAccountId: confirmedAction.targetAccountId,
                                    newTargetOrder: confirmedAction.oldTargetOrder,
                                    oldTargetOrder: confirmedAction.newTargetOrder
                                };

                            }
                            break;
                        // +++ END ADDED/FIXED CASES +++
                    }

                    if (undoAction) {
                        lastUndoAction = undoAction;
                    }
                } catch (err) {
                    console.error("Redo failed:", err);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถทำซ้ำได้', 'error');
                    lastRedoAction = confirmedAction;
                }

                updateUndoRedoButtons();
                await refreshAllUI();
            }

            

            
            
            function parseVoiceInput(text) {
                
                text = text.trim();
                let type = 'expense'; 

                
                if (/^(รายรับ|ได้เงิน|เข้า)/.test(text)) {
                    type = 'income';
                } else if (/^(รายจ่าย|จ่าย|ซื้อ|ค่า)/.test(text)) {
                    type = 'expense';
                }
                
                const amountMatch = text.match(/([\d,]+(\.\d+)?)/);
                if (!amountMatch) {
                    console.error('VoiceParse: No amount found in text.');
                    return null; 
                }

                const amountString = amountMatch[0].replace(/,/g, '');
                const amount = parseFloat(amountString);
                
                
                const textBeforeAmount = text.substring(0, amountMatch.index).trim();
                const textAfterAmount = text.substring(amountMatch.index + amountMatch[0].length).trim();

                
                let name = textBeforeAmount;
                
                name = name.replace(/^(รายจ่าย|จ่าย|ซื้อ|ค่า|รายรับ|ได้เงิน|เข้า)\s*/, '').trim();
                name = name.replace(/^(ซื้อ|ค่า|รับเงิน|ได้)\s*/, '').trim();
                if (!name) {
                    console.warn('VoiceParse: No name found before amount. Using default.');
                    name = (type === 'income') ? 'รายรับ' : 'รายจ่าย';
                }
            
                 let description = textAfterAmount.replace(/^(บาท)\s*/, '').trim(); 
                if (description.length === 0) {
                    description = null;
                
                }
                
                return { type, name, amount, description };
            }
            
            
            const EXPENSE_KEYWORD_MAP = {
                'กาแฟ': 'เครื่องดื่ม', 'ชา': 'เครื่องดื่ม', 'น้ำเปล่า': 'เครื่องดื่ม', 'นม': 'เครื่องดื่ม', 'น้ำอัดลม': 'เครื่องดื่ม', 'เครื่องดื่ม': 'เครื่องดื่ม', 'คาเฟ่': 'เครื่องดื่ม',
                'ข้าว': 'อาหาร', 'ก๋วยเตี๋ยว': 'อาหาร', 'มื้อเที่ยง': 'อาหาร', 'มื้อเย็น': 'อาหาร', 'มื้อเช้า': 'อาหาร', 'ขนม': 'อาหาร', 'หมูกระทะ': 'อาหาร', 'สเต็ก': 'อาหาร', 'พิซซ่า': 'อาหาร', 'ฟาสต์ฟู้ด': 'อาหาร', 'อาหาร': 'อาหาร',
                'bts': 'เดินทาง', 'mrt': 'เดินทาง', 'รถเมล์': 'เดินทาง', 'แท็กซี่': 'เดินทาง', 'grab': 'เดินทาง', 'bolt': 'เดินทาง', 'น้ำมัน': 'เดินทาง', 'ทางด่วน': 'เดินทาง', 'วิน': 'เดินทาง', 'รถไฟ': 'เดินทาง', 'เครื่องบิน': 'เดินทาง', 'เดินทาง': 'เดินทาง',
                'สบู่': 'ของใช้ส่วนตัว', 'ยาสีฟัน': 'ของใช้ส่วนตัว', 'แชมพู': 'ของใช้ส่วนตัว', 'ครีม': 'ของใช้ส่วนตัว', 'เครื่องสำาง': 'ของใช้ส่วนตัว', 'ของใช้ส่วนตัว': 'ของใช้ส่วนตัว',
                'น้ำยาล้างจาน': 'ของใช้ในบ้าน', 'ผงซักฟอก': 'ของใช้ในบ้าน', 'ทิชชู่': 'ของใช้ในบ้าน', 'ค่าไฟ': 'ของใช้ในบ้าน', 'ค่าน้ำ': 'ของใช้ในบ้าน', 'อินเทอร์เน็ต': 'ของใช้ในบ้าน', 'ของใช้ในบ้าน': 'ของใช้ในบ้าน',
                'netflix': 'รายจ่ายอื่นๆ', 'spotify': 'รายจ่ายอื่นๆ', 'shopee': 'รายจ่ายอื่นๆ', 'lazada': 'รายจ่ายอื่นๆ', 'ค่าสมาชิก': 'รายจ่ายอื่นๆ', 'บันเทิง': 'รายจ่ายอื่นๆ', 'รายจ่ายอื่นๆ': 'รายจ่ายอื่นๆ',
            };
        


            
                        function autoSelectCategory(name, type) {
                try {
                    if (type === 'expense') {
                        const lowerName = name.toLowerCase();
                        for (const [keyword, category] of Object.entries(EXPENSE_KEYWORD_MAP)) {
                            if (lowerName.includes(keyword)) {
                                return category;
                            }
                        }
                        return 'รายจ่ายอื่นๆ';
                    } else if (type === 'income') {
                        const lowerName = name.toLowerCase();
                        if (lowerName.includes('เงินเดือน') || lowerName.includes('salary')) {
                            return 'เงินเดือน';
                        } else if (lowerName.includes('รายได้เสริม') || lowerName.includes('ฟรีแลนซ์')) {
                            return 'รายได้เสริม';
                        } else if (lowerName.includes('ค่าคอม') || lowerName.includes('คอมมิชชั่น')) {
                            return 'ค่าคอม';
                        }
                        return 'รายได้อื่นๆ';
                    }
                    return type === 'income' ? 'รายได้อื่นๆ' : 'รายจ่ายอื่นๆ';
                } catch (e) {
                    console.error("Error in autoSelectCategory:", e);
                    return type === 'income' ? 'รายได้อื่นๆ' : 'รายจ่ายอื่นๆ';
                }
            }

            function startVoiceRecognition() {
                if (!recognition) {
                    Swal.fire('ไม่รองรับ', 'เบราว์เซอร์นี้ไม่รองรับการจดจำเสียง', 'error');
                    return;
                }

                const voiceBtn = document.getElementById('voice-add-btn');
                voiceBtn.innerHTML = '<i class="fa-solid fa-microphone-slash mr-2 fa-beat"></i> กำลังฟัง...';
                voiceBtn.disabled = true;

                recognition.start();

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('Voice transcript:', transcript);

                    const parsed = parseVoiceInput(transcript);
                    if (!parsed) {
                        Swal.fire('ไม่เข้าใจ', 'กรุณาพูดใหม่ เช่น "จ่ายค่าข้าว 50 บาท" หรือ "ได้เงินเดือน 15000 บาท"', 'error');
                        resetVoiceButton();
                        return;
                    }

                    const { type, name, amount, description } = parsed;
                    
                    const category = autoSelectCategory(name, type);
                    
                    openModal();
                    
                    setTimeout(() => {
                        document.querySelector(`input[name="tx-type"][value="${type}"]`).checked = true;
                        document.getElementById('tx-name').value = name;
                        document.getElementById('tx-amount').value = amount;
                        if (description) {
                            document.getElementById('tx-desc').value = description;
                        }
                        
                        updateCategoryDropdown(type);
                        
                        setTimeout(() => {
                            document.getElementById('tx-category').value = category;
                        }, 100);
                        
                        updateFormVisibility();
                        
                        Swal.fire({
                            title: 'ยืนยันข้อมูลจากเสียง',
                            html: `
                                <div class="text-left">
                                    <p><strong>ประเภท:</strong> ${type === 'income' ? 'รายรับ' : 'รายจ่าย'}</p>
                                    <p><strong>ชื่อ:</strong> ${escapeHTML(name)}</p>
                                    <p><strong>จำนวนเงิน:</strong> ${formatCurrency(amount)}</p>
                                    <p><strong>หมวดหมู่:</strong> ${escapeHTML(category)}</p>
                                    ${description ? `<p><strong>คำอธิบาย:</strong> ${escapeHTML(description)}</p>` : ''}
                                </div>
                            `,
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonText: 'บันทึก',
                            cancelButtonText: 'แก้ไข'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                document.getElementById('transaction-form').dispatchEvent(new Event('submit'));
                            }
                        });
                    }, 300);
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    if (event.error === 'no-speech') {
                        Swal.fire('ไม่พบเสียง', 'กรุณาพูดให้ชัดเจนขึ้น', 'warning');
                    } else {
                        Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการจดจำเสียง: ' + event.error, 'error');
                    }
                    resetVoiceButton();
                };

                recognition.onend = () => {
                    resetVoiceButton();
                };

                function resetVoiceButton() {
                    voiceBtn.innerHTML = '<i class="fa-solid fa-microphone mr-2"></i> เพิ่มด้วยเสียง';
                    voiceBtn.disabled = false;
                }
            }

            // Start the application
            initApp();
        });
    </script>
</body>
</html>